# (一) 修改基础属性
## 一、基础属性
##### 1. 搜索
首先使用搜索功能在 `kr/game_templates` 任意找到一个英雄模板

模板定义见 [[1.1 - 模板]]
模板名见 [[总结/1 - 模板|1 - 模板]]

##### 2. 介绍
如图以小公主为例：
![[Pasted image 20250626164940.png|800]]
`tt` 指的是对应英雄，第一个键指来自哪个组件，例如 `tt.hero.hp_max` 指对应英雄的 `hero` 组件的最大血量键

`tt.hero.level_stats` 键的子键都是基础属性：
```lua
tt.hero.level_stats.armor	-- 物理护甲
tt.hero.level_stats.hp_max	-- 最大血量
tt.hero.level_stats.melee / ranged_damage	-- 近战与远程普攻的最大最小伤害
tt.hero.level_stats.regen_health	-- 脱战回血
```

**展开的 10 行数字为行数所对应等级的属性**
```lua
tt.hero.level_stats.hp_max = {
	250,	-- 1 级血量为 250
	270,
	290,
	310,
	330,
	350,
	370,
	390,
	410,
	430		-- 10 级血量为 430
}
```

##### 3. 修改
**将第十行血量修改为 666，然后运行游戏**
![[Pasted image 20250626192149.png|377]]
![[Pasted image 20250626191819.png|541]]
如图血量变为 666 成功

- **若未成功可以检查一下英雄等级是否到 10 级，当然也可以修改其他行只要英雄到达这个等级**
- **还要检查出战的英雄是不是你改的英雄**

##### 4. 五代问题
五代的键值是这样的：
![[Pasted image 20250630133711.png|625]]
通过查看模板的定义知道：基础属性的存储位置在 `balance`
![[Pasted image 20250630134949.png|245]]
如图在 `balance` 搜索要改的英雄，同样可以找到基础属性，修改 `hp_max` 即可

##### Q&A：
- Q：程序是如何知道我们在修改哪个英雄？换句话说 `tt` 指的是什么
- A：因为 `E:register_t` 函数会返回创建的模板的引用，也就是说此时 `tt` 就是 `E.entities.hero_alleria`
除非重新给 `tt` 赋值（比如创建另一个英雄模板，然后 `tt` 就直接指向新模板了，也就是说此后修改的血量等都是修改新模板的）

`E:register_t` 函数见 [[1.1 - 模板#1 创建模板]]

## 二、技能基础属性
下面来看 `skills` 技能的基础属性
![[Pasted image 20250627155614.png|450]]
如图为艾莉丹

假设要修改艾莉丹的四技能；双刀跳斩的伤害：
首先查资料（见 [[总结/1 - 模板|1 - 模板]]）知道：四技能的名称是 `double_strike`
![[Pasted image 20250627185432.png|450]]
**五代还是与基础属性相同在 `balance`**

**3 行数字意义同上**
**例如：修改第三行最大伤害为 233 则双刀跳斩三级时最大伤害为 233 点**

修改后同上运行游戏测试就行，不再赘叙

#### Q&A：
- Q：如果我想修改冷却时间等其他属性，这里怎么没有
- A：因为这里只有一些基础属性，修改方法下面会提到
- Q：有些技能的属性找不到怎么办
- A：有些技能直接用的乘数，也就是每次到达对应等级，技能的属性会 `= 技能等级 × inc`
可以重点找带 `inc` 名的键

# (二) 修改攻击与技能
## 一、攻击
继续往下有一些近战攻击（`melee`）与远程攻击（`ranged`）的组件

##### 1. 用途
首先需要先明白一些组件的用途

| <center>组件</center> |                  用途                   |
| ------------------- | :-----------------------------------: |
| 近战攻击 `melee`        | **拦截后的攻击**<br>**近战普攻包含在内，还指具有此行为的技能** |
| 远程攻击 `ranged`       |          **不进行拦截时的攻击**<br>同上          |
| 防御塔攻击 `attacks`     |            指防御塔的所有技能，包括攻击             |
| 技能 `timed_attacks`  |          **召唤实体、特殊攻击、生成光环等**          |
| 光环 `auras`          |            **持续造成伤害、给予效果**            |
| 效果 `modifier`       |       **各种正面或负面效果（减速、流血、中毒等）**        |
| 闪避 `dodge`          |               各种闪避、格挡等                |

**近战攻击与远程攻击**共用同一个函数，统称为攻击，防御塔攻击不包含在内

拦截可以进行的**远程攻击**称为特殊远程攻击

##### 2. 介绍
```lua
tt.melee.attacks[1].cooldown = 1
tt.melee.attacks[1].hit_time = fts(8)
tt.melee.attacks[1].sound = "MeleeSword"
tt.melee.attacks[1].xp_gain_factor = 2.5
tt.melee.range = 45
tt.ranged.attacks[1] = E:clone_c("bullet_attack")
tt.ranged.attacks[1].bullet = "arrow_hero_alleria"
tt.ranged.attacks[1].bullet_start_offset = {
	v(0, 12)
}
tt.ranged.attacks[1].max_range = 150
tt.ranged.attacks[1].min_range = 45
tt.ranged.attacks[1].shoot_time = fts(6)
tt.ranged.attacks[1].cooldown = 0.6
```
如代码所示，一般**第一个攻击 `attacks[1]` 都是普攻，其他都是相应行为的技能**

#### Q&A：
- Q：怎么知道我修改的是哪个攻击
- A：可以查资料找这个攻击的键对应哪个攻击
注：有的攻击可能会占有多个攻击，可以通过 `table.deepclone` 复制的攻击来分辨
用于播放不同动画，与增加额外效果

## 二、远程攻击
**本质**：远程攻击本质是召唤子弹，让子弹造成伤害
所以修改远程攻击只能修改远程攻击召唤的速度（攻击速度）、召唤范围（攻击范围）等

因为是召唤子弹所以**远程攻击的伤害和伤害类型等都是写在子弹上的，可以通过搜索子弹键（`bullet`）的键值对应的模板来找到子弹的各种键**
![[Pasted image 20250630184001.png|850]]
![[Pasted image 20250630184104.png|725]]
- 有些子弹的键可能是 `nil` 甚至没有
- 没有基本就是衍生底模板或者写在基础属性那里了

## 三、技能
##### 有些键找不到的解决方法：
找不到想修改的属性，可以通过查看技能的实现方法来找到属性的位置

示例：`E:clone_c("spawn_attack")` 召唤实体，实现方法就是召唤实体，和远程攻击的子弹一样；搜索 `entity` 键的键值的模板来找到想修改的属性
```lua
-- 小公主一技能野性呼唤
tt.timed_attacks.list[1] = E:clone_c("spawn_attack")
tt.timed_attacks.list[1].entity = "soldier_alleria_wildcat"	-- 搜索 soldier_alleria_wildcat 模板，可以找到野猫的属性
```

**还有光环、效果、子弹都是搜索对应键的键值的模板来找到想修改的属性**

注：这些模板内可能会多次镶套其他的模板，只要记住重点找效果、光环、子弹、实体这些就行

## 四、修改伤害类型
在攻击组件可能找不到伤害类型，不妨先搜索 `E:add_comps` 的 `melee` 组件看看有没有默认值

在 `components` 搜索 `melee` 组件
![[Pasted image 20250630155536.png|775]]
如图发现没有伤害类型，继续往下在 `E:clone_c` 发现攻击 1 来自 `melee_attack`，继续搜索 `melee_attack`
![[Pasted image 20250630160301.png|825]]
**如图发现近战攻击是有伤害类型的，默认是物伤，也就是说英雄的近战攻击如果不填伤害类型，那么伤害类型就是物伤**

##### 2. 修改
由此可以这样修改：
```lua
-- 模板内
tt.melee.attacks[1].damage_type = DAMAGE_TRUE	-- 手动加上伤害类型键，然后键值写伤害类型就行
```
伤害类型见 [[2 - 常量#一、伤害类型]]

- **其他比如魔抗等同理，可以通过以上方法改**（看看有没有默认值）
- 重点搜索 `E:register_t` / `E:add_comps` / `E:clone_c` 的组件或模板

## 五、效果（mod）
**主要目的**：让单位攻击造成减速效果、中毒、燃烧等

##### 1. 增加效果
1. 近战攻击直接在组件后面增加 `mod` 键，键值为效果模板名
2. 远程攻击增加到子弹模板的 `bullet` 键上，个别远程攻击无效
3. 技能能不能增加，增加到哪里取决于函数，后面修改函数再解释

**示例：**
```lua
-- 单位模板内
tt.melee.attacks[1].mod = "mod_lava"	--普通近战攻击造成燃烧效果，此燃烧来自模板可自行搜索

-- 子弹模板内
tt.bullet.mod = "mod_lava"	-- 子弹造成燃烧效果
```

##### 2. 五代的问题
- **注意：由于五代所有新加的键不会被读取所以必须写在 `game_templates` 内，写在 `balance` 是不会生效的**
**不嫌麻烦可以让新键的键值也读取 `balance`**

##### 示例：
让维斯珀普通近战攻击造成燃烧效果
```lua
-- balance 模块内
hero_spider = {
	basic_melee = {	-- 普通近战攻击
		mod = "mod_lava",	-- 效果
		...	-- 其他键值对，攻击速度等
	}
}

-- game_templates 模块内
b = balance.heroes.hero_spider
tt.melee.attacks[1].mod = b.basic_melee.mod	-- 读取 balance 内的表
```
**不推荐这种方法，如果你不想改 `game_templates` 也不行，因为后面基本都要改，一些东西也不在 `balance` 内**

##### Q&A：
- Q：为什么攻击可以直接增加效果，而技能不行
- A：因为近战攻击与远程攻击用的对应函数都有造成效果，而技能是单独的逻辑不一定有
- Q：如何造成多个效果
- A：只有光环和远程攻击可以造成多个效果，并且方法还不一样（铁皮逆天代码发力了）后面函数篇再讲怎么让近战攻击等造成多个效果
具体方法：
```lua
-- 子弹
tt.bullet.mod = {	-- 注意是 mod，不是 mods
	效果 1,
	效果 2
	...
}

-- 光环
tt.aura.mods = {	-- 注意是 mods，不是 mod，找不到光环可以先不管，知道怎么加就行
	效果 1,
	效果 2
	...
}
```

### [一] 修改效果
**手动创建一个效果模板以原效果为底表，然后修改键，增加这个效果即可**

注意：不建议直接修改基础效果（例如 `all/templates` 内的），因为其他实体可能也在使用这个效果，如果修改则会影响其他实体
**想直接修改效果必须保证这个效果没有其他实体使用或作为底模板使用**
- 一般英雄特有的效果基本可以随便改，不要死脑筋都创建一个新效果

##### 示例：
```lua
-- 模板内
-- 原 tt.melee.attacks[1].mod = "mod_lava"
tt.melee.attacks[1].mod = "mod_lava_2"	--仅存储模板名，所以创建与增加 mod 无先后顺序

-- 子弹模板内
-- 原 tt.bullet.mod = "mod_lava"
tt.bullet.mod = "mod_lava_2"

lava_2 = E:register_t("mod_lava_2", "mod_lava")	-- 创建 mod_lava_2 模板以 mod_lava 为底模板
-- 接收返回值的变量不建议使用 tt，因为会修改 tt 的引用，导致之后增加的键增加到效果里，与预期的位置不符导致错误

lava_2.dps.damage_inc = 6	-- inc 倍数，也就是伤害倍数 6 倍（原燃烧伤害倍数 3）
lava_2.dps.damage_every = 0.1	-- 伤害间隔，每 0.1 秒造成一次伤害
```
自行搜索 `mod_lava` 模板查看有哪些键

### [二] 让两个不同效果不可叠加
**主要目的**：实现两个不同效果不可共存

效果模板使用 `modifier.bans` 键，键值为**效果表**，即可让两个不相同效果**单向不可叠加**
**注意这里是单向，双向需要互相增加对方效果**
即 **A ban B，有 A 不能有 B，有 B 可以有 A。AB 互相 ban，有 A 不能有 B，有 B 不能有 A**

`modifier.ban_types` 键则是一个效果类型（类似于 flag 标签）
例如：`mod_freeze` 冻结效果就是典型 `MOD_TYPE_FREEZE` 类型，`mod_elora_bolt_freeze` 冰女的冻结也是这个类型

效果类型见 [[2 - 常量#三、效果类型]]

##### 示例：
```lua
-- 燃烧效果模板内
tt.modifier.bans = {
	"mod_freeze",	-- 指定具体效果，如果目标上有燃烧效果，目标将不会被冻结
	...	-- 可指定多个
}
tt.modifier.ban_types = {	-- 可选
	MOD_TYPE_FREEZE,	-- 指定一个效果类型，如果目标上有燃烧效果，目标将不会被冻结类型的所有效果冻结
	...
}
```

### [三] 让两个不相同效果互斥
**主要目的**：实现类似于两个效果之间元素的克制关系，让两个效果互斥，例如冻结与燃烧，如果目标上有冻结，此时给目标造成燃烧效果，主动移除冻结效果

**在之前的基础上给效果模板增加 `modifier.remove_banned` 键，键值为 `true`，即可**

**注：**
1. 还是单向，双向方法同上
2. **与上面的不可叠加共用同一个键，并且是复合含义**所以易混淆
具体含义：**被动无法与对应效果共存 A ← B**，**主动移除对应效果 A → B**
3. 被动优先级高于主动，如果对方效果被动与当前效果无法共存，当前效果主动移除对方效果，因为被动优先级高所以当前效果将不会被造成

##### 示例：
```lua
-- 燃烧效果模板内
tt.modifier.remove_banned = true
tt.modifier.bans = {
	"mod_freeze",	-- 指定具体效果，如果目标上有冻结效果，主动移除冻结效果，并且被动无法与冻结共存
	...
} 
tt.modifier.ban_types = {	-- 可选
	MOD_TYPE_FREEZE,	-- 指定一个效果类型，如果目标上有冻结类型的效果，主动移除冻结类型的效果，并且被动无法与冻结共存
	...
}
```

### [四] 实现多个相同效果叠加
相同效果就是模板名称相同的效果，效果等级就是 `modifier.level` 键

给效果模板加上 `modifier.allows_duplicates` 键，键值为 `true`，即可允许**叠加多个相同等级**的相同效果

`modifier.replaces_lower` 键为**替换不相同等级**的相同效果
`modifier.resets_same` 键为**重置相同等级**的相同效果的**持续时间**
注意等级问题

## 六、范围攻击与多次攻击
### [一] 范围攻击
使攻击 `E:clone_c("aura_attack")`，然后加上伤害范围等即可

示例：
```lua
tt.melee.attacks[1] = E:clone_c("area_attack")
tt.melee.attacks[1].damage_radius = 25	-- 伤害范围 25 码，必要
tt.melee.attacks[1].count = 3	-- 最多对三名敌人造成伤害，可选
tt.melee.attacks[1].min_count = 2	-- 需要两名敌人才能进行这个攻击，可选
```

### [二] 多次攻击
只要给攻击加上 `loops` 键并在键值设置次数，设置播放的动画，即可实现每次攻击时攻击多次
`hit_times` 或 `shoot_times` 则是一次攻击的次数

注意：`loops` 键的键值必须要有值， `hit_times` 和 `shoot_times` 才会生效
- 可以理解成乘算：`攻击次数 = loops × hit_times/shoot_times`

##### 1. 设置动画

```lua
tt.melee/ranged.attacks[1].animations = {
	nil,
	"attack/shoot",	-- 近战攻击填 "attack"，远程攻击填 "shoot"，套用普通攻击动画
	nil
}
```

##### 2. `loops`
**根据数字**决定攻击次数

示例：
```lua
tt.melee.attaks[1].loops = 2	-- 攻击 2 次
```

##### 3. `hit_times`
**根据表的键数**决定**近战攻击一次攻击的次数**

示例：
```lua
tt.melee.attacks[1].animations = {
	nil,
	"attack",	-- 近战攻击填 "attack"
	nil
}
tt.melee.attaks[1].loops = 1	-- 不想每次攻击多次填 1 就行
tt.melee.attaks[1].hit_times = {n, fts(1)}	-- 一次攻击 2 次，n 为秒，1 fts = 1 ÷ 30
```

##### 4. `shoot_times`
**根据表的键数**决定**远程攻击一次攻击的次数**

示例：
```lua
tt.ranged.attacks[1].animations = {
	nil,
	"shoot",	-- 远程攻击填 "shoot"
	nil
}
tt.ranged.attaks[1].loops = 1
tt.ranged.attaks[1].shoot_times = {n, fts(1)}	-- 一次性攻击 2 次
```

# (三) 增加闪避
只需要给实体增加闪避组件即可

示例：
```lua
E:add_comps(tt, "dodge", ...)	-- 增加闪避组件
tt.dodge.chance = 0.25	-- 闪避概率 25 %
tt.dodge.silent = true	-- true 表示无动画
```

# (四) 目标过滤
**主要目的**：对特定目标不释放某个攻击，或释放技能
**当然也可以实现对特定单位、攻击以及技能的特定行为**

攻击的标签与过滤标签写在 `vis_flags` 和 `vis_bans` 键上，而单位则是 `vis` 键的 `flags` 和 `bans` 键上

##### 作用
一般用于索敌：**每次索敌时与标签进行按位与运算**
若攻击标签 `vis_flags` 被目标 `vis.bans` 过滤或目标标签 `vis.flags` 被攻击 `vis_bans` 过滤，则不选择这个目标
**即：攻击过滤 → 目标标签，目标过滤 → 攻击标签**

参考 `SU.soldier_pick_melee_attack` 代码片段： 
`band(a.vis_flags, t.vis.bans) == 0 and band(a.vis_bans, t.vis.flags) == 0`

**可以通过位运算来增加多个标签，位运算见** [[1.3 - 常量#位运算]]
所有标签见 [[2 - 常量#二、标签]]

##### 示例：
```lua
-- 某个单位模板
tt.vis.bans = F_RANGED	-- 不会被远程攻击

tt.ranged.attacks[1].vis_bans = bor(F_BOSS, F_FLYING)	-- 远程攻击不攻击 boss 与飞行敌人
tt.ranged.attacks[1].vis_flags = F_RANGED	-- 远程攻击标签

-- 某个敌人模板
tt.vis.bans = F_DRILL	-- 不会被钻头攻击，就是二代的地震的钻头
```

- 支持在效果、光环上增加
- 可以自己在 `constants` 写个标签

> 参考资料：
> [标签与技能的释放机制 by发的gtr让他发 -百度贴吧](https://tieba.baidu.com/p/9839262014)

