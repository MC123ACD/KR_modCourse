路径中：
1. `ni` 为节点索引（**node index**），即一条路径中的位置
2. `pi` 为路径索引（**path index**），即不同路径
3. `spi` 为子路径索引（**subpath index**），即路径中的三个分支
![[Pasted image 20250812125430.png]]
如图所示一条路径有三条子路径，白点为节点

## 一、路径相关逻辑
### [一] 加载路径
1. 加载关卡路径数据并存入 `P:paths`
2. `P:set_start_node` 与 `P:set_end_node` 函数设定起点与终点节点，存入 `P:path_start_node` 与 `P:set_end_node`

### [二] 终点更新
1. 在驱动函数调用 `sys.goal_line:on_update` 函数
2. 若具有 `nav_path` 键的敌人到达终点（`nav_path.ni >= P:path_end_node`）则：
	1. 将生命减去敌人的 `enemy.lives_cost`，并移除这个敌人

## 二、路径操作函数
以下是所有函数的表格，表头为“函数”，函数形式参数使用中文描述：

| <center>**作用（距离为节点距离）**</center>                       | <center>函数</center>                                           |
| ------------------------------------------------------ | ------------------------------------------------------------- |
| **返回路径宽度**                                             | `P:path_width(路径, 子路径, 节点)`                                   |
| **返回节点坐标**                                             | `P:node_pos(路径, 子路径, 节点, 是否返回引用)`                             |
| **返回偏移后节点坐标**                                          | `P:node_offset_pos(偏移量, 路径, 子路径, 节点)`                         |
| **返回起点的节点**                                            | `P:get_start_node(路径)`                                        |
| **返回可见终点的节点**                                          | `P:get_visible_end_node(路径)`                                  |
| **返回可见起点的节点**                                          | `P:get_visible_start_node(路径)`                                |
| **返回终点的节点**                                            | `P:get_end_node(路径)`                                          |
| **返回防守点的节点**                                           | `P:get_defend_point_node(路径)`                                 |
| **返回节点到起点距离**                                          | `P:nodes_from_start(路径, 子路径, 节点)`                             |
| **返回节点到终点距离**                                          | `P:nodes_to_goal(路径, 子路径, 节点)`                                |
| **返回节点到防守点距离**                                         | `P:nodes_to_defend_point(路径, 子路径, 节点)`                        |
| **判断一定距离是否存在节点**                                       | `P:point_within_distance(x, y, 距离)`                           |
| **返回一个根据距离排序的表：<br>子表包含附近所有节点的<br>所在路径、子路径、节点、<br>距离** | `P:nearest_nodes(x, y, 路径表, 子路径表, 是否仅有效节点, 标签, 过滤函数, 步长)`     |
| **返回地形类型**                                             | `P:path_terrain_types(路径)`                                    |
| **返回地形属性**                                             | `P:path_terrain_props(路径)`                                    |
| **判断路径是否激活**                                           | `P:is_path_active(路径)`                                        |
| **激活路径**                                               | `P:activate_path(路径)`                                         |
| **关闭路径**                                               | `P:deactivate_path(路径)`                                       |
| **增加无效节点范围**                                           | `P:add_invalid_range(路径, 从, 到, 标签)`                           |
| **移除无效节点范围**                                           | `P:remove_invalid_range(路径, 从, 到)`                            |
| **判断节点是否有效**                                           | `P:is_node_valid(路径, 节点, 标签)`                                 |
| **返回所有有效节点**                                           | `P:get_valid_nodes(路径, 标签)`                                   |
| **返回第一个找到的有效节点**                                       | `P:find_valid_node(路径, 开始节点, 步长, 标签)`                         |
| **判断附近有没有有效节点**                                        | `P:valid_node_nearby(x, y, 路径宽度乘数, 标签)`                       |
| **返回随机节点的坐标、<br>节点所在路径、子路径、<br>节点**                    | `P:get_random_position(边距, 地形标签, 标签, 边距是否相当于防御点)`             |
| **返回连接的下一路径**                                          | `P:get_next_pi(路径)`                                           |
| **返回所有连接的路径**                                          | `P:get_connected_paths(路径)`                                   |
| **查找首个有效节点**                                           | `P:get_all_valid_pos(x, y, 最小距离, 最大距离, 地形标签, 过滤函数, 标签, 子路径表)` |
| **获取路径宽度**                                             | `P:nodes_as_list(标签)`                                         |

