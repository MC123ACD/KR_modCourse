游戏引擎版本：`Lua_v5.1 + Love 2d_v10.2 + LuaJIT_v2.0.4`

（通过 `print` 版本信息得到）

# (一) 环境配置
## 一、安装 VS Code：

> [下载链接](https://code.visualstudio.com/))
## 二、创建工作区文件夹
1. **将网盘的整合包下载并解压**
条件允许的情况下推荐直接下载仓库的整合包

> [下载链接](https://pan.baidu.com/s/1FNmzdCuilWbFg5sFR0AO5w?#list/path=%2F%E8%8B%B1%E9%9B%84%E8%A1%A5%E5%BC%BA%2F%E5%B7%A5%E5%85%B7)
![[Pasted image 20250710100316.png|347]]

2. **将 `VScode_KR_workspace` 文件夹放到 D 盘**
可以放到其他地方，但要保证没有中文路径，也可以重命名，请改一个便于找到的位置与名字
![[Pasted image 20250706200745.png|395]]
此文件夹包含配置文件、Love 2d 引擎，以及用于推荐插件与使用预先修改的设置

## 三、安装 Lua 扩展
1. **打开 VSCode → 安装所有建议的扩展**
位于右下角
![[Pasted image 20250710092722.png|525]]
- 包含 Lua 代码补全、诊断、格式化、用于调试的扩展
- 所有插件均配置完毕，无需自行配置

## 四、将游戏复制到工作区文件夹
1. **将要修改的游戏本体 exe 复制到工作区文件夹内的 src 文件夹内**

| ![[Pasted image 20250618131806.png\|675]] | ![[Pasted image 20250716183243.png\|425]] |
| ----------------------------------------- | ----------------------------------------- |

2. **将游戏本体解压到当前位置**
注意：不是直接解压，而是解压到当前位置

| ![[Pasted image 20250707085646.png\|367]] | ![[Pasted image 20250707085857.png\|650]] |
| ----------------------------------------- | ----------------------------------------- |
后续 exe 本体可自行删除

3. **使用 VSCode 打开文件夹**
双击工作区文件夹的 `VScode_KR_workspace` 文件即可
![[Pasted image 20250716131909.png|325]]
- 设置与配置均已在 `.vscode` 内设置完毕，为了性能部分游戏资源文件已被排除（图片等）

参考资料：
> [VSCODE 调试 LOVE 引擎游戏 - 小能日记 - 博客园](https://www.cnblogs.com/linxiaoxu/p/17653162.html)

## 五、反编译
1. **安装 Python**

> 由于国内在官网下载较慢，所以提供镜像网站下载：
> [链接](https://mirrors.huaweicloud.com/python/3.13.5/python-3.13.5-amd64.exe)

2. **打开 `luajit-decompiler-v2/无错误弹窗反编译`**

3. **浏览选择工作区文件夹的 `src`，进行反编译**
可能会未响应几分钟，这是正常现象，耐心等待完成即可
![[Pasted image 20250727204353.png|875]]

4. **替换原文件**
反编译后将 `output` 文件夹内的所有文件拖入 `src` 全部替换即可
![[Pasted image 20250727205026.png|850]]

## 六、开启游戏的调试
1. **打开 `src/version`**
2. **将 `build` 键键值改为 `"DEBUG"`**
![[Pasted image 20250706170225.png|650]]

## 七、运行
1. **打一些断点**
尽量打到会立刻执行的代码上，比如 `kr/game_templates` 内
![[Pasted image 20250618143505.png|625]]
2.  **运行游戏**
Debug 为调试模式，Release 则为正常模式
![[Pasted image 20250706203549.png|371]]
一切正常下游戏会在断点处暂停，同时可以看到变量、堆栈
![[Pasted image 20250618143251.png|725]]完成后存档位置与原版独立，路径为 `C:\Users\用户\AppData\Roaming\LOVE\kingdom_rush_xxx`
**也可以点击工作区文件夹内的存档位置快捷方式进行跳转**

# (二) 可选
## 一、监视变量
注：只有触发断点时监视才可用

| <center>变量</center>             | <center>描述</center>          |
| ------------------------------- | ---------------------------- |
| `game.game_gui.selected_entity` | **被鼠标选中的单位的表会显示在内**          |
| `game.store`                    | **临时的表等（创建的实体等都在内）**         |
| `game.game_gui`                 | **游戏 GUI（进入关卡后的技能、金币、生命等）**  |
| `screen_map`                    | **地图的 UI 与 GUI 等（英雄殿堂、升级等）** |

![[Pasted image 20250621105918.png|450]]

## 二、报错时自动断点
```lua
if LLDEBUGGER then
	LLDEBUGGER.start()
end
```
复制以上代码到 `main.love.errhand` 函数的 `while true` 循环之前即可
![[Pasted image 20250926101829.png|400]]

# (三) 使用方法
## 一、调试快捷键

|          快捷键           | **<center>功能</center>** |          快捷键          | **<center>功能</center>**    |
| :--------------------: | ----------------------- | :-------------------: | -------------------------- |
|          `/`           | **禁用调试快捷键**             |     `Shift` + `l`     | **降低 100 生命**              |
|          `a`           | **暂停程序**                |          `n`          | **跳过这一波，同时秒杀所有敌人**         |
|          `s`           | **暂停后步进一次**             |     `Shift` + `n`     | **显示防御塔位创建顺序**             |
|          `d`           | **秒杀鼠标选中实体**            |          `m`          | **增加 1000 金币**             |
|     `Shift` + `d`      | **选中单位血量设置为 10 %**      |     `Shift` + `m`     | **降低 1000 金币**             |
|      `Ctrl` + `d`      | **选中单位血量回满**            |           `           | **显示控制台**                  |
| `Shift` + `Ctrl` + `d` | **删除选中的实体**             | `q w e r t y u i o p` | **显示控制台后，召唤对应敌人**          |
|          `g`           | **显示网格**                |          `j`          | **切换召唤路径**                 |
|          `h`           | **显示路径 / 高亮当前路径**       |         `[ ]`         | **敌人列表 上一页/下一页**           |
|          `z`           | **游戏速度 × 2**            |          `=`          | **启用控制台连续出怪**              |
|     `Shift` + `z`      | **游戏速度 ÷ 2**            |         `+ -`         | **设置连续出怪间隔**               |
|          `x`           | **英雄获得 500 经验**         |          `;`          | **是否从随机子路径召唤**             |
|          `c`           | **高亮所有实体**              |     `Shift` + `;`     | **是否移除所有 `mod`（效果）**       |
|     `Shift` + `c`      | **高亮攻击轨迹**              |          `,`          | **统计进入关卡后的时间**             |
|          `v`           | **技能冷却时间清零**            |          `.`          | **统计自第一次按这个按键到这次的时间，逗号重置** |
|          `b`           | **高亮各种范围（攻击范围等）**       |       `F9 F10`        | **降低/增加 敌人速度，需要重新开始关卡**    |
|          `l`           | **增加 100 生命，不超过 1000**  |                       |                            |

##### 五代特有
- **点击左上角金币图标，可以开启有 UI 的控制台**（功能与快捷键相同）
![[Pasted image 20250620190901.png|600]]

|     快捷键      | 功能    |
| :----------: | ----- |
|     `F5`     | **伤害显示**  |
|     `F8`     | **隐藏 UI** |
|    `F12`     | **显示控制台** |
| `Ctrl` + `l` | **直接胜利**  |

## 二、调试控制台
调试控制台会显示详细信息，比如加载资源，所有点击事件，操作实体（插入，移除）等

| 信息        | 搜索             |
| --------- | -------------- |
| **报错**        | `error`        |
| **点击事件**      | `mousepressed` |
| **操作实体等**     | `systems`      |
| **调用的 SU 函数** | `script_utils` |
| **加载的资源**     | `load`         |
| **关卡相关**      | `level_utils`  |

待补充...

## 三、断点
运行过程可按 `0` 手动断点

## 四、关卡编辑器
1. **取消 `screen` 与 `custom` 的注释**
2. `custom` **输入要编辑的关卡的编号运行后即可进入关卡编辑器**
![[Pasted image 20250712192159.png|500]]

# (四) 排查问题
## 一、调试快捷键失效
关闭输入法即可

## 二、运行后卡住没反应或调试控制台不显示日志
检查 `conf` 模块关闭游戏自带控制台，将 `console` 键键值从 `true` 改为 `false`
![[Pasted image 20250618142239.png|325]]

## 三、Local Lua Debugger 报错
![[Pasted image 20250803203730.png|750]]
在 `all/systems` 搜索 `main_script:on_update`
```lua
-- 将以下代码修改
if coroutine.status(s.co) == "dead" or error ~= nil then
	if error ~= nil then

-- 修改为
if coroutine.status(s.co) == "dead" or (not success and error ~= nil) then
	if not success and error ~= nil then
```
![[Pasted image 20250717091020.png|975]]

## 四、在错误地方寻找 `lua` 文件
将 `main` 模块的 `ppref` 设为空字符串即可
![[Pasted image 20250618161513.png|600]]

## 五、代码补全卡顿
在设置关闭诊断即可
![[Pasted image 20250728093403.png|675]]