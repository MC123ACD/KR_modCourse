# 定义
每次创建实体都会调用一次的函数，称为插入函数（**insert script**）

# 造成伤害
##### 1. 搜索插入函数
**搜索模板并在 `kr/game_scripts` 找到函数（如图为艾莉丹）**
![[Pasted image 20250701213229.png|825]]
```lua
function scripts.hero_elves_archer.insert(this, store)
-- this 表示调用插入函数的完全独立的实体，store 就是存储实体的表
	...
	
	local d = E:create_entity("damage")	-- 造成伤害
	d.value = 233666					-- 伤害
	d.target_id = this.id				-- 目标 id 设置为当前英雄 id
	queue_damage(store, d)				-- 插入伤害队列
end
```

##### 2. 运行游戏
**使用修改的英雄进入关卡，英雄掉血，成功**
![[Pasted image 20250716185606.png|194]]
造成效果同理，不过要插入实体队列，而不是伤害队列
```lua
local mod = E:create_entity(效果模板名)	-- 造成效果
mod.modifier.target_id = this.id		-- 目标
queue_insert(store, mod)				-- 插入实体队列
```

# 实体增加光环
以给沙王增加死亡骑士光环为例：
##### 1. 函数创建光环
```lua
function scripts.hero_alric.insert(this, store, script)
-- hero_alric 为沙王模板名，this 就是通过模板创建的沙王实体
	...
	if this.hero.skills.toughness.level > 0 then		-- 若坚韧技能等级大于 0，可选
		local e = E:create_entity("death_rider_aura")	-- 创建死亡骑士光环
		e.aura.source_id = this.id						-- 来源设置为沙王

		queue_insert(store, e)							-- 创建光环 e，也就是死亡骑士光环
	end
end
```
##### 2. 修改光环
进入游戏后发现光环显示位置错误，这是因为光环显示位置有偏移，只需要移除偏移即可

- 模板内：
```lua
-- 创建新模板，底表为原死亡骑士光环
draa = E:register_t("death_rider_aura_alric", "death_rider_aura")

draa.aura.use_mod_offset = nil	-- 移除偏移
...								-- 其他属性同理，比如作用范围，护甲或伤害加成等
```

- 插入函数内：
```lua
local e = E:create_entity("death_rider_aura_alric")	-- 修改创建的实体表为新模板
```

# 修改攻击优先级
**思路**：[[第 3 章 - 函数/总结#七、攻击逻辑]] 通过查看逻辑知道：攻击优先级是插入函数中的排序函数决定的，并且优先级存于攻击的 `order` 表中

**由此得出思路：删除实体插入函数的排序函数，直接在 `order` 表手动指定优先级**

##### 1. 删除插入函数的排序函数
```lua
function scripts.hero_regson.insert(this, store)
	this.hero.fn_level_up(this, store, true)
	
	this.melee.order = U.attack_order(this.melee.attacks)	-- 删除这个
	
	if this.hero.skills.blade.level > 0 then
		local a = E:create_entity("aura_regson_blade")
	end
...
```

##### 2. 指定优先级
- 模板内：
```lua
tt.melee.order = {
	2,		-- 优先释放攻击 2
	1,		-- 之后释放攻击 1
	...		-- 注：必须填写所有的攻击，没填写的攻击将永不释放
}
```
