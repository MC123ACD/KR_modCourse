# 作用
每次创建实体都会调用一次对应实体的插入函数

**有些技能就是通过插入函数来实现的；**
**典型代表就是二代女巫的 1 伤害的光环，原理：调用插入函数 → 判断技能等级 → 创建光环**

# (一) 造成伤害
##### 1. 搜索插入函数
**搜索对应英雄的模板，在 `kr/game_scripts` 就可以找到函数了（如图为艾莉丹）**
![[Pasted image 20250701213229.png|825]]
```lua
function scripts.hero_elves_archer.insert(this, store)
-- this 表示调用插入函数的完全独立的实体，store 就是存储实体的表
	...
	
	local d = E:create_entity("damage")	-- 造成伤害
	d.value = 233666	-- 伤害
	d.target_id = this.id	-- 目标 id 设置为当前英雄 id
	queue_damage(store, d)	-- 插入伤害队列
end
```

##### 2. 运行游戏
**使用修改的英雄进入关卡，英雄掉血，成功**
![[Pasted image 20250716185606.png|194]]
造成 mod 同理，只不过要插入实体队列，而不是伤害队列
```lua
local mod = E:create_entity(效果模板名)	-- 造成效果
mod.modifier.target_id = this.id	-- 目标
queue_insert(store, mod)	-- 插入实体队列
```

# (二) 给实体增加光环
以给沙王增加死亡骑士光环为例：
##### 1. 函数创建光环
```lua
function scripts.hero_alric.insert(this, store, script)
-- hero_alric 为沙王模板名，this 就是通过模板创建的沙王实体
	...
	if this.hero.skills.toughness.level > 0 then	-- 若坚韧技能等级大于 0，可选
		local e = E:create_entity("death_rider_aura")	-- 创建死亡骑士光环
		e.aura.source_id = this.id	-- 来源设置为沙王

		queue_insert(store, e)	-- 创建光环 e，也就是死亡骑士光环
	end
end
```
##### 2. 修改光环
进入游戏后发现光环显示在了脸上，这是因为默认光环显示位置有偏移，移除偏移即可

```lua
-- 模块内
-- 创建新模板，底表为原死亡骑士光环，变量为缩写用于区分模板
araa = E:register_t("death_rider_aura_alric", "death_rider_aura")

araa.aura.use_mod_offset = nil	-- 移除偏移
...	-- 其他属性同理，比如作用范围，护甲或伤害加成等

-- 实体插入函数内
local e = E:create_entity("death_rider_aura_alric")	-- 修改创建的实体表为新模板即可
```

# (三) 修改攻击优先级
**删除实体插入函数的排序函数，直接在模板手动写优先级即可（写攻击的序号，例如攻击 1 就是 1）**

##### 1. 删除插入函数的排序函数
![[Pasted image 20250701134555.png|500]]

##### 2. 手动指定优先级
```lua
-- 模板内
tt.melee.order = {
	2,	-- 优先释放攻击 2
	1,	-- 之后释放攻击 1
	...	-- 注意：必须填写所有的攻击，没填写的将不会被释放
}
```
注：仅能修改攻击，技能需要在更新函数修改代码顺序