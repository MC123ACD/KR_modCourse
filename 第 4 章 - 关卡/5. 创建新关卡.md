# 创建新关卡
## 一、创建新关卡
##### 1. 增加关卡背景
1. **绘图**
可以使用 AI 进行绘图
> [AI 链接](https://tieba.baidu.com/p/9780582087?)

2. **将背景图片放入 `_assets/kr-desktop/images/fullhd` 内，并改名为 `go_stagex_bg-1`，x 为关卡编号，在保证不会与已有关卡冲突的条件下可以随便填一个**
图片分辨率推荐 1920x1080
![[Pasted image 20250809164512.png|425]]

3. **然后创建对应的数据文件 `go_stagex_bg.lua`，x 同上，并复制以下模板**
```lua
return {
    stagex = {	-- x 同上
        a_name = "go_stagex_bg-1.png",-- x 同上
        size = {
            1920,
            1080
        },
        trim = {
            0,
            0,
            0,
            0
        },
        a_size = {
            1920,
            1080
        },
        f_quad = {
            0,
            0,
            1920,
            1080
        },
        alias = {}
    }
}
```

##### 2. 给选择模式的界面增加封面
在 `_assets/kr1-desktop/images/fullhd/screen_map` 最后面增加一个表即可：
```lua
stage_thumbs_000x = {	-- x 同上，若 x 为 1 则是 0001，大于等于 10 则需要在前面加 “00” 如：0010
	a_name = "go_stagex_bg-1.png",
	size = {
		1920,
		1080
	},
	trim = {
		0,
		0,
		0,
		0
	},
	a_size = {
		342,
		246
	},
	f_quad = {
		0,
		0,
		342,
		246
	},
	alias = {}
}
```
![[Pasted image 20250809094636.png|425]]
##### 4. 五代封面
```lua
level_select_thumbs_thumb_stage_427_0001 = {
	a_name = "room_levelselect_level_select_thumbs-427.dds",
	defer = true,
	size = {
		2016,
		1064
	},
	trim = {
		0,
		0,
		0,
		0
	},
	a_size = {
		2016,
		1064
	},
	f_quad = {
		0,
		0,
		2016,
		1064
	},
	alias = {}
},
```
##### 5. 创建关卡数据
在 `kr\data\levels` 创建 `levelx_data.lua` 文件，x 同上，并复制以下模板，参数可以按照自己的想法填
```lua
return {
    entities_list = {
        {
            template = "decal_background",	-- 背景贴图，背景本质也是实体
            pos = {
            	x = 512,
                y = 384
            },
            ["render.sprites[1].name"] = "stage27",
            ["render.sprites[1].z"] = 1000
        },
        {
            template = "decal_background",	-- 防守点旗帜，可选
            pos = {
                x = -43.46875,
                y = 326.34375
            },
            ["render.sprites[1].name"] = "blue_flag",
            ["render.sprites[1].z"] = 1400
        },
        {
            template = "decal_background",
            pos = {
                x = -43.46875,
                y = 526.03125
            },
            ["render.sprites[1].name"] = "blue_flag",
            ["render.sprites[1].z"] = 1400
        },
        {
            template = "decal_defend_point",	-- 防守点，必加，否则进入将会报错
            ["editor.exit_id"] = 1,
            pos = {
                x = -44.875,
                y = 402.28125
            }
        },
        {
            template = "editor_wave_flag",	-- 释放波次贴图，必加，否则无法释放波次
            ["editor.len"] = 240,
            ["editor.path_id"] = 1,
            ["editor.r"] = 0,
            pos = {
                x = 1156.0625,
                y = 399.46875
            }
        },
    },
    invalid_path_ranges = {},
    level_mode_overrides = {
        {
            locked_towers = {},
            max_upgrade_level = 5
        },
        {
            locked_towers = {},
            max_upgrade_level = 5
        },
        {
            locked_towers = {},
            max_upgrade_level = 5
        }
    },
    level_terrain_type = 1,
    locked_hero = false,
    max_upgrade_level = 5,
    nav_mesh = {},
    required_sounds = {},	-- 音效资源
    required_textures = {
        "go_enemies_grass",	-- 一些敌人资源
        "go_stagex_bg",	-- 加载对应关卡背景资源，x 同上
        "go_stages_blackburn"	-- 借用里面的防守点旗帜资源
    }
}
```

##### 4. 增加关卡
1. **将 `game_settings.last_level` 数字加 1**

2. **在 `game_settings.level_ranges` 最后面增加一个关卡序号表，表内填增加的关卡序号 `{x}`，可以增加 `list` 键改为无序解锁**
`game_settings.level_ranges` 表决定关卡解锁顺序，注：所有支线第一关在主线通关后会全部解锁

示例：
```lua
game_settings.level_ranges = {
	{
		1,
		12	-- 1-12 关为主线
	},
	-- 主线通关后解锁第 13、14、17 关支线
	{
		13
	},
	{
		14,
		16	-- 第 14 关通关后解锁第 15 关，第 15 关通关后解锁第 16 关，以此类推
	},
	{
		17,
		22,	-- 第 16 关通关后仅解锁第 22 关
		list = true
	},
	...
}
```

3. **在 `kr-desktop\data\map_data.level_data` 最后面增加一个表：**
```lua
{
	upgrades = {
		heroe = true,	-- 规则：有英雄
		level = 5	-- 规则：防御塔等级
	},
	iron = {	-- 钢铁规则：禁用的塔
		"archers",	-- 箭塔
		"barracks"	-- 兵营
		"mages",	-- 法师
		"artillery",	-- 炮塔
	}
}
```
`map_data.level_data` 表的键的下标索引决定对应的关卡的模式选择界面显示的规则
![[Pasted image 20250809094524.png|190]]

4. **在 `kr-desktop/data/map_points.flags` 最后面增加一个入口位置表**
```lua
{
	number = "x",	-- 关卡编号
	pos = {
		x = 1173,	-- 位置
		y = 102
	}
}
```
`map_points.flags` 表的键的下标索引决定对应关卡的入口的坐标位置

## 二、设置塔位、路径等
##### 1. 进入关卡编辑器
将 `args` 启动参数的关卡编辑器取消注释，将 `custom` 键修改为刚刚创建的关卡编号
运行游戏即可进入关卡编辑器

##### 2. 修改防守点的旗帜与防守点位置
点击小加号选中，拖动即可移动位置，注：需要点击 entities 选项
![[Pasted image 20250807181638.png|900]]
防守点规定了英雄出生位置

##### 3. 增加塔位
搜索并选择样式，然后插入塔位即可
修改位置的方法还是拖动，注：会同时插入名为 `editor_rally_point` 的默认集结点
![[Pasted image 20250807183501.png]]
注：若进入关卡发现塔位贴图消失就是忘记选择样式了

##### 4. 增加路径
点击 paths 选项然后创建路径，自行设定路径即可
![[Pasted image 20250807182230.png]]
注：较大的节点为起点，推荐将起点与终点设在关卡背景外
最下面 subdivide 可以增加额外节点

##### 5. 画网格
点击 grid 选项，选择网格类型然后画满背景即可
![[Pasted image 20250807183059.png|725]]
网格规定了可更改集结点单位的可移动区域

路径上直接画 land，非路径一般都有 no walk 标签
brush size 为刷子大小

##### 6. 方向键切换塔位
点击 nav 选项然后点击塔位调整 top / left / right / bottom 即可
![[Pasted image 20250808185126.png|500]]
nav 规定了键盘方向键切换塔位的顺序

##### 7. 保存
一切完毕后点击 save 保存即可
此时会自动创建对应关卡的路径与格子数据文件

## 三、增加波次
##### 1. 增加波次数据
使用波次编辑器在 `kr\data\waves` 创建 `levelx_waves_campaign` 波次数据文件
注：不同后缀表示对应模式的波次数据，英雄为 \_heroic，钢铁为 \_iron，请自行创建，若没有则全部使用战役的波次数据

##### 2. 增加波次释放按钮
再次打开关卡编辑器插入 `editor_wave_flag` 的实体，修改位置即可
![[Pasted image 20250808090849.png]]
注：默认按钮是没有贴图的，需要找加号修改位置（加号默认在中心点偏下）
如果有多条路径则需要增加多个波次释放按钮

## 四、装饰
可以通过插入实体来创建一些动态贴图或可交互彩蛋
![[Pasted image 20250811184142.png|349]]
注：其他场景装饰实体自行在关卡编辑器查看，并且需要加载相应贴图与动画资源