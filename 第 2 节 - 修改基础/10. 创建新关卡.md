## 10.1 创建新关卡
##### 1. 增加关卡背景
1. **绘图**
可以使用 AI 进行绘图
> [AI 链接](https://tieba.baidu.com/p/9780582087?)

2. **将关卡背景图像放入 `_assets/kr-desktop/images/fullhd` 内，并改名为 `go_stageX_bg-1`，X 为关卡编号，一位前导零**
图像分辨率推荐 1920x1080
![[Pasted image 20250809164512.png|425]]

3. **创建对应的数据文件 `go_stageX_bg.lua`，使用以下模板**
```lua
return {
    stageX = {		-- 无前导零
        a_name = "go_stageX_bg-1.png",
        size = {
            1920,
            1080
        },
        trim = {
            0,
            0,
            0,
            0
        },
        a_size = {
            1920,
            1080
        },
        f_quad = {
            0,
            0,
            1920,
            1080
        },
        alias = {}
    }
}
```

##### 2. 给选择模式的界面增加封面
在 `_assets/kr-desktop/images/fullhd/screen_map` 末尾增加一个表：
```lua
stage_thumbs_000X = {	-- 若 X 为 1 则是 0001，大于等于 10 则需要在前面增加 “00” 如：0010
	a_name = "go_stageX_bg-1.png",
	size = {
		1920,
		1080
	},
	trim = {
		0,
		0,
		0,
		0
	},
	a_size = {
		342,
		246
	},
	f_quad = {
		0,
		0,
		342,
		246
	},
	alias = {}
}
```
![[Pasted image 20250809094636.png|425]]
##### 4. 五代封面
五代在 `_assets/kr-desktop/images/fullhd/room_levelselect`

```lua
level_select_thumbs_thumb_stage_X_0001 = {	-- X 四位前导零
	a_name = "go_stageX_bg-1.dds",	-- X 一位前导零
	defer = true,
	size = {
		2016,
		1064
	},
	trim = {
		0,
		0,
		0,
		0
	},
	a_size = {
		2016,
		1064
	},
	f_quad = {
		0,
		0,
		2016,
		1064
	},
	alias = {}
},
```

##### 5. 创建关卡数据
在 `kr\data\levels` 创建 `levelX_data.lua` 文件，一位前导零，使用以下模板：
```lua
return {
    entities_list = {
        {
            template = "decal_background",	-- 背景贴图，背景本质也是实体
            pos = {
            	x = 512,
                y = 384
            },
            ["render.sprites[1].name"] = "stageX",	-- 与背景美术资源同名
            ["render.sprites[1].z"] = 1000
        },
        {
            template = "decal_background",	-- 防守点旗帜，可选
            pos = {
                x = -43.46875,
                y = 326.34375
            },
            ["render.sprites[1].name"] = "blue_flag",
            ["render.sprites[1].z"] = 1400
        },
        {
            template = "decal_background",
            pos = {
                x = -43.46875,
                y = 526.03125
            },
            ["render.sprites[1].name"] = "blue_flag",
            ["render.sprites[1].z"] = 1400
        },
        {
            template = "decal_defend_point",	-- 防守点，必加，否则进入将会报错
            ["editor.exit_id"] = 1,
            pos = {
                x = -44.875,
                y = 402.28125
            }
        },
        {
            template = "editor_wave_flag",	-- 释放波次按钮，必加，否则无法释放波次
            ["editor.len"] = 240,
            ["editor.path_id"] = 1,
            ["editor.r"] = 0,
            pos = {
                x = 1156.0625,
                y = 399.46875
            }
        },
    },
    invalid_path_ranges = {},
    level_mode_overrides = {
        {
            locked_towers = {},
            max_upgrade_level = 5
        },
        {
            locked_towers = {},
            max_upgrade_level = 5
        },
        {
            locked_towers = {},
            max_upgrade_level = 5
        }
    },
    level_terrain_type = 1,
    locked_hero = false,
    max_upgrade_level = 5,
    nav_mesh = {},
    required_sounds = {},	-- 音效资源
    required_textures = {
        "go_enemies_grass",		-- 一些敌人资源
        "go_stageX_bg",			-- 加载相应关卡背景资源
        "go_stages_blackburn"	-- 借用里面的防守点旗帜资源
    }
}
```

##### 4. 增加关卡
1. **将 `game_settings.last_level` 中的数字加 1**

2. **在 `level_ranges` 末尾增加一个关卡序号表，表内填增加的关卡序号 `{X}`**
`level_ranges` 作用见 [[5. 科技树与难度设定#2 关卡相关]]

3. **在 `kr-desktop\data\map_data.level_data` 末尾增加一个表，设定关卡选择界面显示的规则：**
```lua
{
	upgrades = {
		heroe = true,	-- 规则：是否有英雄
		level = 5		-- 规则：防御塔等级
	},
	iron = {			-- 钢铁规则：禁用的塔
		"archers",		-- 箭塔
		"barracks"		-- 兵营
		"mages",		-- 法师
		"artillery",	-- 炮塔
	}
}
```
![[Pasted image 20250809094524.png|190]]

4. **在 `kr-desktop/data/map_points.flags` 末尾增加一个表指定关卡的入口**
```lua
{
	number = "X",	-- 关卡编号
	pos = {
		x = 1173,	-- 位置
		y = 102
	}
}
```

## 10.2 设置塔位、路径等
##### 1. 进入关卡编辑器
将 `args` 启动参数的关卡编辑器取消注释，将 `custom` 键修改为刚刚创建的关卡编号
运行游戏即可进入关卡编辑器

关卡编辑器详细使用方法见[[第 2 节 - 修改基础/4. 关卡#4 4 关卡编辑器的使用]]

##### 2. 修改防守点的旗帜与防守点位置
点击 entities 选项，点击加号选中，拖动即可移动位置
![[Pasted image 20250807181638.png|900]]
防守点规定了英雄出生位置

##### 3. 增加塔位
搜索并选择样式，然后插入塔位
![[Pasted image 20250807183501.png]]

##### 4. 增加路径
点击 paths 选项然后创建路径
![[Pasted image 20250807182230.png]]
注：带数字的一端为起点，推荐将起点与终点设在关卡背景外

##### 5. 绘制网格
点击 grid 选项，选择地形然后绘制
![[Pasted image 20250807183059.png|725]]
网格规定了可更改集结点单位的可移动区域

##### 6. 方向键切换塔位
点击 nav 选项然后点击塔位调整 top / left / right / bottom
![[Pasted image 20250808185126.png|500]]
nav 规定了键盘方向键切换塔位的顺序

##### 7. 保存
一切完毕后点击 save 保存即可
此时会自动创建对应关卡路径与网格数据文件

## 10.3 增加波次
##### 1. 增加波次数据
使用波次编辑器编辑波次，重命名为  `levelX_waves_campaign` 复制到 `kr\data\waves` 中
注：不同后缀表示对应模式的波次数据，英雄为 \_heroic，钢铁为 \_iron，若没有则使用战役的波次数据

##### 2. 增加波次释放按钮
再次打开关卡编辑器插入 `editor_wave_flag` 的实体，修改位置即可
![[Pasted image 20250808090849.png]]
注：默认按钮是没有贴图的，需要找加号修改位置（加号默认在中心点偏下）
如果有多条路径则需要增加多个波次释放按钮

## 10.4 装饰
可以通过插入实体来创建一些动态贴图或可交互彩蛋
![[Pasted image 20250811184142.png|349]]
注：其他场景装饰实体自行在关卡编辑器查看，注意加载相应美术资源