
## 9.1 关卡界面
进入关卡后的所有视图，状态栏、能力栏、防御塔菜单等，统称为关卡界面（`all/game`）
其中视图为存放各种组件（按钮、文本等）的容器

关卡视图相关的类都在 `all-desktop/game_gui` 模块中（五代为 `sequels/game_gui`）。

### 9.1.1 防御塔菜单
防御塔菜单的数据位于 `kr/data/tower_menus_data` 中。

防御塔菜单数据通常用于 `TowerMenu` 与 `TowerMenuButton` 类中

##### 结构
```lua
{
	{	-- 二级的分支按钮
		check = 用于安卓的二次确认图标: str
		action_arg = 动作参数: any
		action = 动作名称: str
		halo = 边框名称: str
		image = 图标名称: str
		place = 位置索引: int
		tt_title = 标题文本: str
		tt_desc = 描述文本: str
		sounds = 播放的声音名称: str
	},
	{} 	-- 三级的分支按钮...
}
```
- `place` 读取 `kr1-desktop/data/game_gui_data` 中的 `tower_menu_button_places` 的位置信息

##### 示例
以一代炮塔为例
```lua
engineer = {
		{...},		-- 炮塔一级升级的分支按钮
		{...},		-- 炮塔二级升级的分支按钮
		{			-- 炮塔三级升级的分支按钮
			{		-- 大贝莎升级按钮
				action_arg = "tower_bfg",	-- 动作参数：大贝莎模板名
				action = "tw_upgrade",		-- 升级动作
				halo = "glow_ico_main",		-- 边框
				image = "main_icons_0013",	-- 大贝莎按钮图像样式
				place = 1,					-- 按钮位置
				tt_title = _("TOWER_BFG_NAME"),	-- 通过文本标识在国际化文本中查找文本
				tt_desc = _("TOWER_BFG_DESCRIPTION")
			},
			{		-- 电塔升级按钮
				action_arg = "tower_tesla",	-- 动作参数：电塔模板名
				action = "tw_upgrade",		-- 升级动作
				halo = "glow_ico_main",		-- 边框
				image = "main_icons_0012",	-- 电塔按钮图像样式
				place = 2,					-- 按钮位置
				tt_title = _("TOWER_TESLA_NAME"),
				tt_desc = _("TOWER_TESLA_DESCRIPTION")
			},
			{		-- 出售按钮
				action = "tw_sell",
				halo = "glow_ico_sell",
				image = "ico_sell_0001",	-- 出售按钮图像样式
				place = 9
			}
		}
	}
}
```

#### 1. 所有动作

|              |        |                  |         |
| ------------ | ------ | ---------------- | ------- |
| `tw_upgrade` | 升级按钮   | `tw_rally`       | 集结按钮    |
| `tw_unblock` | 塔位解锁按钮 | `upgrade_power`  | 技能升级按钮  |
| `tw_sell`    | 出售按钮   | `tw_change_mode` | 切换模式按钮  |
| `tw_point`   | 瞄准按钮   | `buy_soldier`    | 购买雇佣兵按钮 |

#### 2. 按钮位置数据
按钮数据位于 `kr1-desktop/data/game_gui_data` 的 `tower_menu_button_places` 中，索引对应相应位置（place）

```lua
tower_menu_button_places = {
	v(24, 20),		-- 位置 1 的坐标位置
	v(124, 20),		-- 位置 2 的坐标位置
	v(24, 120),		-- 位置 3 的坐标位置
	v(124, 120),	-- 位置 4 的坐标位置
	...
}
```

### 9.1.2 游戏加速减速
修改关卡界面更新函数与按键回调函数即可
```lua
function game:init(screen_w, screen_h, done_callback)
	-- 初始化速度倍数
	TIME_MULT = 1
end

function game:update(dt)
	-- 大于 1 加速
	if TIME_MULT > 1 then
		for i = 1, TIME_MULT do
			self.simulation:update(dt)
		end
	-- 小于 1 减速
	elseif TIME_MULT < 1 then
		local new_dt = dt * TIME_MULT

		self.simulation:update(new_dt)
	-- 调试快捷键 z（加速）控制 DBG_TIME_MULT
	elseif self.DBG_TIME_MULT then
		for i = 1, self.DBG_TIME_MULT do
			self.simulation:update(dt)
		end
	else
		self.simulation:update(dt)
	end
end

-- 键盘按下按键回调
function game:keypressed(key, isrepeat)
	-- 按下 9 加速三倍，8 减速到 0.1 倍
	if key == "9" then
		TIME_MULT = 3
	elseif key == "8" then
		TIME_MULT = 0.1
	end
end
```

### 9.1.3 常用按键回调
1. **keypressed**：键盘按键按下触发，传递：按键
2. **keyreleased**：键盘按键释放触发，传递：按键
3. **mousepressed**：鼠标按键按下触发，传递：点击位置 x，点击位置 y，按键
4. **mousereleased**：鼠标按键释放触发，传递：点击位置 x，点击位置 y，按键
5. **wheelmoved**：鼠标滚轮滑动触发，传递：水平滚动距离，垂直滚动距离

## 9.2 地图界面
地图上的所有视图，英雄殿堂、科技树、关卡选择等，统称为地图界面（**screen map**）

地图视图相关类都在 `all-desktop/screen_map` 模块中（五代为 `sequels/screen_map`）

### 9.2.1 地图数据

#### 1. 地图相关数据
数据位置： `kr-desktop/data/map_data`

存储各种地图数据，如地图动画、关卡规则、英雄殿堂等

#### 2. 旗帜与连接点
`kr-desktop/data/map_points`

#### 3. 通关后进入下一关的动画数据
`kr-desktop/data/map_animations_paths`

### 9.2.2 增加额外防御塔选择
注：本篇为五代特有

修改 `kr/data/kui_templates/group_towers_wheel` 增加一个新防御塔选择槽位
```lua
{
	template_name = "button_tower_ring_sel",	-- kui模板
	class = "TowerRingItemButton",	-- 续承的类
	r = 0,	-- 旋转
	id = "button_tower_ring_sel_06",	-- 序号
	pos = v(150, 250.5),	-- 位置
	scale = v(0.9999, 0.9999)	-- 缩放
}
```

修改 `sequels/kviews_screen_map_sequels.TowerRoomView:initialize` 函数增加槽位按钮
```lua
...
-- 通关第5关后将树灵增加选择的塔中，用于解锁额外选择槽位
if #user_data.towers.selected < 6 and #user_data.levels > 5 then
	table.insert(user_data.towers.selected, "arborean_emissary")	-- 填写模板名（无tower_前缀）
	storage:save_slot(user_data)
end
...

-- 正式创建槽位
self.roster_sel_items = {
	self:ci("button_tower_ring_sel_01"),
	...
	self:ci("button_tower_ring_sel_06")	-- 创建第六个防御塔选择槽位
}
self.roster_sel_positions = {
	V.vclone(self.roster_sel_items[1].pos),
	...
	V.vclone(self.roster_sel_items[6].pos)	-- 槽位位置
}
...
```

修改 `sequels/kviews_screen_map_sequels.game_gui:init` 函数部分，增加防御塔建造按钮
```lua
for i = 1, 6 do	-- 5改为6
	local tower_found = selected_holders[i]

	if tower_found then
		for _, holder in ipairs(tower_menus.holder[1]) do
			if holder.type == tower_found then
				holder.place = index
				index = index + 1
...
```

修改 `kr-desktop/data/game_gui_data` 的 `tower_menu_button_places` 键，修改防御塔建造按钮位置

其每个子键索引对应相应按钮的位置
```lua
tower_menu_button_places = {
	v(-92 * ring_scale, -146 * ring_scale),	-- 第一个按钮位置
	v(92 * ring_scale, -146 * ring_scale),	-- 第二个按钮位置...
	v(-153 * ring_scale, 31 * ring_scale),
	v(153 * ring_scale, 31 * ring_scale),
	v(0 * ring_scale, 155 * ring_scale),
	v(-150 * ring_scale, 165 * ring_scale),	-- 第六个按钮位置，修改这个
}
```

## 9.3 程序如何切换界面
1. **指定切换的界面**：切换界面时会调用 `director:item_done_callback` 回调函数指定切换的界面
2. **进入加载界面中转**：然后在 `director:update` 更新函数内检查有没有要切换的界面如果有则调用 `director:queue_load_item_named` 函数进入加载界面中转，否则调用相应界面的更新函数
3. **调用初始化函数**：最后调用相应界面的 `init` 初始化函数并加载需要的资源，正式进入相应界面
4. **调用更新函数**：开始调用界面的更新函数，通过更新函数调用主窗口的更新函数，通过其更新子视图（`KView:update`）

## 9.4 基础类
所有类见 [[15. 类#类]]

#### 1. KView - 视图基类
**主要作用**：所有可视 UI 组件的基类，提供渲染和布局功能
- 位置、尺寸、缩放、旋转控制
- 颜色、透明度管理
- 裁剪支持
- 动画系统
- 鼠标/触摸事件命中检测
- 坐标转换（屏幕↔视图）
- 子视图管理

**使用场景**：创建任何可视 UI 元素的基础

#### 2. KImageView - 图像视图
**主要作用**：显示图像的简单视图
- 加载和显示图像
- 图像缩放
- 基本的图像按钮功能

**使用场景**：显示静态图片或简单图像按钮

#### 3. KLabel - 文本标签
**主要作用**：显示文本的视图
- 字体管理
- 文本对齐（左/中/右）
- 多行文本支持
- 文本颜色

**使用场景**：显示文字信息

#### 4. KButton - 按钮基类
**主要作用**：交互式按钮的抽象基类
- 按钮状态管理（默认/悬停/按下）
- 点击事件处理
- 事件传播控制

**使用场景**：创建可交互按钮

#### 5. KImageButton - 图像按钮
**主要作用**：使用不同图像表示状态的按钮
- 为不同状态（正常/悬停/按下）使用不同图像
- 自动状态切换
- 键盘支持（回车键触发）

**使用场景**：游戏中的图片按钮

### 6. 核心继承链
![[Pasted image 20260102101529.png|650]]

## 9.5 增加文本
#### 9.5.1 基础文本 KLabel
仅显示文本，无法进行交互，支持水平对齐（水平居中、两端对齐、左对齐、右对齐）

![[Pasted image 20260102191100.png]]
```lua
-- 修改 game_gui 初始化函数
function game_gui:init(w, h, game)
	-- 增加到末尾
	-- 创建基础文本，new 的参数为文本大小
	label_text = KLabel:new(V.v(50, 50))
	-- 位置，屏幕中心
	label_text.pos = V.v(self.sw / 2, self.sh / 2)
	-- 显示的文本
	label_text.text = "文本"
	-- 文本水平对齐：水平居中
	label_text.text_align = "center"
	-- 字体别名
	label_text.font_name = "body"
	-- 字体大小
	label_text.font_size = 15
	-- 字体颜色：绿色
	label_text.colors.text = {
		0,
		255,
		0,
		200
	}
	-- 背景颜色：半透明黑色
	label_text.colors.background = {
		0,
		0,
		0,
		20
	}
	
	-- 增加到 layer_gui_hud 视图中
	self.layer_gui_hud:add_child(label_text)
	self.label_text = label_text
end
```

### 9.5.2 标准文本 GGLabel
由于基础文本的纯色文本过于模糊，所以需要使用增强版的标准文本来增加阴影等

续承自父类 KLabel，字体大小自适应缩放，具有文本阴影、垂直对齐（上/中/下/基线）等


| ![[Pasted image 20260102191100.png]] 使用前 | ![[Pasted image 20260102194442.png\|246]] 使用后 |
| ---------------------------------------- | --------------------------------------------- |

```lua
label_text = GGLabel:new(V.v(50, 50))
-- 是否自适应字体大小
label_text.fit_size = false
-- 启用阴影
label_text.text_shadow = true
-- 垂直对齐：居中对齐
label_text.vertical_align = "middle"
-- 其他与基础文本完全相同
```

### 9.5.3 水平对齐
#### 1. `"center"` - 水平居中
- **效果**：文本行的**中心点**与容器的**中心点**对齐。
```
|       Hello World        |
 ^^^      文本居中       ^^^
```

#### 2. `"justify"` - 两端对齐
- **效果**：除了最后一行，文本的**左边缘和右边缘**分别与容器的左右边缘整齐对齐
```
|Hello World, this is a   |
|long justified text      |
|example                  |
 ^第一、二行左右都对齐     ^^
```

#### 3. `"left"` - 左对齐
- **效果**：文本的**左边缘**与容器的**左边缘**对齐，右侧参差不齐。
```
|Hello Lua World, this        |
|is along left-aligned text   |
|example.                     |
 左侧整齐，右侧不齐             ^
```

#### 4. `"right"` - 右对齐
- **效果**：文本的**右边缘**与容器的**右边缘**对齐，左侧参差不齐。
```
|        Hello World, this|
|  is a long right-aligned|
|                 example.|
 ^ 左侧不齐，右侧整齐
```

### 9.5.4 垂直对齐
#### 1. `"middle"` - 垂直居中
- **效果**：将整个文本的边界框在容器中垂直居中

```
┌─────────────┐ ← 容器顶部
│             │
│  Hello World│ ← 文本居中（基于边界框）
│             │
└─────────────┘ ← 容器底部
```

#### 2. `"middle-caps"` - 垂直居中
**效果**：考虑下行字母，使大写字母区域在视觉上居中.
```
┌─────────────┐
│             │
│  Hello World│ ← 大写字母区域居中
│   gyjpq     │ ← 下行字母向下延伸
└─────────────┘
```

#### 3. `"bottom"` - 底部对齐（基于文本边界框）
**效果**：文本的底部与容器底部对齐
```
┌─────────────┐
│             │
│             │
│  Hello World│ ← 文本底部对齐容器底部
└─────────────┘
```

#### 4. `"bottom-caps"` - 底部对齐
**效果**：大写字母的底部与容器底部对齐，下行字母会超出容器
```
┌─────────────┐
│             │
│             │
│  HELLO WORLD│ ← 大写字母底部对齐
└───gyjpq─────┘← 下行字母超出容器
```

#### 5. `"base"` - 基线对齐
**效果**：文本的基线与某个参考线对齐。
```
┌─────────────┐
│  Hello World│ ← 基线对齐某个位置
│   gyjpq     │
└─────────────┘
      ↑ 基线（字符对齐的参考线）
```

## 9.6 增加按钮
### 9.6.1 基础按钮 KButton
按钮用于可视化与鼠标按键、键盘交互

续承自 KLabel

![[Pasted image 20260102145432.png|575]]
以增加游戏加速按钮为例：
```lua
-- 修改 game_gui 初始化函数
function game_gui:init(w, h, game)
	-- 增加到末尾
	-- 创建按钮，new 参数为按钮大小
	speed_button = KButton:new(V.v(50, 50))
	speed_button.pos = V.v(self.sw / 2, self.sh / 2)
	speed_button.text = "3X speed"
	speed_button.text_align = "center"
	speed_button.font_name = "body"
	speed_button.font_size = 15
	-- 文本颜色：红色
	speed_button.colors.text = {
		255,
		0,
		0,
		200
	}
	-- 按钮背景颜色：黑色半透明
	speed_button.colors.background = {
		0,
		0,
		0,
		20
	}

	-- 鼠标按键事件
	function speed_button:on_click(button, x, y)
		-- 点击按钮加速再次点击恢复
		TIME_MULT = TIME_MULT == 3 and 1 or 3
	end

	-- 增加到视图容器 layer_gui_hud 中
	self.layer_gui_hud:add_child(speed_button)
	self.speed_button = speed_button
end
```

#### 1. 常用按钮事件
1. **on_click**：鼠标按键释放触发，传递参数同鼠标按键回调，坐标经过转换（`screen_to_view`）
2. **on_enter**：鼠标光标悬浮到按钮上触发
3. **on_exit**：鼠标光标离开按钮上触发

#### 2. 增加更多功能
左键加速右键减速，并修改显示的文本
```lua
speed_button.text = "左键加速右键减速"
speed_button.font_size = 12

function speed_button:on_click(button, x, y)
	local function set_time_mult(mult, text)
		if TIME_MULT == mult then
			TIME_MULT = 1
			self.text = "左键加速右键减速"
		else
			TIME_MULT = mult
			self.text = text
		end
	end

	if button == 1 then
		set_time_mult(3, "3 倍加速中")
	elseif button == 2 then
		set_time_mult(0.1, "10 倍减速中")
	end
end
```

#### 3. 显示图像
![[Pasted image 20260102191255.png]]
```lua
-- new 第二个参数指定图像名称即可
-- 调用 new 实例化对象会调用 KButton:initialize 函数
speed_button = KButton:new(V.v(50, 50), "achievement_icons_0026")
-- speed_button.colors.background 背景颜色会同时应用给图像
```
显示图像功能来自父类 KImageView

achievement_icons_0026：
![[Pasted image 20260102155540.png]]

可以拆分 achievements 与 gui_common 图集使用里面的素材

### 9.6.2 图像按钮 KImageButton
如上基础按钮图像只能显示一种静态图像，如果需要根据按键按下或鼠标光标悬停时显示不同图像就需要使用 KImageButton

续承自父类 KButton，根据不同状态（正常/鼠标光标悬停/按键按下）使用不同图像

大小默认为图像大小

| ![[Pasted image 20260102210952.png]] 正常 | ![[Pasted image 20260102211012.png\|180]] 光标悬停 |
| -------------------------------------- | ---------------------------------------------- |

```lua
KImageButton:new(正常图像名: str, 悬停图像名: str, 按下图像名: str, 禁用状态图像名: str)
```

```lua
-- 没有按下跳动效果，推荐直接使用 GGButton 标准按钮
speed_button = KImageButton:new("button_border_0001", "button_border_0002")
-- 文本偏移，确保文本在按钮中心
speed_button.text_offset = V.v(0, speed_button.size.y / 4)
speed_button.text_align = "center"
```

### 9.6.3 标准按钮 GGButton
游戏中的标准按钮，鼠标按键按下时缩放按钮（跳动效果）

续承自父类 KImageView

### 9.6.4 KView 的常用键

| 键                | 描述  | 键               | 描述   |
| ---------------- | --- | --------------- | ---- |
| `pos = vec2`     | 位置  | `scale = vec2`  | 缩放   |
| `size = vec2`    | 大小  | `r = num`       | 旋转弧度 |
| `padding = vec2` | 边距  | `hidden = bool` | 是否隐藏 |
| `anchor = vec2`  | 锚点  | `alpha = 0-1`   | 透明度  |

## 9.7 增加窗口
### 9.7.1 弹出视图 PopUpView
续承自 KView，额外增加了隐藏显示时的动画效果

以在地图界面增加一个设置窗口，可配置敌人属性为例

#### 1. 创建视图

| ![[Pasted image 20260103142735.png\|400]] | ![[Pasted image 20260103142802.png\|475]] |
| ----------------------------------------- | ------------------------------------ |

```lua
function screen_map:init(w, h, done_callback)
	-- 增加入口按钮
	local enemy_config_button = KImageButton:new("map_configBtn_0001", "map_configBtn_0002", "map_configBtn_0003")
	enemy_config_button.anchor = v(enemy_config_button.size.x / 2, enemy_config_button.size.y / 2)
	enemy_config_button.pos = v(80, 180)

	function enemy_config_button:on_click(button, x, y)
		-- 播放声音
		S:queue("GUIButtonCommon")
		-- 显示配置视图
		screen_map.enemy_config_view:show()
	end

	-- 增加到地图界面的主窗口中
	self.window:add_child(enemy_config_button)
	self.enemy_config_button = enemy_config_button

	-- 创建配置视图
	enemy_config_view = EnemyConfigView:new(self.sw, self.sh)

	self.window:add_child(enemy_config_view)
	self.enemy_config_view = enemy_config_view
end

-- 增加一个新类
EnemyConfigView = class("EnemyConfigView", PopUpView)

-- new 实例化时会调用 initialize
function EnemyConfigView:initialize(sw, sh)
	-- 调用父类的初始化函数，注意：使用点号调用，传递 self（EnemyConfigView）
	PopUpView.initialize(self, V.v(sw, sh))
	
	-- 创建背景
	self.pos = v(0, 0)
	local back = KImageView:new("options_bg_notxt")
	back.anchor = v(back.size.x / 2, back.size.y / 2)
	back.pos = v(sw / 2, sh / 2 - 50)

	self:add_child(back)
	self.back = back
end
```

#### 2. 向配置视图增加按钮
```lua
function EnemyConfigView:initialize(sw, sh)
	-- 标题文本
	local header = GGPanelHeader:new("敌人配置", 242)
	
	header.pos = V.v(240, 39)
	
	-- 增加到背景视图
	back:add_child(header)
	
	-- 完成按钮，复用科技视图的按钮
	local done_button = GGUpgradesButton:new("完成")
	done_button.pos = v(515, 490)
	
	-- 点击事件：隐藏配置视图
	function done_button.on_click()
		S:queue("GUIButtonCommon")
		self:hide()
	end
	
	back:add_child(done_button)
	self.done_button = done_button
	
	-- 初始化存档数据
	local slot = storage:load_slot()
	
	if not slot.enemy_config then
		slot.enemy_config = {
			enemy_health_factor = 1
		}
	
		storage:save_slot(slot)
	end
	
	-- 调整敌人血量倍率按钮
	local health_button = GGButton:new("difficulty_select_bg")
	health_button.pos = V.v(back.size.x / 2 + 50, back.size.y / 2 + 20)
	
	-- 使用点号调用，用于区分 health_button（this）与 EnemyConfigView（self）实例
	function health_button.on_click(this, button, vx, vy)
		local config = slot.enemy_config
	
		-- 点击按钮左侧降低生命倍率，反之增加
		if vx < this.pos.x / 4 then
			-- 减少生命值倍率，截断小数
			config.enemy_health_factor = string.format("%.1f", config.enemy_health_factor - 0.1)
		else
			-- 增加生命值倍率
			config.enemy_health_factor = string.format("%.1f", config.enemy_health_factor + 0.1)
		end
		
		-- 保存到存档
		storage:save_slot(slot)
	
		-- 更新显示数值
		self.health_num_label.text = config.enemy_health_factor
	
		local enemy_hp_factor = GS.difficulty_enemy_hp_max_factor
		
		-- 通过游戏设定修改敌人血量
		for i, hp_factor in ipairs(enemy_hp_factor) do
			enemy_hp_factor[i] = config.enemy_health_factor
		end
	end
	
	back:add_child(health_button)
	self.health_button = health_button
	
	-- 左侧显示文本
	local health_label = EnemyConfigLabel:new(V.v(back.size.x / 2 - 175, back.size.y / 2 + 6), "敌人血量倍率")
	
	back:add_child(health_label)
	self.health_label = health_label
	
	-- 显示生命倍率数字
	local health_num_label = EnemyConfigNumberLabel:new(V.v(back.size.x / 2 + 50, back.size.y / 2),
		slot.enemy_config.enemy_health_factor)
	
	back:add_child(health_num_label)
	self.health_num_label = health_num_label
end

-- 敌人配置专用文本样式
EnemyConfigLabel = class("EnemyConfigLabel", GGOptionsLabel)

function EnemyConfigLabel:initialize(pos, text)
	GGOptionsLabel.initialize(self, V.v(200, 38))
	self.pos = pos
	self.anchor.x = self.size.x / 2
	self.text = text
	self.vertical_align = "middle"
	self.text_align = "center"
	self.propagate_on_click = true
	self.fit_size = true
end

-- 敌人配置数字专用文本样式
EnemyConfigNumberLabel = class("EnemyConfigNumberLabel", GGLabel)

function EnemyConfigNumberLabel:initialize(pos, text)
	GGLabel.initialize(self, V.v(220, 46))
	self.pos = pos
	self.anchor.x = self.size.x / 2
	self.vertical_align = "middle"
	self.text_align = "center"
	self.font_name = "body"
	self.font_size = 24
	self.text = text
	self.colors.text = {
		214,
		189,
		131
	}
	self.colors.text_default = {
		214,
		189,
		131
	}
	self.colors.text_hover = {
		255,
		223,
		0
	}
	self.fit_size = true
end
```

#### 3. 批量创建配置按钮
如上增加一个配置按钮很简单，多个配置按钮就需要批量创建了

![[Pasted image 20260104103221.png|500]]
```lua
-- 配置界面初始化函数，在以上基础上修改
function EnemyConfigView:initialize(sw, sh)
	...
	local all_config = {
		enemy_health_factor = "敌人血量倍率",
		enemy_speed_factor = "敌人速度倍率",
		enemy_damage_factor = "敌人伤害倍率"
	}
	
	self.items_num_labels = {}
	-- 起始位置
	local start_pos = V.v(back.size.x / 2 + 35, back.size.y / 2 - 100)
	local config = slot.enemy_config
	
	-- 计数
	local i = 0
	for key, value in pairs(all_config) do
		i = i + 1
	
		-- 根据计数设定位置，避免叠加在一起
		-- 这里没有处理超出配置视图换列的情况，可以自行增加
		local current_pos_y = start_pos.y + (i - 1) * 80
	
		local item_button = GGButton:new("difficulty_select_bg")
		item_button.pos = V.v(start_pos.x + 50, current_pos_y + 22)
	
		function item_button.on_click(this, button, vx, vy)
			if vx < this.pos.x / 4 then
				config[key] = string.format("%.1f", config[key] - 0.1)
			else
				config[key] = string.format("%.1f", config[key] + 0.1)
			end
	
			storage:save_slot(slot)
	
			self.items_num_labels[key].text = config[key]
		end
	
		back:add_child(item_button)
	
		local item_label = EnemyConfigLabel:new(V.v(start_pos.x - 170, current_pos_y), value)
	
		back:add_child(item_label)
	
		local item_num_label = EnemyConfigNumberLabel:new(V.v(start_pos.x + 50, current_pos_y),
			config[key])
	
		back:add_child(item_num_label)
	
		-- 用于点击事件后续索引
		self.items_num_labels[key] = item_num_label
	end
end
```

#### 4. 统一修改模板
```lua
-- 向 utils 增加工具函数
---应用倍率，根据返回应用倍率的表或数值
---@param t table|number 目标表或数值
---@param factor number 因子
---@param is_int? boolean 是否向上取整
---@return boolean 是否成功
function U.apply_factor(t, factor, is_int)
	local t_type = type(t)
	local value = t_type == "table" and {} or t

	-- 处理表的情况
	if t_type == "table" then
		-- 高性能遍历
		for i = 1, #t do
			local v = t[i]

			if is_int then
				value[i] = math.ceil(v * factor)
			else
				value[i] = v * factor
			end
		end
	-- 处理数字的情况
	elseif t_type == "number" then
		if is_int then
			return math.ceil(value * factor)
		else
			return value * factor
		end
	end

	return value
end

-- 修改 E 的函数
local storage = require("storage")

function entity_db:load()
	...
	-- 末尾
	local slot = storage:load_slot()
	local config = slot.enemy_config

	-- 筛选并遍历所有敌人模板（具有敌人组件的模板）
	for _, e in pairs(self:filter_templates("enemy")) do
		-- 应用敌人血量倍率，抛弃通过游戏设定修改血量，因为退出关卡手动恢复之前的血量倍率麻烦，并且覆盖了难度的血量倍率，E:load 每次退出关卡都会重置所有模板（重新加载模块）
		if e.health then
			-- 使用工具函数处理如果值是表或数字的情况
			e.health.hp_max = U.apply_factor(e.health.hp_max, config.enemy_health_factor, true)
		end

		-- 应用敌人速度倍率
		if e.motion then
			e.motion.max_speed = U.apply_factor(e.motion.max_speed, config.enemy_speed_factor)
		end

		-- 应用敌人伤害倍率
		-- 这里仅处理近战攻击，可以写一个工具函数为技能、近战攻击、远程攻击应用倍率
		if e.melee then
			for _, a in ipairs(e.melee.attacks) do
				a.damage_min = U.apply_factor(a.damage_min, config.enemy_damage_factor, true)
				a.damage_max = U.apply_factor(a.damage_max, config.enemy_damage_factor, true)
			end
		end
	end
end
```

#### 5. 图层问题
点击进入其他视图可能会出现配置入口按钮无法隐藏（变灰）的问题，这是按钮图层高于其他视图导致的
![[Pasted image 20260103144631.png|650]]
统一与其他按钮一同创建即可，创建顺序决定图层
```lua
-- 统一在一个地方创建按钮
local u_button = GGButton:new("mapButtons-notxt_0010", "mapButtons-notxt_0011")
...
local h_button = GGButton:new("mapButtons-notxt_0001", "mapButtons-notxt_0002")
...

-- 创建配置入口
local enemy_config_button = KImageButton:new("map_configBtn_0001", "map_configBtn_0002", "map_configBtn_0003")
enemy_config_button.anchor = v(enemy_config_button.size.x / 2, enemy_config_button.size.y / 2)
enemy_config_button.pos = v(80, 180)

function enemy_config_button:on_click(button, x, y)
	S:queue("GUIButtonCommon")
	screen_map.enemy_config_view:show()
end

self.window:add_child(enemy_config_button)
self.enemy_config_button = enemy_config_button
```