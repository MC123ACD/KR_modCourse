
## 7.1 关卡界面
进入关卡后的所有界面，能力按钮、英雄肖像等，统称为关卡界面（**game gui**）

地图界面的相关类都在 `all-desktop/game_gui` 中（五代为 `sequels/game_gui`）。

### 7.1.1 防御塔菜单数据
防御塔菜单的数据位于 `kr/data/tower_menus_data` 中。

防御塔菜单数据通常用于 `TowerMenu` 与 `TowerMenuButton` 类中

#### 结构
```lua
{
	{	-- 二级的按钮
		check = 用于安卓的二次确认图标: str
		action_arg = 动作参数: any
		action = 动作名称: str
		halo = 边框名称: str
		image = 图标名称: str
		place = 位置索引: int
		tt_title = 标题文本: str
		tt_desc = 描述文本: str
		sounds = 播放的声音名称: str
	},
	{} 	-- 三级的按钮...
}
```
- `place` 读取 `kr1-desktop/data/game_gui_data` 中的 `tower_menu_button_places` 的位置信息

#### 所有动作

|              |        |                  |         |
| ------------ | ------ | ---------------- | ------- |
| `tw_upgrade` | 升级按钮   | `tw_rally`       | 集结按钮    |
| `tw_unblock` | 塔位解锁按钮 | `upgrade_power`  | 技能升级按钮  |
| `tw_sell`    | 出售按钮   | `tw_change_mode` | 切换模式按钮  |
| `tw_point`   | 瞄准按钮   | `buy_soldier`    | 购买雇佣兵按钮 |

## 7.2 地图界面
地图上的所有界面，英雄殿堂，科技等，统称为地图界面（**screen map**）

地图界面的相关类都在 `all-desktop/screen_map` 中（五代为 `sequels/screen_map`）。

### 7.2.1 增加额外防御塔选择
注：本篇为五代特有

修改 `kr/data/kui_templates/group_towers_wheel` 增加一个新防御塔选择槽位
```lua
{
	template_name = "button_tower_ring_sel",	-- kui模板
	class = "TowerRingItemButton",	-- 续承的类
	r = 0,	-- 旋转
	id = "button_tower_ring_sel_06",	-- 序号
	pos = v(150, 250.5),	-- 位置
	scale = v(0.9999, 0.9999)	-- 缩放
}
```

修改 `sequels/kviews_screen_map_sequels.TowerRoomView:initialize` 函数增加槽位按钮
```lua
...
-- 通关第5关后将树灵增加选择的塔中，用于解锁额外选择槽位
if #user_data.towers.selected < 6 and #user_data.levels > 5 then
	table.insert(user_data.towers.selected, "arborean_emissary")	-- 填写模板名（无tower_前缀）
	storage:save_slot(user_data)
end
...

-- 正式创建槽位
self.roster_sel_items = {
	self:ci("button_tower_ring_sel_01"),
	...
	self:ci("button_tower_ring_sel_06")	-- 创建第六个防御塔选择槽位
}
self.roster_sel_positions = {
	V.vclone(self.roster_sel_items[1].pos),
	...
	V.vclone(self.roster_sel_items[6].pos)	-- 槽位位置
}
...
```

修改 `sequels/kviews_screen_map_sequels.game_gui:init` 函数部分，增加防御塔建造按钮
```lua
for i = 1, 6 do	-- 5改为6
	local tower_found = selected_holders[i]

	if tower_found then
		for _, holder in ipairs(tower_menus.holder[1]) do
			if holder.type == tower_found then
				holder.place = index
				index = index + 1
...
```

修改 `kr-desktop/data/game_gui_data` 的 `tower_menu_button_places` 键，修改防御塔建造按钮位置

其每个子键索引对应相应按钮的位置
```lua
tower_menu_button_places = {
	v(-92 * ring_scale, -146 * ring_scale),	-- 第一个按钮位置
	v(92 * ring_scale, -146 * ring_scale),	-- 第二个按钮位置...
	v(-153 * ring_scale, 31 * ring_scale),
	v(153 * ring_scale, 31 * ring_scale),
	v(0 * ring_scale, 155 * ring_scale),
	v(-150 * ring_scale, 165 * ring_scale),	-- 第六个按钮位置，修改这个
}
```

## 7.3 程序如何切换界面
1. **指定切换的界面**：切换界面时会调用 `director:item_done_callback` 回调函数指定切换的界面
2. **进入加载界面中转**：然后在 `director:update` 更新函数内检查有没有要切换的界面如果有则调用 `director:queue_load_item_named` 函数进入加载界面中转
3. **调用初始化函数**：最后调用相应界面的 `init` 初始化函数并加载需要的资源
