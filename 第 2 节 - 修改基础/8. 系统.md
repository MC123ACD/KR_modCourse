## 8.1 系统
系统模块位于 `all/systems` 是游戏运行逻辑的关键部分，控制实体函数、精灵显示、处理实体死亡等。

### 8.1.1 所有系统
1. 关卡系统 level
2. 波次生成系统 wave_spawn
3. 防御塔升级系统 tower_upgrade
4. 科技树系统 game_upgrades
5. 实体函数系统 main_script
6. 血量系统 health
7. 精灵系统 render
8. ...

**系统的函数又分为**：
1. 初始化 init
2. 入列 on_queue
3. 出列 on_dequeue
4. 插入 on_insert
5. 更新 on_update
6. 移除 on_remove

```lua
-- 实体函数系统
sys.main_script = {}
sys.main_script.name = "main_script"

-- 入列
function sys.main_script:on_queue(entity, store, insertion)
	...
end

-- 出列
function sys.main_script:on_dequeue(entity, store, insertion)
	...
end

-- 插入
function sys.main_script:on_insert(entity, store)
	...
end

-- 更新
function sys.main_script:on_update(dt, ts, store)
	...
end

-- 移除
function sys.main_script:on_remove(entity, store)
	...
end
```

## 8.2 所有系统介绍
### 1. level 关卡系统

**作用**：管理游戏关卡的初始化、更新并检测胜利/失败

- 初始化关卡数据（加载网格、路径、波次等）
- 跟踪游戏状态（生命、金币、宝石）
- 处理游戏胜利/失败逻辑
- 管理英雄生成

**关键函数**：
```lua
function sys.level:init(store)  -- 初始化关卡
function sys.level:on_update(dt, ts, store)  -- 每帧更新
```

### 2. wave_spawn 波次生成系统
**作用**：管理敌人波次的生成和时间安排
- 按配置生成敌人波次
- 处理波次间的时间间隔
- 支持无尽模式的特殊逻辑
- 管理宝石生成和奖励计算

**关键函数**：
```lua
function sys.wave_spawn:init(store)  -- 初始化波次生成器
function sys.wave_spawn:on_update(dt, ts, store)  -- 更新波次逻辑
function spawner(store, wave)  -- 内部函数：实际生成敌人
```

### 3. mod_lifecycle 状态效果生命周期系统
**作用**：管理实体上的状态效果
- 处理状态效果的叠加规则
- 管理状态效果的冲突和替换
- 跟踪状态效果的时间戳

**关键逻辑**：
- 禁止重复状态效果（除非允许重复）
- 高级别状态效果替换低级别
- 相同级别状态效果重置时间

### 4. tower_upgrade 防御塔升级系统
**作用**：处理防御塔的升级、出售和建造
- 管理防御塔的升级逻辑
- 处理防御塔出售的退款
- 生成建造/出售特效
- 同步士兵数据到升级后的防御塔

**关键特性**：
- 炮塔升级保留攻击冷却
- 兵营升级同步士兵位置和状态
- 生成灰尘特效

### 5. game_upgrades 科技系统
**作用**：管理全局游戏科技效果
- 应用升级效果到实体模板
- 特别处理法师塔的协同效果
- 动态调整伤害值

**核心机制**：
- 法师塔的 "辉光" 科技：法师塔越多，每座塔伤害越高
- 实时修改子弹模板的伤害值

### 6. main_script 主脚本系统
**作用**：为实体提供自定义脚本功能
- 调度实体的协程
- 管理脚本的生命周期
- 调用插入/更新/移除函数

### 7. health 血量系统
**作用**：管理实体的血量和伤害计算
- 处理伤害队列
- 计算实际伤害（考虑护甲、魔法抗性）
- 管理实体死亡逻辑
- 处理伤害类型和免疫

**核心机制**：
- 支持多种伤害类型（物理、魔法、真实伤害等）
- 护甲和魔抗减伤计算
- 反伤机制
- 经验值和击杀奖励分配

### 8. count_groups 计数组系统
**作用**：跟踪不同类型的实体数量
- 管理并发实体计数（如同时存在的敌人）
- 管理累计实体计数（如总共杀敌数）
- 发送数量变化信号

**计数类型**：
- `COUNT_GROUP_CONCURRENT`：当前存在的数量
- `COUNT_GROUP_CUMULATIVE`：累计数量

### 9. heroxptracking 英雄经验跟踪系统
**作用**：跟踪英雄获得的经验值
- 基于伤害计算经验值
- 支持经验值分配因子
- 排队经验值以便后续处理

### 10. pops 弹出效果系统
**作用**：在伤害发生时生成弹出效果
- 生成伤害数字、暴击标志等
- 支持概率生成和条件生成
- 自动定位到目标或源实体

### 11. timed 定时系统
**作用**：管理具有时间限制的实体
- 基于时间或动画循环次数移除实体
- 用于一次性效果（如爆炸、灰尘）

### 12. tween 补间动画系统
**作用**：为实体属性提供平滑动画
- 支持多个属性的同时动画
- 多种插值函数（线性、二次、正弦）
- 支持循环和反向播放

**支持的属性**：
- 位置、旋转、缩放、透明度等
- 支持布尔值和向量插值

### 13. goal_line 终点线系统
**作用**：检测敌人到达终点
- 检查敌人的路径节点索引
- 敌人到达终点时扣除玩家生命
- 移除到达终点的敌人

### 14. texts 文本系统
**作用**：动态创建和显示文本
- 将文本渲染为图像
- 支持字体、颜色、对齐
- 自动清理临时图像

### 15. particle_system 粒子系统
**作用**：高级粒子效果生成
- 支持发射率、速度、旋转变化
- 生命周期内的属性插值
- 支持跟踪其他实体
- 性能优化的粒子池管理

### 16. render 渲染系统
**作用**：管理所有实体的视觉渲染
- 创建和更新渲染帧
- 处理动画播放
- 管理血条显示
- 渲染排序（基于 Z 轴和 Y 位置）

**核心功能**：
- 精灵动画支持
- 血条动态缩放
- 使用插入排序进行渲染优化

### 17. sound_events 声音事件系统
**作用**：管理实体的声音播放
- 实体插入/移除时播放声音
- 支持停止特定声音
- 传递声音参数

### 18. seen_tracker 已见跟踪系统
**作用**：跟踪玩家见过的实体类型
- 首次见到塔楼或敌人时记录
- 用于教程和成就系统
- 自动保存到存档

### 19. dbgenemytracker 调试敌人跟踪系统
**作用**：调试用途的敌人统计
- 跟踪敌人插入、移除、击杀、到达终点数量
- 验证敌人移除的合法性

### 20. editor_overrides 关卡编辑器覆盖系统
**作用**：为关卡编辑器添加的实体提供特殊处理
- 应用关卡编辑器指定的组件
- 覆盖实体属性值

### 21. editor_script 关卡编辑器脚本系统
**作用**：运行关卡编辑器定义的脚本
- 类似于 `main_script`，但专门用于关卡编辑器创建的实体
- 支持协程