## 1.1 游戏介绍
《王国保卫战》（**Kingdom Rush**）是由乌拉圭的 Ironhide Game Studio 游戏工作室于 2011 年制作的一款塔防类策略游戏。

游戏使用 ECS（**Entity-Component-System**）实体-组件-系统架构

它通过将**数据**（组件）和**行为**（系统）解耦，并用**实体**将它们灵活地组合起来，为游戏开发带来了一种高性能、高弹性且易于管理的代码组织方式。

## 1.2 游戏自带的完整开发环境
### 1.2.1 增加多个库，并扩展 table 库（详见 lib 目录）：
1. table 库额外增加深浅拷贝、深浅合并、高阶函数等
2. 增加 vector 向量库
3. 增加 macros 宏指令库
4. 增加 class 模拟类库
5. 增加 signal 信号库
6. 增加 timer 定时器库
7. 增加 log 日志库

## 1.3 调试功能

### 1.3.1 监视变量
注：只有触发断点时监视才可用

| <center>变量</center>             | <center>描述</center>          |
| ------------------------------- | ---------------------------- |
| `game.game_gui.selected_entity` | **被鼠标选中的单位的表会显示在内**          |
| `game.store`                    | **临时的表等（创建的实体等都在内）**         |
| `game.game_gui`                 | **游戏 GUI（进入关卡后的技能、金币、生命等）**  |
| `screen_map`                    | **地图的 UI 与 GUI 等（英雄殿堂、升级等）** |

![[Pasted image 20250621105918.png|450]]

### 1.3.2 游戏内的调试快捷键

|          快捷键           | **<center>功能</center>** |          快捷键          | **<center>功能</center>**    |
| :--------------------: | ----------------------- | :-------------------: | -------------------------- |
|          `/`           | **禁用调试快捷键**             |     `Shift` + `l`     | **降低 100 生命**              |
|          `a`           | **暂停程序**                |          `n`          | **跳过这一波，同时秒杀所有敌人**         |
|          `s`           | **暂停后步进一次**             |     `Shift` + `n`     | **显示防御塔位创建顺序**             |
|          `d`           | **秒杀鼠标选中实体**            |          `m`          | **增加 1000 金币**             |
|     `Shift` + `d`      | **选中单位血量设置为 10 %**      |     `Shift` + `m`     | **降低 1000 金币**             |
|      `Ctrl` + `d`      | **选中单位血量回满**            |           `           | **显示控制台**                  |
| `Shift` + `Ctrl` + `d` | **删除选中的实体**             | `q w e r t y u i o p` | **显示控制台后，召唤对应敌人**          |
|          `g`           | **显示网格**                |          `j`          | **切换召唤路径**                 |
|          `h`           | **显示路径 / 高亮当前路径**       |         `[ ]`         | **敌人列表上一页/下一页**            |
|          `z`           | **游戏速度 × 2**            |          `=`          | **启用控制台连续出怪**              |
|     `Shift` + `z`      | **游戏速度 ÷ 2**            |         `+ -`         | **设置连续出怪间隔**               |
|          `x`           | **英雄获得 500 经验**         |          `;`          | **是否从随机子路径召唤**             |
|          `c`           | **显示所有实体的锚点与点击框**       |     `Shift` + `;`     | **是否移除所有状态修改**             |
|     `Shift` + `c`      | **高亮攻击轨迹**              |          `,`          | **统计进入关卡后的时间**             |
|          `v`           | **技能冷却时间清零**            |          `.`          | **统计自第一次按这个按键到这次的时间，逗号重置** |
|          `b`           | **高亮各种范围（攻击范围等）**       |       `F9 F10`        | **降低/增加敌人速度，需要重新开始关卡**     |
|          `l`           | **增加 100 生命，不超过 1000**  |                       |                            |

#### 五代特有
**点击左上角金币图标，即可开启有 UI 的调试**（功能与快捷键相同）
![[Pasted image 20250620190901.png|600]]

|     快捷键      | 功能    |
| :----------: | ----- |
|     `F5`     | **伤害显示**  |
|     `F8`     | **隐藏 UI** |
|    `F12`     | **显示控制台** |
| `Ctrl` + `l` | **直接胜利**  |

### 1.3.3 调试控制台
![[Pasted image 20251213194044.png|900]]
调试控制台会显示详细信息，比如加载资源，所有点击事件，操作实体（插入，移除）等

| 信息        | 搜索             |
| --------- | -------------- |
| **报错**        | `error`        |
| **点击事件**      | `mousepressed` |
| **操作实体等**     | `systems`      |
| **调用的 SU 函数** | `script_utils` |
| **加载的资源**     | `load`         |
| **关卡相关**      | `level_utils`  |

### 1.3.4 断点
点击代码行左侧即可增加断点。

注：断点只有 Debug 模式可用
![[Pasted image 20251213173619.png|281]]

运行过程可按 `0` 手动断点

#### 报错时自动断点
直接使用 Debug 模式进入游戏即可

### 1.3.5 关卡编辑器
在 `args` 取消 `screen` 与 `custom` 的注释， `custom` 输入要编辑的关卡的编号运行后即可进入关卡编辑器
![[Pasted image 20250712192159.png|500]]


## 1.4 报错
### 1.4.1 蓝屏
游戏中报错通常会直接蓝屏，上面显示错误信息。
![[Pasted image 20250624161626.png|400]]

### 1.4.2 协程错误
游戏中协程错误会直接显示在调试控制台，通常某个实体卡住，无法移动与攻击就代表出现了协程错误
![[Pasted image 20251213194044.png|900]]
如图 `Error running coro: kr1/game_scripts.lua:1430: attempt to index global 'a' (a nil value)`

## 1.5 排查问题
### 1.5.1 调试快捷键失效
关闭输入法即可

### 1.5.2 Local Lua Debugger 报错
![[Pasted image 20250803203730.png|750]]
在 `all/systems` 搜索 `main_script:on_update`
```lua
-- 将以下代码修改
if coroutine.status(s.co) == "dead" or error ~= nil then
	if error ~= nil then

-- 修改为
if coroutine.status(s.co) == "dead" or (not success and error ~= nil) then
	if not success and error ~= nil then
```
![[Pasted image 20250717091020.png|975]]

## 1.6 存档
调试存档位置 `C:\Users\用户\AppData\Roaming\LOVE\kingdom_rush_xxx`

工作区文件夹自带快速跳转与全解锁存档，双击快捷方式跳转
![[Pasted image 20260104094917.png|575]]

## 1.7 本章总结
### 关键知识点回顾

1. **游戏自带的几个库**：
	- **向量库**：vector 
	- **宏指令库**：macros 
	- **模拟类库**：class 
	- **信号库**：signal
	- **定时器库**：timer 
	- **日志库**：log

2. **table 库扩展功能**：
	- 深浅拷贝
	- 深浅合并
	- 高阶函数

3. **调试功能**：
	- **监视变量**：在运行与调试监视变量
	- **调试控制台**：类似于输出
	- **调试快捷键**：`m` 增加金币、`l` 增加生命、`z` 加速、`a` 暂停等
	- **断点**：在代码行左侧打断点、游戏内按 `0` 手动断点、报错时自动断点
	- **关卡编辑器**：修改 `args` 进入关卡编辑器

4. **两种报错形式**：
	- **蓝屏**：一般报错
	- **控制台的报错**：协程报错等

---

**下一章预告**：在第 2 章中，我们将学习游戏实体数据的存储与修改，这是了解游戏系统的关键一步！
