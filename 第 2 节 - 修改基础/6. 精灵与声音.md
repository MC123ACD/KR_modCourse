## 6.1 精灵
可在屏幕上移动具有坐标，可变化的图像，称为精灵（**sprite**）

精灵通过计算自身的时间戳（**timestamp**，缩写 ts）控制其显示的图像

### 6.1.1 美术资源
所有美术资源都存于 `_assets` 目录中，其中 `images` 子目录为图像资源。

`images` 目录中的文件分为两种：图集与相应的图像数据

```lua
name_1 = {					-- 图像名称
	a_name = "abc-1.dds",	-- 图集名称
	size = {		-- 图像原始大小（未裁剪透明边）
		200,		-- 长度
		100			-- 高度
	},
	trim = {		-- 裁剪的透明边
		10,			-- 左侧裁剪的长度
		20,			-- 上方裁剪的长度
		15,			-- 右侧裁剪的长度
		25			-- 下方裁剪的长度
	},
	a_size = {		-- 图集大小
		2048,		-- 长度
		2048		-- 高度
	},
	f_quad = {		-- 从图集指定位置得到图像
		1000,		-- x
		500,		-- y
		175,		-- 长度
		55			-- 高度
	},
	alias = {		-- 别名
		"name_2"	-- 也可以通过name_2找到这个图像
	}
}
```
以上完整含义为：
1. 定义一个名叫 name_1 或 name_2 的图像
2. 原始大小 200x100 像素
3. 从左边裁去 10 像素，再从右边裁去 15 像素，最后再从上下裁去 20 和 25 像素
4. 图集名称 `abc-1.dds`
5. 图集大小 2048x2048
6. 这个图像位于图集的 [1000, 500] 到 [1175, 555] 处

示意图：
![[Pasted image 20251109133154.png|1000]]

### 6.1.2 动画
所有动画数据都存于 `kr/data/animations` 目录中.

```lua
animation_a_name = {		-- 动画名称
	prefix = "name",		-- 图像名称前缀（不带_x序号）
	to = 10,				-- 动画结束时的图像序号（结束帧）
	from = 1				-- 动画开始时的图像序号（开始帧）
}
```
以上完整含义为：
1. 定义动画名称为 animation_a_name
2. 图像名称 name，用于与当前帧拼接（例如：动画结束帧的图像为 name_10）
3. 动画从图像序号 1 开始到序号 10 结束（即 name_1 到 name_10）

### 6.1.3 常用精灵键

| <center>键</center> | <center>作用</center> | <center>键</center> | <center>作用</center> |
| ------------------ | ------------------- | ------------------ | ------------------- |
| `flip_x`           | 是否水平翻转              | `anchor`           | 锚点                  |
| `r`                | 旋转角度                | `offset`           | 位置偏移量               |
| `scale`            | 缩放比例                | `alpha`            | 透明度(0-255)          |
| `prefix`           | 动画前缀                | `hidden`           | 精灵是否隐藏              |
| `name`             | 动画名称，禁用动画则可以指定图像名称  | `fps`              | 动画播放帧率              |

#### 示例
```lua
tt.render.sprites[1].scale = v(2, 2)	-- 缩放到此前的两倍
```

所有键见 [[7. 键#精灵]]

### 6.1.4 animation_start - 播放动画
```lua
U.animation_start(
	实体: table, 
	动画名: str, 
	是否水平翻转: bool, 
	时间戳: num, 
	是否循环播放: bool, 
	精灵索引?: int, 
	强制重置时间戳: bool
)
```
- 后续动画名将与精灵的 `prefix` 前缀拼接
- 精灵索引默认为 1

所有动画函数见 [[9. 工具函数#动画]]

#### 示例
```lua
-- 模板
tt.render.sprites[1].prefix = "hero_muyrn"
tt.melee.attacks[1] = CC("melee_attack")
tt.melee.attacks[1].hit_time = fts(9)
tt.melee.attacks[1].animation = "melee_attack"

-- 更新函数中
local ma = this.melee.attacks[1]
-- 实际播放动画 hero_muyrn .. melee_attack = hero_muyrn_melee_attack
U.animation_start(this, ma.animation, nil, store.tick_ts)
-- 播放后等待攻击前摇的时间（9帧）
U.y_wait(store, ma.hit_time)

-- 也可以使用 U.y_animation_wait(this) 等待动画播放完成
```

### 6.1.5 等待动画的三种方法
#### 1. y_wait - 协程等待
```lua
U.y_wait(store, 等待时间: num, 中断函数?: func) -> 是否被中断: bool
```
- 在指定时间内循环挂起协程
- 中断函数用于提前终止暂停

#### 2. y_animation_wait - 等待动画播放完成
```lua
U.y_animation_wait(实体: table, 精灵索引?: int, 播放次数?: int)
```
- 精灵索引默认为 1
- 播放次数默认为 1

##### 示例
```lua
-- 更新函数中
local ma = this.melee.attacks[1]
U.animation_start(this, ma.animation, nil, store.tick_ts)

-- 播放后等待动画播放完成
U.y_animation_wait(this) 
```

#### 3. y_animation_play - 播放并等待动画完成
```lua
U.y_animation_play(实体: table, 动画名: str, 是否水平翻转: bool, 时间戳: num, 播放次数?: int, 精灵索引?: int)
```
- 是 `animation_start` 与 `y_animation_wait` 的结合
- 精灵索引默认为 1
- 播放次数默认值为 1

##### 示例
```lua
-- 更新函数中
local ma = this.melee.attacks[1]
U.y_animation_play(this, ma.animation, nil, store.tick_ts)
```

## 6.2 补间动画
根据精灵起点与终点的参数补足中间过渡帧的动画，称为补间动画（**Tween Animation**）
补间动画可当做关键帧，用于过渡，淡出淡入、平滑移动等

### 6.2.1 使用方法
首先增加 `tween` 补间动画组件，在 `keys` 指定关键帧，在 `name` 指定精灵键，在 `sprite_id` 指定目标精灵。

**默认值**：
- `name`：`alpha`
- `sprite_id`：`1`
```lua
-- 透明度
AC(tt, "tween")	-- 增加组件
tt.tween.props[1].keys = {
	{
		0,	
		255	-- 默认不透明
	},
	{
		1,
		0	-- 1 秒时完全透明
	}
}
tt.tween.props[1].sprite_id = 2	-- 补间的精灵，支持数字或表

-- 缩放
tt.tween.props[1].name = "scale"	-- 缩放
tt.tween.props[1].keys = {
	{
		0,
		v(1, 1)
	},
	{
		5,			-- 从 0 秒到 5 秒缓慢放大精灵到此前的两倍
		v(2, 2)
	}
}
```

### 6.2.2 淡出淡入
```lua
AC(tt, "tween")
tt.tween.props[1].keys = {
	{
		0,	-- 默认透明度 0
		255
	},
	{
		1,	-- 1 秒时完全淡出
		0
	},
	{
		2,	-- 2 秒时完全淡入
		255
	}
}
tt.tween.props[1].sprite_id = {	-- 补间的精灵，可以直接用数字或表
	1,
	2,
	...
}
tt.tween.remove = false			-- 禁用播放后移除
tt.tween.props[1].loop = true	-- 循环播放
```

## 5.3 声音
声音资源位于 `_assets/kr-desktop/sounds` 目录中。

**其中**：
- `groups` 为声音组
- `settings` 用于指定声音最大来源
- `sounds` 用于指定声音数据，声音资源位置，是否循环播放等
- `files` 声音资源

### 6.3.1 声音函数
声音函数位于 `all/sound_db` （缩写 S）中

#### 1. 将声音加入播放队列
```lua
S:queue(声音名称: str, 声音参数?: table)
```
- 同样会分配唯一 ID

##### 可选声音参数
```lua
1. gain: 声音大小: num|list{最小范围: num, 最大范围: num}
2. seek: 从指定位置开始播放（秒）: num
3. delay: 延迟（秒）: num
4. chance: 播放概率: num
5. every: 每N次请求播放一次: int
6. ignore: 播放声音间隔: num
7. ref_counted: 是否引用计数: bool
8. mode: 播放模式: 按顺序播放: "sequence"|随机选择一个播放: "random"|同时播放所有: "concurrent"
```
- 引用计数用于管理多个相同声音实例

##### 示例
```lua
-- 模板
tt.melee.attacks[1] = CC("melee_attack")
tt.melee.attacks[1].sound = "HeroNyruBasicAttackMelee"
tt.melee.attacks[1].sound_args = {
	delay = 1	-- 延迟 1 秒播放
}

-- 更新函数中
local ma = this.melee.attacks[1]
S:queue(ma.sound, ma.sound_args)
```

#### 2. 停止播放声音
```lua
S:stop(声音名称: str)
```