## 2.1 移植防御塔
以一代移植五代恶魔澡坑为例：
### 2.1.1 基础思路
1. 复制并处理纹理与动画
2. 复制相应实体的所有相关模板
3. 复制相应实体函数与相关工具函数与实体函数
4. 增加到相应选择界面

### 2.1.2 复制并处理纹理

#### 1. 复制图像资源
从 `kr5-desktop\images\ipadhd_bc3` 复制相应纹理（`go_towers_demon_pit-1.dds` 与 `go_towers_demon_pit.lua`）

#### 2. 缩放图像
首先使用 KR_Tools 拆分图集，然后使用处理图像工具处理拆分出来的图像，将图像缩放为一代大小

使用此预设处理
![[Pasted image 20251230204223.png|475]]

处理后重新打包即可放入一代资源文件内

#### 3. 复制动画
在 `_assets/kr5/animations` 搜索 `demon_pit`（恶魔澡坑英文名），将 `tower_demon_pit.lua` 动画数据复制到一代

### 2.1.3 复制声音与文本

#### 1. 复制声音
在 `_assets/kr5-desktop/sounds` 搜索 `demonpit` 将相关声音组与声音以及声音文件复制到一代

#### 2. 复制文本
首先使用 KR_Tools 的排序表工具排序 `_assets/kr5-desktop/strings/zh-Hans` 然后搜索 `demon_pit` 将所有相关文本复制到一代

### 2.1.4 复制模板
由于模板过于分散所以需要搜索 `demon_pit` 不带前缀的模板名称

将里面的每个相关模板都复制到一代的模板内。

推荐增加一块代码标记将所有相关模板复制到一起，便于后期维护
```lua
--#region 恶魔澡坑
tt = E:register_t("tower_demon_pit_demon_trail")
...
tt = E:register_t("decal_tower_demon_pit_reload", "decal_scripted")
...
tt = E:register_t("decal_tower_demon_pit_demon_explosion_decal", "decal_tween")
...
tt = E:register_t("decal_tower_demon_pit_demon_explosion_decal", "decal_tween")
...
tt = E:register_t("tower_build_demon_pit", "tower_build")
...
--#endregion
```

### 2.1.5 复制函数
同上

```lua
--#region 恶魔澡坑
function scripts.tower_demon_pit.get_info(this)
...
function scripts.tower_demon_pit.update(this, store, script)
...
--#endregion
```

### 2.1.6 增加到防御塔菜单
打开 `kr/data/tower_menus_data` 防御塔菜单数据，复制到一代防御塔菜单数据中

增加恶魔澡坑到炮塔三级分支按钮中
```lua
engineer = {
	{...},
	{...},
	{
		...
		{
			check = "main_icons_0019",
			action_arg = "tower_demon_pit_lvl1",
			action = "tw_upgrade",
			halo = "glow_ico_main",
			image = "main_icons_0012",
			place = 3,
			tt_title = _("TOWER_TESLA_NAME"),
			tt_desc = _("TOWER_TESLA_DESCRIPTION")
		}
	}
}
```

### 2.1.7 加载资源
在 `all/game` 的 `required_textures` 与 `required_sounds` 中增加刚刚增加的资源

### 2.1.8 根据报错补充相应文件
进入游戏测试，根据错误补充缺少的函数与模板以及资源即可

# 移植关卡

### 锚点
##### 1. 测量得到锚点位置
通常敌人与单位的锚点位于脚下

如图锚点（红点）位置 [160, 183]
图像大小 320x211

##### 2. 计算锚点相对于图像的位置
1. X 轴相对位置：`160 / 320 = 0.5`
2. Y 轴相对位置：`1 - 183 / 211 ≈ 0.133`
综上 `anchor = v(0.5, 0.133)`

##### Q&A
- Q：为什么 Y 轴相对位置是 1 与原 Y 轴相对位置之差
- A：这是因为 love2d 坐标系原点在左上角，而图像坐标系原点在左下角，所以需要反转