**本篇为所有练习的参考答案，下滑查看**
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-

### 练习 2.1：修改英雄
```lua
-- 模板内：
tt = RT("hero_alleria", "hero")
AC(tt, "melee", "ranged", "timed_attacks", "dodge")
...
tt.dodge.chance = 0.5
tt.dodge.silent = false
tt.melee.attacks[1].mod = "mod_poison"

tt = RT("arrow_hero_alleria", "arrow")
tt.bullet.mod = "mod_lava"
```

### 练习 2.2 增加状态效果
```lua
tt = RT("mod_deadly_poison", "mod_poison")
tt.modifier.duration = 5
tt.dps.damage_inc = 1
tt.dps.damage_min = 10
tt.dps.damage_max = 15
tt.dps.damage_every = 0.5
tt.dps.damage_type = DAMAGE_TRUE
tt.modifier.bans = {
    "mod_freeze"
}
tt.modifier.remove_banned = true
```

### 练习 3.2：日志与调试实践

```lua
function scripts.hero_shadow_assassin.update(this, store)
    local skill = this.hero.skills.shadow_assault
    local attack = this.timed_attacks.list[3]
    
    while true do
	    if skill.level > 0 and not attack.disabled then
	        if store.tick_ts - attack.ts >= attack.cooldown then
	            -- 记录技能检查通过
	            log.debug("暗影突袭技能检查: 等级=%d, 冷却=%f, 剩余冷却=%f", 
	                skill.level, attack.cooldown, store.tick_ts - attack.ts)
	            
	            -- 1. 索敌：找到范围内所有敌人
	            local enemies = U.find_enemies_in_range(
	                store.entities, 
	                this.pos, 
	                0, 
	                attack.radius, 
	                attack.vis_flags, 
	                attack.vis_bans
	            )
	            
	            if not enemies or #enemies == 0 then
	                -- 没有找到目标，记录警告但不中断游戏流程
	                log.warning("暗影突袭未找到目标: 实体ID=%d, 位置=(%.1f,%.1f), 范围=%d", 
	                    this.id, this.pos.x, this.pos.y, attack.radius)
	                return
	            end
	            
	            log.debug("找到 %d 个潜在目标", #enemies)
	            
	            -- 2. 找到血量最低的敌人
	            -- 首先过滤掉无效或已死亡的敌人
	            local valid_enemies = {}
	            for _, enemy in ipairs(enemies) do
	                if enemy and enemy.health and enemy.health.hp > 0 then
	                    table.insert(valid_enemies, enemy)
	                end
	            end
	            
	            if #valid_enemies == 0 then
	                log.warning("所有目标都已死亡或无效")
	                return
	            end
	            
	            -- 按血量排序（升序）
	            table.sort(valid_enemies, function(a, b)
	                return a.health.hp < b.health.hp
	            end)
	            
	            local target = valid_enemies[1]
	            log.info("选择目标: ID=%d, 血量=%d/%d, 位置=(%.1f,%.1f)",
	                target.id, target.health.hp, target.health.hp_max,
	                target.pos.x, target.pos.y)
	            
	            -- 偏执级日志：记录详细选择过程
	            log.paranoid("目标选择详情:")
	            for i, enemy in ipairs(valid_enemies) do
	                log.paranoid("  [%d] ID=%d, 血量=%d, 距离=%.1f", 
	                    i, enemy.id, enemy.health.hp, 
	                    V.dist(this.pos, enemy.pos))
	            end
	            
	            -- 3. 计算伤害
	            local damage = attack.damage_base + attack.damage_per_level * skill.level
	            log.debug("伤害计算: 基础=%d, 等级加成=%d, 总伤害=%d",
	                attack.damage_base, attack.damage_per_level * skill.level, damage)
	            
	            -- 4. 创建并排队伤害实体
	            local d = E:create_entity("damage")
	            d.value = damage
	            d.source_id = this.id
	            d.target_id = target.id
	            d.damage_type = attack.damage_type
	            
	            log.paranoid("伤害实体创建成功: 值=%d, 来源=%d, 目标=%d",
	                d.value, d.source_id, d.target_id)
	            
	            queue_damage(store, d)
	            
	            -- 5. 创建并排队流血效果
				local mod = E:create_entity(attack.mod)
				mod.modifier.target_id = target.id
				mod.modifier.source_id = this.id
				
				queue_insert(store, mod)
				log.debug("流血效果已应用: 模板=%s, 目标=%d", attack.mod, target.id)
	            
	            -- 6. 刷新技能时间戳
	            attack.ts = store.tick_ts
	            log.debug("技能时间戳更新: %f -> %f", 
	                attack.ts - attack.cooldown, attack.ts)
	            
	            -- 7. 播放动画和音效
				U.animation_start(this, attack.animation, nil, store.tick_ts)
				log.paranoid("播放动画: %s", attack.animation)
	            
				S:queue(attack.sound)
				log.paranoid("播放音效: %s", attack.sound)
	            
	            -- 8. 记录技能释放成功
	            log.info("暗影突袭释放成功: 实体ID=%d -> 目标ID=%d, 伤害=%d",
	                this.id, target.id, damage)
	            
	            -- 9. 等待动画完成（如果需要）
				U.y_animation_wait(this, store.tick_ts)
				log.paranoid("动画播放完成")
	        else
	            -- 技能冷却中，偶尔记录调试信息
	            if math.random() < 0.01 then  -- 1%的概率记录，避免日志过多
	                local remaining = attack.cooldown - (store.tick_ts - attack.ts)
	                log.paranoid("技能冷却中: 剩余 %.2f秒", remaining)
	            end
	        end
	    else
	        -- 技能未解锁或已禁用
	        if not attack.disabled and math.random() < 0.001 then
	            log.todo("检查技能解锁条件: 当前等级=%d, 需要等级=1", skill.level)
	        end
	    end
	    
	    coroutine.yield()
	end
end
```
