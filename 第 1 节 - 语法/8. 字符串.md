## 8.1 字符串基础

字符串是编程中最常用的数据类型之一。在 Lua 中，字符串是不可变的，但提供了丰富的操作函数。

### 8.1.1 字符串的创建

```lua
-- Lua有几种创建字符串的方式

-- 1. 双引号
local str1 = "Hello, Lua!"
print("双引号: " .. str1)

-- 2. 单引号
local str2 = 'Hello, World!'
print("单引号: " .. str2)

-- 3. 长括号（多行字符串）
local str3 = [[
这是多行字符串
可以包含换行和"各种引号"
而无需转义]]
print("长括号:\n" .. str3)

-- 4. 带有等号的长括号（可以嵌套）
local str4 = [=[
多层嵌套 [[不会结束字符串]]
]=]
print("带等号的长括号: " .. str4)
```

#### 转义符
```lua
-- 转义字符，用于输入特殊字符
local escaped = "第一行\n换行\t制表符（缩进）\"引号\\反斜杠"
print("转义字符示例:\n" .. escaped)

-- 特殊字符的表示
print("Unicode字符: \u{4F60}\u{597D}")  -- 你好
print("十六进制: \x48\x65\x6C\x6C\x6F")  -- Hello
```

所有转义符见 [[总结/8. 字符串#转义字符]]

### 8.1.2 字符串是不可变的

```lua
-- 重要概念：Lua字符串是不可变的
local original = "Hello"
print("原始字符串: " .. original)
print("原始字符串内存地址（通过tostring）: " .. tostring(original))

-- 看起来像是"修改"了字符串
original = original .. " World"
print("修改后: " .. original)
print("修改后内存地址: " .. tostring(original))
-- 注意：实际上是创建了一个新的字符串

-- 证明不可变性
local a = "Hello"
local b = "Hello"
print("\na和b相同吗？ " .. tostring(a == b))  -- true
print("a的内存地址: " .. tostring(a))
print("b的内存地址: " .. tostring(b))
-- Lua会复用相同的字符串，所以a和b可能指向同一内存

-- 实际影响：大量字符串操作时要注意性能
function slow_string_build()
    local result = ""
    for i = 1, 10000 do
        result = result .. "x"  -- 每次都会创建新字符串
    end
    return result
end

-- 更好的方式：使用table.concat
function fast_string_build()
    local parts = {}
    for i = 1, 10000 do
        parts[i] = "x"
    end
    return table.concat(parts)
end

print("\n字符串构建方式比较:")
-- 注意：在实际中，fast_string_build会比slow_string_build快得多
```

## 8.2 字符串基本操作

### 8.2.1 # - 字符串长度

```lua
-- 使用 # 运算符符获取字符串长度
print("=== 字符串长度 ===")

local str = "Hello, Lua!"
print("字符串: " .. str)
print("长度: " .. #str)  -- 11（英文和标点）
print("长度: " .. string.len(str))	-- 使用 string.len，与上面等价，但是只能操作字符串

-- 中文字符
local chinese = "你好，世界！"
print("\n中文字符串: " .. chinese)
print("长度: " .. #chinese)  -- 18（每个中文字符算三个长度）
print("长度: " .. string.len(chinese))

-- 包含特殊字符
local special = "Line1\nLine2\tTab"
print("\n特殊字符字符串: " .. special)
print("长度: " .. #special)  -- 15（\n算一个字符，\t算一个字符）
print("长度: " .. string.len(special))

-- 空字符串
local empty = ""
print("\n空字符串长度: " .. #empty)  -- 0
```

### 8.2.2 .. / table.concat - 字符串连接

```lua
-- 使用 .. 连接字符串
-- 基本连接
local greeting = "Hello" .. ", " .. "World!"
print("连接结果: " .. greeting)

-- 连接不同类型的值
local name = "小明"
local age = 18
local info = "姓名: " .. name .. ", 年龄: " .. age
print("信息: " .. info)

-- 大量连接时的性能问题
local start_time = os.clock()
local result = ""

for i = 1, 1000 do
    result = result .. "x"  -- 每次创建新字符串
end

local end_time = os.clock()
print("\n直接连接1000次耗时: " .. (end_time - start_time) .. "秒")

-- 使用table.concat提高性能
start_time = os.clock()
local parts = {}

for i = 1, 1000 do
    parts[i] = "x"
end

result = table.concat(parts)
end_time = os.clock()
print("使用table.concat耗时: " .. (end_time - start_time) .. "秒")

-- table.concat的高级用法
local words = {"Hello", "World", "from", "Lua"}
local sentence = table.concat(words, " ", 2, 4)  -- 从第2个到第4个，用空格连接
print("\n部分连接: " .. sentence)  -- "World from Lua"

-- 实际应用：构建SQL查询
local conditions = {"age > 18", "status = 'active'", "score >= 60"}
local where_clause = "WHERE " .. table.concat(conditions, " AND ")
print("SQL查询: SELECT * FROM users " .. where_clause)

-- 实际应用：构建URL
local base_url = "https://api.example.com"
local path = "users"
local query_params = {"limit=10", "offset=0", "sort=name"}
local url = base_url .. "/" .. path .. "?" .. table.concat(query_params, "&")
print("URL: " .. url)
```

### 8.2.3 string.rep - 字符串重复

```lua
string.rep(重复的字符串: str, 重复次数: int) -> 字符串结果: str
```

#### 示例
```lua
-- 基本重复
local stars = string.rep("*", 10)
print("10个星号: " .. stars)
-- 输出 10个星号: **********

-- 带分隔符的重复
local dashed_line = string.rep("-", 30)
print("分隔线: " .. dashed_line)
-- 输出 分隔线: ------------------------------

-- 重复多个字符
local pattern = string.rep("*-", 15)
print("模式: " .. pattern)
-- 输出 模式: *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-

-- 实际应用：进度条
local function create_progress_bar(percentage, width)
    local filled = math.floor(percentage * width / 100)
    local empty = width - filled
    
    local bar = "[" .. 
                string.rep("=", filled) .. 
                string.rep(" ", empty) .. 
                "] " .. 
                string.format("%3d%%", percentage)
    return bar
end

print("\n进度条:")
for i = 0, 100, 10 do
    print(create_progress_bar(i, 20))
end
--[[ 输出
进度条:
[                    ]   0%
[==                  ]  10%
[====                ]  20%
[======              ]  30%
[========            ]  40%
[==========          ]  50%
[============        ]  60%
[==============      ]  70%
[================    ]  80%
[==================  ]  90%
[====================] 100%
--]]

-- 实际应用：缩进文本
local function indent_text(text, indent_level)
    local indent = string.rep("  ", indent_level)
    return indent .. text
end

print("\n缩进文本:")
local lines = {
    "第一级",
    "第二级",
    "第三级"
}

for i, line in ipairs(lines) do
    print(indent_text(line, i-1))
end
--[[ 输出
缩进文本:
第一级
  第二级
    第三级
--]]

-- 创建表格边框
local function create_table_border(width)
    local border = "+" .. string.rep("-", width-2) .. "+"
    return border
end

print("\n表格边框:")
print(create_table_border(25))
print("|         内容           |")
print(create_table_border(25))

--[[ 输出
表格边框:
+-----------------------+
|         内容           |
+-----------------------+
--]]
```

## 8.3 字符串查找和提取

### 8.3.1 string.find - 字符串查找

```lua
string.find(字符串: str, 查找的字符串: str, 搜索位置?: int, 是否不使用正则模式?: bool) -> 起始索引: int, 结束索引: int| nil
```
- 搜索位置可以一个负数，表示从后往前数的字符个数

#### 示例
```lua
local text = "Hello, Lua programming is fun!"

-- 查找子串
local start_pos, end_pos = string.find(text, "Lua")
if start_pos then
    print("找到'Lua'在位置: " .. start_pos .. "-" .. end_pos)
    print("子串: " .. string.sub(text, start_pos, end_pos))
else
    print("未找到")
end

-- 从指定位置开始查找
local pos = string.find(text, "o", 6)  -- 从第5个字符开始找
print("\n从第5位开始找'o': " .. (pos or "未找到"))		-- 14

-- 查找最后一个匹配
local function find_last(str, pattern)
    local last_pos
    local current_pos = 1
    
    while true do
        local start, finish = string.find(str, pattern, current_pos)
        if not start then 
        	break
        end
        
        last_pos = start
        current_pos = start + 1
    end
    
    return last_pos
end

local last_o = find_last(text, "o")
print("最后一个'o'在位置: " .. (last_o or "未找到"))

-- 查找所有匹配
local function find_all(str, pattern)
    local positions = {}
    local current_pos = 1
    
    while true do
        local start, finish = string.find(str, pattern, current_pos)
        if not start then break end
        
        table.insert(positions, {start = start, finish = finish})
        current_pos = start + 1
    end
    
    return positions
end

print("\n 查找所有'o':")
local all_o = find_all(text, "o")
for i, pos in ipairs(all_o) do
    print("  匹配" .. i .. ": 位置" .. pos.start .. "-" .. pos.finish)
end

-- 实际应用：查找邮箱地址
local email_text = "联系我: user@example.com 或 admin@test.org "
local email_pattern = "[%w%.%-]+@[%w%.%-]+%.[%w]+"

local email_start, email_end = string.find(email_text, email_pattern)
if email_start then
    print("\n 找到邮箱: " .. string.sub(email_text, email_start, email_end))
end
```

### 8.3.2 string.sub - 字符串截取

```lua
string.sub(字符串: str, 截取起始位置: int, 截取结束位置?: int) -> 字符串: str
```
- 截取结束位置默认为 -1（截取到最后一个）

#### 示例
```lua
local sentence = "The quick brown fox jumps over the lazy dog"

-- 提取子串
local first_word = string.sub(sentence, 1, 3)
print("第一个单词: " .. first_word)  -- The

-- 使用负索引（从末尾开始）
local last_word = string.sub(sentence, -3)  -- 最后 3 个字符
print("最后三个字符: " .. last_word)  -- dog

-- 提取中间部分
local middle = string.sub(sentence, 5, 14)
print("第 5-14 个字符: " .. middle)  -- quick bro

-- 实际应用：提取文件名和扩展名
local function find_last(str, pattern)
    local last_pos
    local current_pos = 1

    while true do
        local start, finish = string.find(str, pattern, current_pos)
        if not start then break end

        last_pos = start
        current_pos = start + 1
    end

    return last_pos
end

local function split_filename(filename)
    local name_without_ext = filename
    local ext = ""
    
    -- 查找最后一个点
    local dot_pos = find_last(filename, "%.")
    
    if dot_pos and dot_pos > 1 then
        name_without_ext = string.sub(filename, 1, dot_pos - 1)
        ext = string.sub(filename, dot_pos + 1)
    end
    
    return name_without_ext, ext
end

local files = {"document.pdf", "image.jpg", "no_extension", ".hidden", "archive.tar.gz"}

print("\n 文件名分割:")
for _, filename in ipairs(files) do
    local name, ext = split_filename(filename)
    print(string.format("  %-20s -> 名称: %-15s 扩展名: %s", filename, name, ext))
end

-- 实际应用：提取 URL 各部分
function parse_url(url)
    local protocol, domain, path
    
    -- 查找协议
    local protocol_end = string.find(url, "://")
    if protocol_end then
        protocol = string.sub(url, 1, protocol_end - 1)
        url = string.sub(url, protocol_end + 3)
    end
    
    -- 查找路径
    local path_start = string.find(url, "/")
    if path_start then
        domain = string.sub(url, 1, path_start - 1)
        path = string.sub(url, path_start)
    else
        domain = url
        path = "/"
    end
    
    return protocol, domain, path
end

print("\nURL 解析:")
local urls = {
    "https://www.example.com/path/to/page",
    "http://localhost:8080",
    "ftp://files.server.com/download/file.zip"
}

for _, url in ipairs(urls) do
    local protocol, domain, path = parse_url(url)
    print(string.format("  %-40s -> 协议: %-6s 域名: %-20s 路径: %s", 
          url, protocol or "无", domain, path))
end
```

### 8.3.3 字符串分割

```lua
-- Lua 没有内置的字符串分割函数，需要自己实现
-- 按分隔符分割字符串
local function string_split(str, delimiter)
    local result = {}
    local pattern = string.format("([^%s]+)", delimiter)
    
    for match in string.gmatch(str, pattern) do
        table.insert(result, match)
    end
    
    return result
end

-- 按空格分割
local sentence = "The quick brown fox jumps over the lazy dog"
local words = string_split(sentence, " ")

print("\n 句子单词:")

for i, word in ipairs(words) do
    print("  单词" .. i .. ": " .. word)
end
--[[ 输出
句子单词:
 单词1: The
 单词2: quick
 单词3: brown
 单词4: fox
 单词5: jumps
 单词6: over
 单词7: the
 单词8: lazy
 单词9: dog
--]]

-- 按行分割
local multi_line = "第一行\n 第二行\n 第三行"
local lines = string_split(multi_line, "\n")

print("\n 按行分割:")

for i, line in ipairs(lines) do
    print("  行" .. i .. ": " .. line)
end
--[[ 输出
按行分割:
 行1: 第一行
 行2:  第二行
 行3:  第三行
--]]
```

## 8.4 - 字符串模式匹配

Lua 的模式匹配（pattern matching）是一种轻量级的正则表达式，功能强大但语法更简单，使用具有特殊意义的符号（修饰符）表示各种字符。

所有模式匹配修饰符见 [[总结/8. 字符串#模式匹配修饰符]]

### 8.4.1 string.match - 匹配单个模式

```lua
string.match(字符串: str, 匹配模式: pattern, 起始位置?: init) -> 匹配结果: str
```

#### 示例
```lua
-- Lua 模式匹配的特殊字符

-- . 匹配任意字符
print("'.'匹配任意字符: " .. string.match("abc123", "."))

-- %a 匹配字母
print("'%a'匹配字母: " .. string.match("abc123!@#", "%a"))

-- %d 匹配数字
print("'%d'匹配数字: " .. string.match("abc123!@#", "%d"))

--[[ 输出
'.'匹配任意字符: a
'%a'匹配字母: a
'%d'匹配数字: 1
--]]
```

### 8.4.2 string.gmatch - 匹配多个模式

```lua
string.gmatch(字符串: str, 匹配模式: str) -> 迭代器函数: func
```

#### 示例
```lua
-- . 匹配任意字符
local matches = {}
for match in string.gmatch("abc123", ".") do	-- 迭代器函数用于遍历，每次调用 string.match 匹配字符串中下一个结果
    table.insert(matches, match)
end
print("'.'匹配任意字符: " .. table.concat(matches, ", "))

-- %a 匹配字母
matches = {}
for match in string.gmatch("abc123!@#", "%a") do
    table.insert(matches, match)
end
print("'%a'匹配字母: " .. table.concat(matches, ", "))

-- %d 匹配数字
matches = {}
for match in string.gmatch("abc123!@#", "%d") do
    table.insert(matches, match)
end
print("'%d'匹配数字: " .. table.concat(matches, ", "))

--[[ 输出
'.'匹配任意字符: a, b, c, 1, 2, 3
'%a'匹配字母: a, b, c
'%d'匹配数字: 1, 2, 3
--]]
```


### 8.4.3 [] - 字符类

```lua
-- 字符类：用 [] 定义自定义字符集
local text = "abc123!@ #DEF "

-- [abc] 匹配 a、b 或 c
local matches = {}
for match in string.gmatch(text, "[abc]") do
    table.insert(matches, match)
end
print("[abc]匹配: " .. table.concat(matches, ", "))

-- [0-9] 匹配数字
matches = {}
for match in string.gmatch(text, "[0-9]") do
    table.insert(matches, match)
end
print("[0-9]匹配: " .. table.concat(matches, ", "))

-- [A-Z] 匹配大写字母
matches = {}
for match in string.gmatch(text, "[A-Z]") do
    table.insert(matches, match)
end
print("[A-Z]匹配: " .. table.concat(matches, ", "))

-- [^abc] 匹配除了 a、b、c 之外的字符
matches = {}
for match in string.gmatch(text, "[^abc]") do
    table.insert(matches, match)
end
print("[^abc]匹配: " .. table.concat(matches, ", "))

-- 组合字符类
matches = {}
for match in string.gmatch(text, "[a-z0-9]") do
    table.insert(matches, match)
end
print("[a-z0-9]匹配: " .. table.concat(matches, ", "))

-- 实际应用：验证用户名
function validate_username(username)
    -- 用户名要求：字母开头，只能包含字母、数字、下划线，长度 3-20
    local pattern = "^[a-zA-Z][%w_]{2,19}$"
    return string.match(username, pattern) ~= nil
end

print("\n 用户名验证:")
local test_usernames = {"abc", "123", "a_1", "a", "very_long_username_here", "user-name"}
for _, name in ipairs(test_usernames) do
    print(string.format("  %-25s -> %s", name, validate_username(name) and "有效" or "无效"))
end

-- 实际应用：提取颜色代码
function extract_color_codes(text)
    local colors = {}
    
    -- 匹配 #RRGGBB 或 #RGB 格式
    for code in string.gmatch(text, "#[0-9a-fA-F]+") do
        if #code == 4 or #code == 7 then  -- #RGB 或 #RRGGBB
            table.insert(colors, code)
        end
    end
    
    return colors
end

local color_text = "背景色: #FFFFFF , 文字色: #000 , 高亮: #FF0000 , 无效: #12345 "
print("\n 提取颜色代码:")
local colors = extract_color_codes(color_text)
for _, color in ipairs(colors) do
    print("  颜色: " .. color)
end
```

### 8.4.4 重复修饰符

```lua
-- 重复修饰符控制匹配次数
local text = "aaabbcccddddeeee"

-- * 匹配 0 次或多次（贪婪）
local matches = {}
for match in string.gmatch(text, "a*") do
    if #match > 0 then
        table.insert(matches, "'" .. match .. "'")
    end
end
print("*匹配（贪婪）: " .. table.concat(matches, ", "))

-- + 匹配 1 次或多次
matches = {}
for match in string.gmatch(text, "a+") do
    table.insert(matches, "'" .. match .. "'")
end
print("+匹配: " .. table.concat(matches, ", "))

-- ? 匹配 0 次或 1 次
matches = {}
for match in string.gmatch(text, "a?") do
    table.insert(matches, "'" .. match .. "'")
end
print("?匹配: " .. table.concat(matches, ", "))

-- - 匹配 0 次或多次（非贪婪）
matches = {}
for match in string.gmatch("aaaa", "a-") do
    table.insert(matches, "'" .. match .. "'")
end
print("-匹配（非贪婪）: " .. table.concat(matches, ", "))
--[[ 输出
*匹配（贪婪）: 'aaa'
+匹配: 'aaa'
?匹配: 'a', 'a', 'a', '', '', '', '', '', '', '', '', '', '', '', '', '', ''
-匹配（非贪婪）: '', '', '', '', ''
--]]

-- 实际应用：匹配浮点数
local function extract_numbers(text)
    local numbers = {}
    
    -- 匹配整数和浮点数
    for num in string.gmatch(text, "[+-]?%d+%.?%d*") do
        -- 过滤掉单独的点和无效格式
        if num ~= "." and num ~= "+" and num ~= "-" then
            table.insert(numbers, num)
        end
    end
    
    return numbers
end

local number_text = "价格: 12.5, -3.14, +100, .5, 3., abc, 123"
print("\n 提取数字:")
local numbers = extract_numbers(number_text)

for _, num in ipairs(numbers) do
    print("  数字: " .. num)
end
--[[ 输出
提取数字:
  数字: 12.5
  数字: -3.14
  数字: +100
  数字: 5
  数字: 3.
  数字: 123
--]]

-- 实际应用：匹配 HTML 标签
function extract_html_tags(html)
    local tags = {}
    
    -- 简单匹配标签（不包括属性）
    for tag in string.gmatch(html, "<([^>]+)>") do
        table.insert(tags, tag)
    end
    
    return tags
end

local html = "<div class='container'><p>Hello</p><br/><img src='test.jpg'></div>"
print("\n 提取 HTML 标签:")
local tags = extract_html_tags(html)

for _, tag in ipairs(tags) do
    print("  标签: <" .. tag .. ">")
end
--[[ 输出
提取 HTML 标签:
  标签: <div class='container'>
  标签: <p>
  标签: </p>
  标签: <br/>
  标签: <img src='test.jpg'>
  标签: </div>
--]]
```

### 8.4.5 () - 捕获和分组

```lua
-- 使用()进行捕获
-- 基本捕获
local date = "2024-12-27"
local year, month, day = string.match(date, "(%d+)-(%d+)-(%d+)")
print("日期解析:")
print("  年: " .. (year or "无"))
print("  月: " .. (month or "无"))
print("  日: " .. (day or "无"))
--[[ 输出
日期解析:
  年: 2024
  月: 12
  日: 27
--]]

-- 捕获邮箱的用户名和域名
local email = " user@example.com "
local username, domain = string.match(email, "([%w%.%-]+)@([%w%.%-]+%.[%w]+)")
print("\n 邮箱解析:")
print("  用户名: " .. (username or "无"))
print("  域名: " .. (domain or "无"))
--[[ 输出
邮箱解析:
 用户名: user
 域名: example.com
--]]

-- 使用 gmatch 进行多次捕获
local text = "alice:18,jack:20,bob:22"
print("\n 解析键值对:")

for name, age in string.gmatch(text, "([%u%l]+):(%d+)") do
    print("  姓名: " .. name .. ", 年龄: " .. age)
end
--[[ 输出
解析键值对:
 姓名: alice, 年龄: 18
 姓名: jack, 年龄: 20
 姓名: bob, 年龄: 22
--]]

-- 捕获 URL 各部分
function parse_url_detail(url)
    local pattern = "^([%w]+)://([^/]+)(.*)$"
    local protocol, host, path = string.match(url, pattern)
    
    return protocol, host, path
end

-- 实际应用：提取和格式化日期
local function reformat_date(date_str)
    -- 支持多种日期格式
    local patterns = {
        "(%d%d%d%d)[-/](%d%d)[-/](%d%d)",  -- YYYY-MM-DD
        "(%d%d)[-/](%d%d)[-/](%d%d%d%d)"   -- MM-DD-YYYY
    }
    
    for _, pattern in ipairs(patterns) do
        local y, m, d = string.match(date_str, pattern)
        
        if y and m and d then
            -- 如果年份是 2 位数，假设是 19xx 或 20xx
            if #y == 2 then
                local temp = y
                y = d
                d = temp
            end
            
            return string.format("%s 年 %s 月 %s 日", y, m, d)
        end
    end
    
    return date_str  -- 无法解析，返回原样
end

print("\n 日期格式化:")
local dates = {"2024-12-27", "12/27/2024", "24-01-15", "无效日期"}
for _, date in ipairs(dates) do
    print("  " .. date .. " -> " .. reformat_date(date))
end
--[[ 输出
日期格式化:
 2024-12-27 -> 2024 年 12 月 27 日
 12/27/2024 -> 2024 年 27 月 12 日
 24-01-15 -> 24-01-15
 无效日期 -> 无效日期
--]]
```

### 8.4.6 string.gsub - 字符串替换

```lua
string.gsub(字符串: str, 匹配模式: str, 替换为: str, 替换次数?: int) -> 替换后的字符串: str, 替换次数: int
```
- 不指定替换次数将会替换所有匹配的字符串

#### 示例
```lua
-- 基本替换
local text = "Hello World"
local replaced = string.gsub(text, "World", "Lua")
print("基本替换: " .. replaced)
-- 输出 基本替换: Hello Lua

-- 限制替换次数
local text = "Hello World World World"
local replaced = string.gsub(text, "World", "Lua", 2)
print("替换两次: " .. replaced)
-- 输出 替换两次: Hello Lua Lua World

-- 使用模式匹配替换
local text = "Price: $10.99, Discount: 20%"
local replaced = string.gsub(text, "%$%d+%.%d%d", "[价格隐藏]")
print("隐藏价格: " .. replaced)
-- 输出 隐藏价格: Price: [价格隐藏], Discount: 20%

-- 使用函数进行替换
local text = "The temperature is 25C and humidity is 60%"
local replaced = string.gsub(text, "(%d+)(%a?)", function(value, unit)
    if unit == "C" then
        -- 摄氏度转华氏度
        local f = tonumber(value) * 9/5 + 32
        return string.format("%.1fF", f)
    end
    
    return value .. unit
end)

print("单位转换: " .. replaced)
-- 输出 单位转换: The temperature is 77.0F and humidity is 60%

-- 使用%n 引用捕获
-- %1, %2 等引用之前的捕获
local text = "Hello World"
local swapped = string.gsub(text, "(%S+)%s+(%S+)", "%2 %1")
print("\n 交换单词:")
print("  原始: " .. text)
print("  交换后: " .. swapped)
--[[ 输出
交换单词:
 原始: Hello World
 交换后: World Hello
--]]

-- 实际应用：模板渲染（更好的方法是字符串格式化）
local function render_template(template, data)
    local result = string.gsub(template, "{{([%w_]+)}}", function(key)
        return data[key] or ""
    end)
    return result
end

local template = "尊敬的 {{name}} ：您订购的 {{product}} 已发货，订单号： {{order_id}} "
local data = {
    name = "张三",
    product = "Lua 编程书籍",
    order_id = "20241227001"
}

print("\n 模板渲染:")
print("  模板: " .. template)
print("  数据: " .. "name=" .. data.name .. ", product=" .. data.product .. ", order_id=" .. data.order_id)
print("  结果: " .. render_template(template, data))
--[[ 输出
模板渲染:
 模板: 尊敬的 {{name}} ：您订购的 {{product}} 已发货，订单号： {{order_id}} 
 数据: name=张三, product=Lua 编程书籍, order_id=20241227001
 结果: 尊敬的 张三 ：您订购的 Lua 编程书籍 已发货，订单号： 20241227001 
--]]
```

## 8.5 string.format - 字符串格式化

简单来说字符串格式化就是将占位符替换为实际值，同时替换时根据占位符来对实际值进行额外处理。

```lua
string.format(被格式化的字符串: str, 替换值: str...) -> 格式化后的字符串: str
```

所有格式化修饰符见 [[总结/8. 字符串#格式化修饰符]]

#### 示例

```lua
-- 基本格式化，%s 表示替换值是字符串，%d 表示替换值是数字
local name = "小明"
local age = 18
local formatted = string.format("姓名: %s, 年龄: %d", name, age)
print("基本格式化: " .. formatted)
-- 输出 姓名: 小明, 年龄: 18
```

#### 数字字符串格式化
```lua
local price = 19.99
print("\n 数字格式化:")
-- %f 表示浮点数（小数）默认小数精度 6 位
print("  默认: " .. string.format("%f", price))
-- %.nf 表示小数精度
print("  两位小数: " .. string.format("%.2f", price))
-- %d 表示整数，与替换值类型不符会自动转化，如果替换值为浮点会截断小数部分，数字字符串自动转化为数字
print("  整数: " .. string.format("%d", price))
-- %e 对替换值进行处理，改为科学计数法表示
print("  科学计数法: " .. string.format("%e", price))
-- %nd 组合使用：整数 %d + n 右对齐
print("  宽度 10，右对齐: " .. string.format("%10d", price))
-- %-nd 组合使用：整数 %d + -n 左对齐
print("  宽度 10，左对齐: " .. string.format("%-10d", price))
-- %0nd 前导零
print("  前导零: " .. string.format("%04d", price))
--[[ 输出
 默认: 19.990000
 两位小数: 19.99
 整数: 19
 科学计数法: 1.999000e+001
 宽度 10，右对齐:      19
 宽度 10，左对齐: 19     
 前导零: 0019
]]
```

#### 字符串格式化
```lua
local text = "Hello"
print("\n 字符串格式化:")
-- %s 表示字符串，同上与替换值类型不符会自动转化，数字自动转化为数字字符串
print("  默认: " .. string.format("%s", text))
-- 同上
print("  宽度 10，右对齐: " .. string.format("%10s", text))
print("  宽度 10，左对齐: " .. string.format("%-10s", text))
-- %.ns 字符串截断
print("  截断为 3 字符: " .. string.format("%.3s", text))
--[[ 输出
 默认: Hello
 宽度 10，右对齐:      Hello
 宽度 10，左对齐: Hello     
 截断为 3 字符: Hel
--]]
```

#### 示例
```lua
-- 实际应用：创建表格
function create_table(data)
    local rows = {}
    
    -- 表头
    table.insert(rows, string.format("%-20s %-10s %-10s", "姓名", "年龄", "分数"))
    table.insert(rows, string.rep("-", 42))
    
    -- 数据行
    for _, student in ipairs(data) do
        local row = string.format("%-20s %-10d %-10.1f", 
                                 student.name, student.age, student.score)
        table.insert(rows, row)
    end
    
    return table.concat(rows, "\n")
end

local students = {
    {name = "张三", age = 18, score = 85.5},
    {name = "李四", age = 19, score = 92.0},
    {name = "王五", age = 20, score = 78.5}
}

print("\n 学生表格:")
print(create_table(students))
--[[ 输出
 学生表格:
姓名               年龄     分数    
------------------------------------------
张三               18         85.5      
李四               19         92.0      
王五               20         78.5      
--]]
```

## 8.6 字符串与数字转换

### 8.6.1 tostring - 字符串转化

```lua
tostring(值: any) -> 字符串:str
```

#### 示例
```lua
local num = 123.456
local str_num = tostring(123.456)
print("数字转字符串:")
print(string.format("  数字: %.3f，类型： %s", num, type(num)))
print(string.format("  字符串: \"%s\"，类型：%s", str_num, type(str_num)))
--[[ 输出
数字: 123.456，类型： number
字符串: "123.456"，类型：string
--]]

-- 连接或格式化时自动会将数字转化为字符串
print("连接自动转化字符串：" .. num)
print(string.format("格式化自动转化字符串：%.3f", num))
--[[ 输出
连接自动转化字符串：123.456
格式化自动转化字符串：123.456000
--]]

-- 可以查看内存地址
print("表的内存地址：" .. tostring({123, 10}))
print("函数的内存地址：" .. tostring(function()
    return 123, 10
end))
--[[ 输出
表的内存地址：table: 00D49D00
函数的内存地址：function: 00D4C390
--]]
```

### 8.6.2 tonumber - 字符串转数字

```lua
tonumber(要转化的字符串: str, 转化的基数?: 2-36) -> 字符串: str
```

#### 示例
```lua
local str = "123.456"
local num = tonumber(str)
print("字符串转数字:")
print(string.format("  字符串: \"%s\"，类型：%s", str, type(str)))
print(string.format("  数字: %.3f，类型： %s", num, type(num)))
--[[ 输出
  字符串: "123.456"，类型：string
  数字: 123.456，类型： number
--]]

-- 转换基数
print("\n 不同基数的转换:")
local hex_str = "FF"
local dec_num = tonumber(hex_str, 16)
print("  十六进制 " .. hex_str .. " -> 十进制 " .. dec_num)
local bin_str = "1010"
local bin_num = tonumber(bin_str, 2)
print("  二进制 " .. bin_str .. " -> 十进制 " .. bin_num)
--[[ 输出
 十六进制 FF -> 十进制 255
 二进制 1010 -> 十进制 10
--]]

-- 解析字符串中的数字
local function extract_numbers_from_string(str)
    local numbers = {}
    
    for num_str in string.gmatch(str, "[+-]?%d+%.?%d*") do
        local num = tonumber(num_str)
        if num then
            table.insert(numbers, num)
        end
    end
    
    return numbers
end

local mixed_text = "攻击 10 次，伤害 25 点"
print("\n 从字符串提取数字:")
local numbers = extract_numbers_from_string(mixed_text)

for i, num in ipairs(numbers) do
    print("  数字" .. i .. ": " .. num)
end
--[[ 输出
数字1: 10
数字2: 25
--]]
```

## 8.8 VScode 搜索与替换
### 8.8.1 搜索
搜索可以使用 `ctrl + F` 搜索或在搜索选项中搜索。

| ![[Pasted image 20251228142511.png\|423]] | ![[Pasted image 20251228142437.png\|356]] |
| ------------------------------------ | ----------------------------------------- |

#### 搜索的三种模式
![[Pasted image 20251228142616.png]]
##### 1. 区分大小写

##### 2. 全字匹配
完全匹配字符，多一个字少一个字都不行，例如：搜索 lua 只能匹配到 lua，alua，luaa 都无法匹配

##### 3. 正则表达式
类似模式匹配，请询问 AI 了解更多，示例：`h+` 匹配 `hhh...`，`(.+)` 匹配所有括号与括号内的内容 `(abc...)`

### 8.8.2 替换
可以点击搜索框左侧的箭头打开替换，搜索的内容将会被替换
![[Pasted image 20251228143503.png]]
可以全部替换也可以在搜索结果上替换单个。
![[Pasted image 20251228143705.png|412]]

或者使用鼠标选中一块文本按 `ctrl + F2` 进行快速替换

### 8.8.3 高级替换
由于 VScode 替换功能较少只有保留大小写，可以使用 Find and Transform 插件编写 JavaScript 替换脚本。

使用 `ctrl + shift + P` 打开命令面版，输入 `Preferences: Open Keyboard Shortcuts (JSON)` 打开键盘快捷方式 json，增加模板：
```json
{
	"key": "alt+1",		// 快捷键
	"command": "findInCurrentFile",
	"args": {
		"find": "匹配内容",
		"replace": "替换为",
		"isRegex": true		// 使用正则表达式匹配
	}
},
```

JavaScript 详细请询问 AI

#### 示例
```lua
print("hello lua1")
print("hello lua2")
print("hello lua3")
print("hello lua4")
print("hello lua5")
print("hello lua6")
```

json：
```json
[
	{
		// 替换 hello lua 的 4 5 6 后缀，使其翻 11 倍
		"key": "alt+1",
		"command": "findInCurrentFile",
		"args": {
			// 转义符 \
			// () 括号捕获分组，\\d+ 匹配数字
			"find": "(hello lua)(\\d+)",
			// $${} 表示使用 JavaScript
			// $1 表示捕获的组 1
			// $1 表示捕获的组 2
			"replace": [
				"$${",
				"if ($2 >= 4 && $2 <= 6) {",
				"  const n = $2 * 11;",
				"  return '$1' + n;",
				"} else {",
				"  return '$1' + '$2';",
				"}",
				"}$$"
			],
			"isRegex": true
		}
	},
	{
        // 替换 hello luaX 为新格式 hello lua, num is X
        "key": "alt+2",
        "command": "findInCurrentFile",
        "args": {
            "find": "(hello lua)(\\d+)",
            // 单行，组不需要单引号
            "replace": "$1, num is $2",
            "isRegex": true
        }
    },
]
```

保存 json 后打开你的代码文件按快捷键 `alt + 1` 替换。
```lua
print("hello lua1")
print("hello lua2")
print("hello lua3")
print("hello lua44")
print("hello lua55")
print("hello lua66")

-- 再按 alt + 2 替换新格式
print("hello lua, num is 1")
print("hello lua, num is 2")
print("hello lua, num is 3")
print("hello lua, num is 44")
print("hello lua, num is 55")
print("hello lua, num is 66")
```

## 8.8 常见错误

```lua
-- 错误1：混淆模式匹配修饰符 %、格式化修饰符 % 以及转义符 /
local wrong = string.format("文件名: %s, 模式: %d+", s1, s2)  -- 错误：这里 %d+ 与模式匹配混淆了，+ 不是有效格式符
```

## 8.9 练习

### 练习 1：简单的文本分析器
（答案见[[第 1 节 - 语法/参考答案#练习 8 1：简单的文本分析器]]）
```lua
-- 写一个文本分析器，可以分析给定的字符串有几行文本，有多少个单词，总字符数，统计最频繁的单词
-- 使用示例：
-- 测试文本分析器
local test_text = [[
Lua is a powerful, efficient, lightweight, embeddable scripting language.
It supports procedural programming, object-oriented programming, functional
programming, data-driven programming, and data description.

Lua combines simple procedural syntax with powerful data description
constructs based on associative arrays and extensible semantics.
Lua is dynamically typed, runs by interpreting bytecode with a
register-based virtual machine, and has automatic memory management with
incremental garbage collection, making it ideal for configuration,
scripting, and rapid prototyping.
]]

print("=== 文本分析器 ===")
analysis:analyze_text(test_text)

local data = analysis.data

print("基本统计:")
print("  总字符数: " .. data.total_chars)
print("  行数: " .. data.lines)
print("  单词数: " .. data.word_count)

print("\n 最频繁的单词:")
for i, item in ipairs(data.most_frequent) do
    print(string.format("  %2d. %-15s: %d 次", i, item.word, item.count))
end
--[[ 输出
基本统计:
  总字符数: 582
  行数: 11
  单词数: 70

 最频繁的单词:
   1. and            : 4 次
   2. programming    : 4 次
   3. lua            : 3 次
   4. with           : 3 次
   5. a              : 2 次
--]]
```

## 8.10 本章总结

### 关键知识点回顾

1. **字符串基础**：
	- 三种字符串字面量：双引号、单引号、长括号
	- 字符串是不可变的，操作会创建新字符串
	- 使用 `#` 获取长度，注意多字节字符
	- 使用 `\` 转义字符

2. **字符串操作**：
	- 连接：`..` 运算符
	- 重复：`string.rep`
	- 性能优化：大量连接时使用 `table.concat`

3. **字符串查找和提取**：
	- `string.find`：查找子串位置
	- `string.sub`：提取子串

4. **字符串模式匹配**：
	- 字符类：`%a`（字母）、`%d`（数字）、`%s`（空白）等
	- 重复修饰符：`*`、`+`、`?`、`-`、`{n,m}`
	- 捕获和分组：`()`
	- `string.match`：单次模式匹配和捕获
	- `string.gmatch`：多次模式匹配和捕获
	- `string.gsub`：模式匹配替换

5. **字符串格式化**：
	- `string.format`：格式化字符串
	- 格式修饰符：`%s`（字符串）、`%d`（整数）、`%f`（浮点数）等

6. **字符串转换**：
	- `tostring`：转换为字符串
	- `tonumber`：转换为数字，支持指定基数

7. **VScode 搜索与替换**：
	- **打开搜索**：使用 `ctrl + F` 或在左侧选项栏打开搜索框
	- **搜索模式**：区分大小写、全字匹配、正则表达式
	- **打开替换**：点击搜索框左侧箭头打开替换
	- **快速替换**：`ctrl + F2` 进行快速替换
	- **高级替换**：通过 Find and Transform 插件使用 JavaScript 编写替换脚本

### 性能优化技巧

```lua
-- 1. 对于大量字符串使用表连接
-- 不好
local result = ""

for i = 1, 1000 do
    result = result .. "x"  -- 创建 1000 个新字符串
end

-- 好
local parts = {}

for i = 1, 1000 do
    parts[i] = "x"
end

local result = table.concat(parts)

-- 2. 对于少量字符串连接使用字符串格式化

-- 不好
local current_path = "D/Program Files/"
local filepath = current_path .. "steam/" .. "common/" .. "game"

-- 好
local current_path = "D/Program Files"
local filepath = string.format("%s/%s/%s/%s", current_path, "steam", "common", "game")

-- 3. 重用模式对象（对于频繁使用的模式）
local pattern = "[%w%.%-]+@[%w%.%-]+%.[%w]+"
-- 然后多次使用这个 pattern

-- 4. 使用 string.gmatch 代替多次 string.find
-- 当需要找到所有匹配时
for match in string.gmatch(text, pattern) do
    -- 处理每个匹配
end
```

### 常见错误

```lua
-- 错误 1：误用 string.len 和 #操作符
local str = "你好"
print( #str )               -- 2（正确）
print(string.len(str))    -- 6（UTF-8 字节数）

-- 错误 2：忘记字符串不可变
local s = "Hello"
s = string.gsub(s, "H", "J")  -- 正确：创建新字符串并赋值
-- string.gsub(s, "H", "J")   -- 错误：不会修改原字符串

-- 错误 3：模式匹配中的贪婪匹配
local text = "<div>content</div>"
-- 贪婪匹配
local greedy = string.match(text, "<.->")  -- 整个字符串
-- 非贪婪匹配
local non_greedy = string.match(text, "<.- >")  -- <div>

-- 错误 4：转义特殊字符
local pattern = "10.5"  -- .在模式中匹配任意字符
local text = "10x5"
print(string.match(text, pattern))  -- 会匹配！
-- 应该转义
pattern = "10\.5"

-- 错误 5：忽略多行字符串的换行符
local str = [[第一行
第二行]]
print( #str )  -- 注意：包含换行符
```

### 检查清单
（点击勾选框勾选）
完成本章后，你应该能够：
- [ ] 理解字符串的不可变性及其影响
- [ ] 使用各种方式创建字符串
- [ ] 进行字符串的连接、重复和长度计算
- [ ] 查找、提取和分割字符串
- [ ] 使用 Lua 模式匹配进行复杂的字符串操作
- [ ] 进行字符串的替换和格式化
- [ ] 在字符串和数字之间进行转换
- [ ] 编写性能良好的字符串处理代码

### 思考题

1. 为什么 Lua 选择使用不可变字符串？这种设计有什么优缺点？
2. Lua 的模式匹配和正则表达式有什么区别？各有什么适用场景？
3. 在处理大量文本数据时，如何优化字符串操作的性能？
4. 如何正确处理包含多字节字符（如中文、emoji）的字符串？
5. 在什么情况下应该使用 `string.gsub` 的函数替换功能？

### 拓展练习

1. 编写一个 JSON 解析器（简化版），将 JSON 字符串转换为 Lua 表
2. 开发一个数据验证库，验证各种格式的数据（邮箱、URL、日期等）

---

**下一章预告**：在第 9 章中，我们将学习模块和包。模块是组织和重用代码的重要方式，我们将学习如何创建模块、使用模块、管理依赖，以及了解 Lua 的标准库。

**学习建议**：
1. 多练习模式匹配，这是 Lua 字符串处理的精华
2. 理解字符串不可变性的影响，编写性能良好的代码
3. 熟悉常用的字符串操作函数
4. 尝试用字符串处理解决实际问题，如文本分析、数据提取等
5. 注意处理多字节字符时的特殊考虑