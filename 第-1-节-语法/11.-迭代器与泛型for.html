<!DOCTYPE html> <html lang="zh-cn"><head>
<title>11. 迭代器与泛型for</title>
<base href="..">
<meta name="pathname" content="第-1-节-语法/11.-迭代器与泛型for.html">
<meta name="description" content="王国保卫战修改教程 - 11. 迭代器与泛型for">
<meta property="og:title" content="11. 迭代器与泛型for">
<meta property="og:description" content="王国保卫战修改教程 - 11. 迭代器与泛型for">
<meta property="og:type" content="website">
<meta property="og:url" content="第-1-节-语法/11.-迭代器与泛型for.html">
<meta property="og:image" content="site-lib/media/pasted-image-20251211142754.png">
<meta charset="UTF-8"><meta property="og:site_name" content="王国保卫战修改教程"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="site-lib/rss.xml"><script async="" id="webpage-script" src="site-lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="site-lib/media/favicon.png"><link rel="preload" href="site-lib/styles/snippets.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/snippets.css"></noscript><link rel="stylesheet" href="site-lib/styles/obsidian.css"><link rel="preload" href="site-lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="site-lib/styles/theme.css"><link rel="preload" href="site-lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="site-lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/supported-plugins.css"></noscript><link rel="preload" href="site-lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/main-styles.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-vertical-spacing:1.3em;--sidebar-margin:12px}:root{background-color:#202124}.sidebar{height:100%;font-size:14px;z-index:10;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));position:relative;overflow:hidden;overflow:clip;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}#left-sidebar{left:0}#right-sidebar{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}.sidebar.floating{position:absolute}.sidebar .leaf-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .leaf-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}#left-sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}#right-sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar #left-sidebar-content,.sidebar #right-sidebar-content{contain:none!important;container-type:normal!important;animation:none!important}.sidebar:has(.leaf-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:calc(2.3em + 2 * var(--sidebar-margin));width:var(--sidebar-width);padding:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}#left-sidebar .sidebar-topbar{left:0;flex-direction:row;border-top-right-radius:var(--radius-l)}#right-sidebar .sidebar-topbar{right:0;flex-direction:row-reverse;border-top-left-radius:var(--radius-l)}#left-sidebar .topbar-content{margin-right:calc(2.3em + var(--sidebar-margin));flex-direction:row}#right-sidebar .topbar-content{margin-left:calc(2.3em + var(--sidebar-margin));flex-direction:row-reverse}.topbar-content{overflow:hidden visible;overflow:clip visible;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:2px!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}#left-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}#right-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.feature-title{margin-left:1px;text-transform:uppercase;letter-spacing:.06em;margin-top:.75em;margin-bottom:.75em}.feature-header{display:flex;align-items:center;padding-top:0;font-size:1em;padding-left:0}body.floating-sidebars .sidebar{position:absolute}body{transition:background-color var(--color-fade-speed) ease-in-out}#navbar:not(:empty){display:flex;align-items:center;justify-content:space-between;padding:.5em 1em;width:100%}#main{display:flex;flex-direction:column;height:100%;width:100%;align-items:stretch;justify-content:center}#main-horizontal{display:flex;flex-direction:row;flex-grow:1;width:100%;align-items:stretch;justify-content:center}#center-content{flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0!important;transition:opacity .2s ease-in-out;pointer-events:none}#center-content>.obsidian-document{padding-left:2em;padding-right:1em;margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}body #center-content>.obsidian-document>.markdown-preview-sizer{padding-bottom:80vh;width:100%;max-width:var(--line-width);flex-basis:var(--line-width);transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document>div{width:100%!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document:not([data-type=markdown]).embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}#center-content>.obsidian-document:not([data-type=markdown]).embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6,li):has(> :is(.math,table)){overflow-x:auto!important}#center-content>.obsidian-document:not([data-type=markdown]){overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.obsidian-document[data-type=attachment]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%}.obsidian-document[data-type=attachment]>*{outline:0;border:none;box-shadow:none}.obsidian-document[data-type=attachment] :is(img){max-width:90%;max-height:90%;object-fit:contain}.obsidian-document[data-type=attachment]>:is(audio){width:100%;max-width:min(90%,var(--line-width))}.obsidian-document[data-type=attachment]>:is(embed,iframe,video){width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain}.canvas-wrapper>:is(.header,.footer){z-index:100;position:absolute;display:flex;justify-content:center;flex-direction:column;width:100%;align-items:center}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){let e=document.querySelectorAll("link[itemprop='include']");for(const t of e){let e=t.getAttribute("href");try{let o="";if(e.startsWith("https:")||e.startsWith("http:")||"file:"!=window.location.protocol){const n=await fetch(e);if(!n.ok){console.log("Could not include file: "+e),t?.remove();continue}o=await n.text()}else{const t=document.getElementById(btoa(encodeURI(e)));if(t){const e=JSON.parse(decodeURI(atob(t.getAttribute("value")??"")));o=e?.data??""}}let n=document.createRange().createContextualFragment(o);t.before(n),t.remove(),console.log("Included text: "+o),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script")));!function e(n){let l=o[n],c=n+1;l?(l&&"true"!=l.getAttribute("loaded")||n<o.length&&e(c),n<o.length&&l.addEventListener("load",(()=>e(c)))):n<o.length?e(c):t()}(0)}</script></head><body class="publish css-settings-manager mod-windows is-frameless is-hidden-frameless styled-scrollbars show-inline-title show-ribbon background-settings-workplace-theme-dark-in-the-sky background-image-settings-markdown-page-custom notebook-liked-markdown-page-grid-notebook-1 panel-page-bg-theme-light-custom panel-page-bg-theme-dark-plant hide-left-ribbon-retention-drawer toggle-divider-lines toggle-header-bottom-line bt-bubble-layout bt-bubble-layout-hide-borders remove-heading-indicator h1-toggle-underline toggle-left-aligned-content fancy-hr-no-icon custom-unordered-list custom-ordered-list list-no-border folder-icons bt-toggle-colorful-folder folder-style-change-options-colorful-default folder-colorful-one table-width-auto table-style-two link-underline-internal enable-alternative-checkboxes default-loading-page loading-text-typing-style rainbow-tag translucent-setting-panel underline-tab-style canvas-card-text-middle admonition-bg-color-same toggle-calendar-shadow style-options-for-buttons-plugin dataview-list-style-pacman memos-banner-gradient thino-frosted-style thino-background-default quiet-outline-optimize code-theme-sublime is-focused"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="parsed-feature-container" style="display: contents;"><link itemprop="include" href="site-lib/html/custom-head-content-content.html"></div><div id="main"><div id="navbar"></div><div id="main-horizontal"><div id="left-content" class="leaf" style="--sidebar-width: var(--sidebar-width-left);"><div id="left-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><div id="search-container"><div id="search-wrapper"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div aria-label="Clear search" id="search-clear-button"></div></div></div></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="left-sidebar-content" class="leaf-content"><link itemprop="include" href="site-lib/html/file-tree-content.html"></div></div><script defer="">let ls = document.querySelector("#left-sidebar"); ls.classList.toggle("is-collapsed", window.innerWidth < 768); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div></div><div id="center-content" class="leaf"><div class="obsidian-document markdown-preview-view markdown-rendered node-insert-event allow-fold-headings show-indentation-guide show-properties is-readable-line-width" data-type="markdown"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer"><div class="header"><h1 class="page-title heading inline-title" id="11._迭代器与泛型for_0">11. 迭代器与泛型for</h1><div class="data-bar"></div></div><div class="markdown-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="el-h2"><h2 data-heading="11.1 为什么需要迭代器？" dir="auto" class="heading" id="11.1_为什么需要迭代器？_0">11.1 为什么需要迭代器？</h2></div><div class="el-p"><p dir="auto">在编程中，我们经常需要遍历集合中的元素。迭代器提供了一种统一的方式来访问各种数据结构。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 不使用迭代器的问题</span>
<span class="token keyword">local</span> fruits <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"苹果"</span><span class="token punctuation">,</span> <span class="token string">"香蕉"</span><span class="token punctuation">,</span> <span class="token string">"橙子"</span><span class="token punctuation">,</span> <span class="token string">"葡萄"</span><span class="token punctuation">}</span>

<span class="token comment">-- 方式1：使用数值for循环</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"方式1 - 数值for循环:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>fruits <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  水果"</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> fruits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 问题：需要知道数据结构（是数组），需要知道长度</span>
<span class="token comment">-- 对于不是数组的表，这种方法无效</span>

<span class="token keyword">local</span> student <span class="token operator">=</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">"小明"</span><span class="token punctuation">,</span>
    age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>
    grade <span class="token operator">=</span> <span class="token string">"高三"</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 方式2：使用pairs（但不是标准迭代器方式）</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n方式2 - 使用pairs:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> k <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> v<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 问题：顺序不确定，不能控制遍历逻辑</span>

<span class="token comment">-- 迭代器可以解决这些问题！</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n使用迭代器的优势:"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  1. 统一的遍历接口"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  2. 封装遍历逻辑"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  3. 支持复杂遍历模式"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  4. 惰性求值（需要时才计算）"</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.2 迭代器基础概念" dir="auto" class="heading" id="11.2_迭代器基础概念_0">11.2 迭代器基础概念</h2></div><div class="el-h3"><h3 data-heading="11.2.1 什么是迭代器？" dir="auto" class="heading" id="11.2.1_什么是迭代器？_0">11.2.1 什么是迭代器？</h3></div><div class="el-p"><p dir="auto">迭代器是一个能够生成序列中下一个值的函数。在 Lua 中，迭代器通常遵循以下模式：</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 迭代器三要素：</span>
<span class="token comment">-- 1. 迭代器函数：每次调用返回下一个值</span>
<span class="token comment">-- 2. 不可变状态：遍历过程中不变的数据</span>
<span class="token comment">-- 3. 控制变量：当前遍历位置</span>

<span class="token comment">-- 简单的迭代器示例：生成数字序列</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">number_iterator</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">-- 控制变量（初始值）</span>
    
    <span class="token comment">-- 迭代器函数</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> i <span class="token operator">&lt;=</span> max <span class="token keyword">then</span>
            <span class="token keyword">return</span> i  <span class="token comment">-- 返回下一个值</span>
        <span class="token keyword">end</span>
        <span class="token comment">-- 返回nil表示结束</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"数字序列迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> iter <span class="token operator">=</span> <span class="token function">number_iterator</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第一次调用: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第二次调用: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第三次调用: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第四次调用: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第五次调用: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第六次调用: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- 超过范围，返回nil</span>
<span class="token comment">--[[ 输出
第一次调用: 1
第二次调用: 2
第三次调用: 3
第四次调用: 4
第五次调用: 5
第六次调用: nil
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.2.2 泛型 for 循环" dir="auto" class="heading" id="11.2.2_泛型_for_循环_0">11.2.2 泛型 for 循环</h3></div><div class="el-p"><p dir="auto">泛型 for 循环是 Lua 中使用迭代器的主要方式：</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">for</span> <span class="token operator">-</span><span class="token operator">&gt;</span>迭代器返回的参数<span class="token punctuation">:</span> any<span class="token punctuation">...</span> <span class="token keyword">in</span> 迭代器函数<span class="token punctuation">:</span> func<span class="token punctuation">,</span> 不可变状态<span class="token punctuation">:</span> any<span class="token punctuation">,</span> 控制变量<span class="token punctuation">:</span> any <span class="token keyword">do</span>
	<span class="token comment">-- 循环体</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_0">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 基本示例</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"基本示例 - 遍历数组:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> colors <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"红色"</span><span class="token punctuation">,</span> <span class="token string">"绿色"</span><span class="token punctuation">,</span> <span class="token string">"蓝色"</span><span class="token punctuation">,</span> <span class="token string">"黄色"</span><span class="token punctuation">}</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> color <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  颜色"</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> color<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
颜色1: 红色
颜色2: 绿色
颜色3: 蓝色
颜色4: 黄色
--]]</span>

<span class="token comment">-- ipairs实际上是一个迭代器工厂，返回上述三个值</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\nipairs的工作原理:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> iter<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  迭代器函数: "</span> <span class="token operator">..</span> <span class="token function">type</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  不可变状态: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  控制变量: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
迭代器函数: function
不可变状态: table: 00D99EA0
控制变量: 0
--]]</span>

<span class="token comment">-- 手动模拟泛型for循环</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n手动模拟泛型for循环:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> iterator_func<span class="token punctuation">,</span> invariant_state<span class="token punctuation">,</span> control_var <span class="token operator">=</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span>
<span class="token keyword">local</span> var1<span class="token punctuation">,</span> var2 <span class="token operator">=</span> <span class="token function">iterator_func</span><span class="token punctuation">(</span>invariant_state<span class="token punctuation">,</span> control_var<span class="token punctuation">)</span>

<span class="token keyword">while</span> var1 <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  索引: "</span> <span class="token operator">..</span> var1 <span class="token operator">..</span> <span class="token string">", 值: "</span> <span class="token operator">..</span> var2<span class="token punctuation">)</span>
    var1<span class="token punctuation">,</span> var2 <span class="token operator">=</span> <span class="token function">iterator_func</span><span class="token punctuation">(</span>invariant_state<span class="token punctuation">,</span> var1<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
索引: 1, 值: 红色
索引: 2, 值: 绿色
索引: 3, 值: 蓝色
索引: 4, 值: 黄色
--]]</span>
<span class="token comment">-- 这等价于：</span>
<span class="token comment">-- for i, color in ipairs(colors) do</span>
<span class="token comment">--     print("  索引: " .. i .. ", 值: " .. color)</span>
<span class="token comment">-- end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="工作流程" dir="auto" class="heading" id="工作流程_0">工作流程</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 初始化：获取三要素</span>
<span class="token keyword">local</span> iterator_func<span class="token punctuation">,</span> state<span class="token punctuation">,</span> control_var <span class="token operator">=</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span>

<span class="token comment">-- 2. 第一次调用，为迭代器函数传递不可变状态与控制变量</span>
control_var<span class="token punctuation">,</span> value<span class="token punctuation">...</span> <span class="token operator">=</span> <span class="token function">iterator_func</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> control_var<span class="token punctuation">)</span>  <span class="token comment">-- control_var = 0 -&gt; 1</span>

<span class="token comment">-- 3. 循环直到返回 nil</span>
<span class="token keyword">while</span> control_var <span class="token keyword">do</span>
    <span class="token comment">-- 使用控制变量和其他返回值</span>
    <span class="token function">print</span><span class="token punctuation">(</span>control_var<span class="token punctuation">,</span> value<span class="token punctuation">...</span><span class="token punctuation">)</span>
    
    <span class="token comment">-- 下一次调用，更新控制变量和其他返回值，注意：不可变状态依旧使用第一次调用时的，不会更新！</span>
    control_var<span class="token punctuation">,</span> value<span class="token punctuation">...</span> <span class="token operator">=</span> <span class="token function">iterator_func</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> control_var<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><strong>示意图</strong>：<br>
<span alt="Pasted image 20251211142754.png" src="site-lib/media/pasted-image-20251211142754.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 1125px; max-width: 100%;"><img alt="Pasted image 20251211142754.png" src="site-lib/media/pasted-image-20251211142754.png" target="_self" style="width: 1125px; max-width: 100%;"></span></p></div><div class="el-h4"><h4 data-heading="泛型 for vs 手动 while" dir="auto" class="heading" id="泛型_for_vs_手动_while_0">泛型 for vs 手动 while</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 泛型 for（简洁、安全）</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 手动实现（理解原理）</span>
<span class="token keyword">local</span> iter<span class="token punctuation">,</span> state<span class="token punctuation">,</span> var <span class="token operator">=</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token keyword">local</span> var1<span class="token punctuation">,</span> var2 <span class="token operator">=</span> <span class="token function">iter</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> var<span class="token punctuation">)</span>
<span class="token keyword">while</span> var1 <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span>
    var1<span class="token punctuation">,</span> var2 <span class="token operator">=</span> <span class="token function">iter</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> var1<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.3 Lua 内置迭代器" dir="auto" class="heading" id="11.3_Lua_内置迭代器_0">11.3 Lua 内置迭代器</h2></div><div class="el-h3"><h3 data-heading="11.3.1 ipairs - 数组迭代器" dir="auto" class="heading" id="11.3.1_ipairs_-_数组迭代器_0">11.3.1 ipairs - 数组迭代器</h3></div><div class="el-p"><p dir="auto">ipairs 用于遍历数组部分（索引从 1 开始）</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">for</span> <span class="token operator">-</span><span class="token operator">&gt;</span>索引<span class="token punctuation">:</span> int<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token operator">&gt;</span>值<span class="token punctuation">:</span> any <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>表<span class="token punctuation">:</span> table<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment">-- 循环体</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_1">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 基本用法</span>
<span class="token keyword">local</span> numbers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">}</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"遍历数组:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> num <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  numbers["</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">"] = "</span> <span class="token operator">..</span> num<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- ipairs的特性</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\nipairs的特性:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> mixed_table <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"第一个"</span><span class="token punctuation">,</span>        <span class="token comment">-- 索引1</span>
    <span class="token string">"第二个"</span><span class="token punctuation">,</span>        <span class="token comment">-- 索引2</span>
    name <span class="token operator">=</span> <span class="token string">"小明"</span><span class="token punctuation">,</span>   <span class="token comment">-- 键值对，不在数组部分</span>
    <span class="token string">"第三个"</span><span class="token punctuation">,</span>        <span class="token comment">-- 索引3</span>
    age <span class="token operator">=</span> <span class="token number">18</span>        <span class="token comment">-- 键值对</span>
<span class="token punctuation">}</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"混合表的ipairs遍历:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>mixed_table<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  索引 "</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">-- 注意：只遍历数组部分（索引1, 2, 3），跳过键值对</span>
<span class="token comment">--[[ 输出
混合表的ipairs遍历:
  索引 1: 第一个
  索引 2: 第二个
  索引 3: 第三个
--]]</span>

<span class="token comment">-- 有"洞"的数组</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n有洞数组的ipairs:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> array_with_holes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>array_with_holes<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  索引 "</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>value <span class="token keyword">or</span> <span class="token string">"nil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
  索引 1: A
--]]</span>
<span class="token comment">-- 注意：遇到第一个nil就停止，所以只输出索引1</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="实现自定义的 ipairs" dir="auto" class="heading" id="实现自定义的_ipairs_0">实现自定义的 ipairs</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 实现自定义的ipairs（理解原理）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">my_ipairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iterator</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> value <span class="token operator">=</span> state<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        
        <span class="token keyword">if</span> value <span class="token operator">~=</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> index<span class="token punctuation">,</span> value
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> iterator<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n自定义ipairs测试:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">my_ipairs</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  numbers["</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">"] = "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
numbers[1] = 10
numbers[2] = 20
numbers[3] = 30
numbers[4] = 40
numbers[5] = 50
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.3.2 pairs - 通用迭代器" dir="auto" class="heading" id="11.3.2_pairs_-_通用迭代器_0">11.3.2 pairs - 通用迭代器</h3></div><div class="el-p"><p dir="auto">pairs用于遍历表的所有键值对。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">for</span> <span class="token operator">-</span><span class="token operator">&gt;</span>键<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token operator">&gt;</span>键值<span class="token punctuation">:</span> any <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>表<span class="token punctuation">:</span> table<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment">-- 循环体</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_2">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 基本用法</span>
<span class="token keyword">local</span> student <span class="token operator">=</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">"李雷"</span><span class="token punctuation">,</span>
    age <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
    grade <span class="token operator">=</span> <span class="token string">"高一"</span><span class="token punctuation">,</span>
    class <span class="token operator">=</span> <span class="token string">"1班"</span><span class="token punctuation">,</span>
    scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"遍历学生信息:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"table"</span> <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">": [表]"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- pairs的特性</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\npairs的特性:"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  1. 遍历所有键值对（包括数组部分和字典部分）"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  2. 遍历顺序不确定（依赖表的实现）"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  3. 可以遍历任何类型的键（除了nil）"</span><span class="token punctuation">)</span>

<span class="token comment">-- 包含各种类型键的表</span>
<span class="token keyword">local</span> complex_table <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"数字键1"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"字符串键1"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token keyword">true</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"布尔键"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"函数键"</span><span class="token punctuation">,</span>  <span class="token comment">-- 不常见但可能</span>
    normal <span class="token operator">=</span> <span class="token string">"普通键"</span>
<span class="token punctuation">}</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n复杂键表的pairs遍历:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>complex_table<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> key_type <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
    <span class="token keyword">if</span> key_type <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  函数键: "</span> <span class="token operator">..</span> v<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> key_type <span class="token operator">..</span> <span class="token string">"键 '"</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"': "</span> <span class="token operator">..</span> v<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="实现自定义的pairs（简化版）" dir="auto" class="heading" id="实现自定义的pairs（简化版）_0">实现自定义的pairs（简化版）</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">my_pairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iterator</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 获取下一个键值对</span>
        <span class="token keyword">local</span> next_key<span class="token punctuation">,</span> next_value <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> next_key<span class="token punctuation">,</span> next_value
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> iterator<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n自定义pairs测试:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">my_pairs</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> count <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">then</span>  <span class="token comment">-- 只显示前3个</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  总键值对数: "</span> <span class="token operator">..</span> count<span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
scores: table: 00E09E50
name: 李雷
class: 1班
总键值对数: 5
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="next 函数的使用" dir="auto" class="heading" id="next_函数的使用_0">next 函数的使用</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- next函数的使用</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\nnext函数演示:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token punctuation">{</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token keyword">local</span> key<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>  <span class="token comment">-- 第一个键值对</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第一个: "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">" = "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>

key<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> key<span class="token punctuation">)</span>   <span class="token comment">-- 第二个键值对</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第二个: "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">" = "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>

key<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> key<span class="token punctuation">)</span>   <span class="token comment">-- 第三个键值对</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第三个: "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">" = "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>

key<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> key<span class="token punctuation">)</span>   <span class="token comment">-- 没有更多，返回nil</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  第四个: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">" = "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
第一个: a = 1
第二个: c = 3
第三个: b = 2
第四个: nil = nil
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.3.3 string.gmatch - 字符串迭代器" dir="auto" class="heading" id="11.3.3_string.gmatch_-_字符串迭代器_0">11.3.3 string.gmatch - 字符串迭代器</h3></div><div class="el-p"><p dir="auto">string.gmatch 用于匹配多个模式。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded">string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>字符串<span class="token punctuation">:</span> str<span class="token punctuation">,</span> 匹配模式<span class="token punctuation">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> 迭代器函数<span class="token punctuation">:</span> func
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_3">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 基本用法：遍历单词</span>
<span class="token keyword">local</span> sentence <span class="token operator">=</span> <span class="token string">"The quick brown fox jumps over the lazy dog"</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"句子: "</span> <span class="token operator">..</span> sentence<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n遍历单词:"</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> word <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>sentence<span class="token punctuation">,</span> <span class="token string">"%a+"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  单词: "</span> <span class="token operator">..</span> word<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 提取特定模式</span>
<span class="token keyword">local</span> data <span class="token operator">=</span> <span class="token string">"姓名: 张三, 年龄: 25, 城市: 北京, 职业: 工程师"</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n提取键值对:"</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">"(%a+):%s*([^,]+)"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 解析CSV行</span>
<span class="token keyword">local</span> csv_line <span class="token operator">=</span> <span class="token string">"苹果,5,2.5,12.5"</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n解析CSV:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">for</span> field <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>csv_line<span class="token punctuation">,</span> <span class="token string">"([^,]+)"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  字段"</span> <span class="token operator">..</span> index <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> field<span class="token punctuation">)</span>
    index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">end</span>

<span class="token comment">-- 解析多行文本</span>
<span class="token keyword">local</span> multiline_text <span class="token operator">=</span> <span class="token string">[[
第一行内容
第二行内容
第三行内容
第四行内容
]]</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n遍历文本行:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> line_number <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>multiline_text<span class="token punctuation">,</span> <span class="token string">"([^\n]+)"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  行"</span> <span class="token operator">..</span> line_number <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> line<span class="token punctuation">)</span>
    line_number <span class="token operator">=</span> line_number <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">end</span>

<span class="token comment">-- 提取URL参数</span>
<span class="token keyword">local</span> url <span class="token operator">=</span> <span class="token string">"https://example.com/search?q=lua&amp;page=2&amp;sort=recent"</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n提取URL参数:"</span><span class="token punctuation">)</span>

<span class="token comment">-- 找到查询字符串部分</span>
<span class="token keyword">local</span> query_string <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"%?(.+)"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token keyword">for</span> param <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>query_string<span class="token punctuation">,</span> <span class="token string">"([^&amp;]+)"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> key<span class="token punctuation">,</span> value <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> <span class="token string">"([^=]+)=?(.*)"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  参数: "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">" = "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>value <span class="token operator">~=</span> <span class="token string">""</span> <span class="token keyword">and</span> value <span class="token keyword">or</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 实现自定义的字符串分割迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">split_string</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> delimiter<span class="token punctuation">)</span>
    delimiter <span class="token operator">=</span> delimiter <span class="token keyword">or</span> <span class="token string">" "</span>
    <span class="token keyword">local</span> pattern <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"([^%s]+)"</span><span class="token punctuation">,</span> delimiter<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n自定义字符串分割:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> text <span class="token operator">=</span> <span class="token string">"苹果 香蕉 橙子 葡萄 西瓜"</span>
<span class="token keyword">for</span> fruit <span class="token keyword">in</span> <span class="token function">split_string</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  水果: "</span> <span class="token operator">..</span> fruit<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
水果: 苹果
水果: 香蕉
水果: 橙子
水果: 葡萄
水果: 西瓜
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="实现自定义字符串迭代器" dir="auto" class="heading" id="实现自定义字符串迭代器_0">实现自定义字符串迭代器</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 更高级的字符串迭代器：逐字符遍历</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">chars</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    <span class="token keyword">local</span> chars <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">local</span> len <span class="token operator">=</span> <span class="token operator">#</span>str

    <span class="token keyword">while</span> i <span class="token operator">&lt;=</span> len <span class="token keyword">do</span>
        <span class="token keyword">local</span> b <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">byte</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">local</span> char_len

        <span class="token comment">-- UTF-8 字符长度检测</span>
        <span class="token keyword">if</span> b <span class="token operator">&lt;</span> <span class="token number">128</span> <span class="token keyword">then</span> <span class="token comment">-- ASCII</span>
            char_len <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">elseif</span> b <span class="token operator">&gt;=</span> <span class="token number">194</span> <span class="token keyword">and</span> b <span class="token operator">&lt;=</span> <span class="token number">223</span> <span class="token keyword">then</span>
            char_len <span class="token operator">=</span> <span class="token number">2</span>
        <span class="token keyword">elseif</span> b <span class="token operator">&gt;=</span> <span class="token number">224</span> <span class="token keyword">and</span> b <span class="token operator">&lt;=</span> <span class="token number">239</span> <span class="token keyword">then</span>
            char_len <span class="token operator">=</span> <span class="token number">3</span>
        <span class="token keyword">elseif</span> b <span class="token operator">&gt;=</span> <span class="token number">240</span> <span class="token keyword">and</span> b <span class="token operator">&lt;=</span> <span class="token number">244</span> <span class="token keyword">then</span>
            char_len <span class="token operator">=</span> <span class="token number">4</span>
        <span class="token keyword">else</span>
            char_len <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">-- 无效字节</span>
        <span class="token keyword">end</span>

        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>chars<span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i <span class="token operator">+</span> char_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> char_len
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> chars
<span class="token keyword">end</span>

<span class="token keyword">local</span> chars <span class="token operator">=</span> <span class="token function">chars</span><span class="token punctuation">(</span><span class="token string">"你好 Hello 世界!"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  字符 "</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": '"</span> <span class="token operator">..</span> char <span class="token operator">..</span> <span class="token string">"' (字节长度: "</span> <span class="token operator">..</span> <span class="token operator">#</span>char <span class="token operator">..</span> <span class="token string">", ASCII: "</span> <span class="token operator">..</span> string<span class="token punctuation">.</span><span class="token function">byte</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">")"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
字符 1: '你' (字节长度: 3, ASCII: 228)
字符 2: '好' (字节长度: 3, ASCII: 229)
字符 3: ' ' (字节长度: 1, ASCII: 32)
字符 4: 'H' (字节长度: 1, ASCII: 72)
字符 5: 'e' (字节长度: 1, ASCII: 101)
字符 6: 'l' (字节长度: 1, ASCII: 108)
字符 7: 'l' (字节长度: 1, ASCII: 108)
字符 8: 'o' (字节长度: 1, ASCII: 111)
字符 9: ' ' (字节长度: 1, ASCII: 32)
字符 10: '世' (字节长度: 3, ASCII: 228)
字符 11: '界' (字节长度: 3, ASCII: 231)
字符 12: '!' (字节长度: 1, ASCII: 33)
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.4 无状态迭代器" dir="auto" class="heading" id="11.4_无状态迭代器_0">11.4 无状态迭代器</h2></div><div class="el-p"><p dir="auto">无状态迭代器不保存任何状态，所有状态都通过参数传递。</p></div><div class="el-h3"><h3 data-heading="11.4.1 理解无状态迭代器" dir="auto" class="heading" id="11.4.1_理解无状态迭代器_0">11.4.1 理解无状态迭代器</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 示例：遍历数组的无状态迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">array_iterator</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">local</span> value <span class="token operator">=</span> t<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    
    <span class="token keyword">if</span> value <span class="token keyword">then</span>
        <span class="token keyword">return</span> index<span class="token punctuation">,</span> value
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iter_array</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">return</span> array_iterator<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token keyword">end</span>

<span class="token comment">-- 使用</span>
<span class="token keyword">local</span> fruits <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"苹果"</span><span class="token punctuation">,</span> <span class="token string">"香蕉"</span><span class="token punctuation">,</span> <span class="token string">"橙子"</span><span class="token punctuation">}</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"无状态迭代器遍历数组:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> fruit <span class="token keyword">in</span> <span class="token function">iter_array</span><span class="token punctuation">(</span>fruits<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  fruits["</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">"] = "</span> <span class="token operator">..</span> fruit<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 对比：有状态迭代器（使用闭包）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">stateful_array_iterator</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> value <span class="token operator">=</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        
        <span class="token keyword">if</span> value <span class="token keyword">then</span>
            <span class="token keyword">return</span> i<span class="token punctuation">,</span> value
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n有状态迭代器遍历数组:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> fruit <span class="token keyword">in</span> <span class="token function">stateful_array_iterator</span><span class="token punctuation">(</span>fruits<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  fruits["</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">"] = "</span> <span class="token operator">..</span> fruit<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 无状态迭代器的优势</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n无状态迭代器优势:"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  1. 更高效：不创建闭包"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  2. 可复用：相同的迭代器函数可用于多个表"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  3. 更简单：状态管理由泛型for处理"</span><span class="token punctuation">)</span>

<span class="token comment">-- 实现一个无状态迭代器来遍历表的键值对</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">next_pair</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iter_pairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">return</span> next_pair<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n无状态pairs迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> colors <span class="token operator">=</span> <span class="token punctuation">{</span>red <span class="token operator">=</span> <span class="token string">"红色"</span><span class="token punctuation">,</span> green <span class="token operator">=</span> <span class="token string">"绿色"</span><span class="token punctuation">,</span> blue <span class="token operator">=</span> <span class="token string">"蓝色"</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">iter_pairs</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> value<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.4.2 创建无状态迭代器" dir="auto" class="heading" id="11.4.2_创建无状态迭代器_0">11.4.2 创建无状态迭代器</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 创建各种无状态迭代器</span>

<span class="token comment">-- 1. 数字范围迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">range_iterator</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> current<span class="token punctuation">)</span>
    current <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">if</span> current <span class="token operator">&lt;=</span> limit <span class="token keyword">then</span>
        <span class="token keyword">return</span> current
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">range</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> to<span class="token punctuation">)</span>
    <span class="token keyword">return</span> range_iterator<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">-- 注意：控制变量初始化为from-1</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"数字范围迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  i = "</span> <span class="token operator">..</span> i<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
i = 5
i = 6
i = 7
i = 8
i = 9
i = 10
--]]</span>

<span class="token comment">-- 2. 质数迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">is_prime</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span>
    <span class="token keyword">end</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span>
    <span class="token keyword">end</span>
    <span class="token keyword">if</span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span>
    <span class="token keyword">end</span>

    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> n <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">prime_iterator</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> current<span class="token punctuation">)</span>
    <span class="token comment">-- 找到下一个质数</span>
    <span class="token keyword">repeat</span>
        current <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> current <span class="token operator">&gt;</span> limit <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
    <span class="token keyword">until</span> <span class="token function">is_prime</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>

    <span class="token keyword">return</span> current
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">primes</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
    <span class="token keyword">return</span> prime_iterator<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">-- 从1开始（实际从2开始检查）</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n质数迭代器（小于50的质数）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> prime <span class="token keyword">in</span> <span class="token function">primes</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>prime <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 输出 2 3 5 7 11 13 17 19 23 29 31 37 41 43 47 </span>

<span class="token comment">-- 3. 文件行迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">lines_iterator</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> lines<span class="token punctuation">)</span>
    <span class="token keyword">return</span> table<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">lines</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token comment">-- 返回迭代器函数、文件和nil（初始控制变量）</span>
    <span class="token keyword">return</span> lines_iterator<span class="token punctuation">,</span> file<span class="token punctuation">,</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n文件行迭代器（模拟）:"</span><span class="token punctuation">)</span>
<span class="token comment">-- 为了演示，我们模拟文件内容</span>
<span class="token keyword">local</span> mock_file_content <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"第一行内容"</span><span class="token punctuation">,</span>
    <span class="token string">"第二行内容"</span><span class="token punctuation">,</span>
    <span class="token string">"第三行内容"</span><span class="token punctuation">,</span>
    <span class="token keyword">nil</span> <span class="token comment">-- 文件结束</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token function">lines</span><span class="token punctuation">(</span>mock_file_content<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> line<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
第一行内容
第二行内容
第三行内容
--]]</span>

<span class="token comment">-- 4. 表格行迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">table_rows_iterator</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> row_index<span class="token punctuation">)</span>
    row_index <span class="token operator">=</span> row_index <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">local</span> row <span class="token operator">=</span> t<span class="token punctuation">[</span>row_index<span class="token punctuation">]</span>
    <span class="token keyword">if</span> row <span class="token keyword">then</span>
        <span class="token keyword">return</span> row_index<span class="token punctuation">,</span> <span class="token function">unpack</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">table_rows</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">return</span> table_rows_iterator<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> data_table <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"男"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">"李四"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">"女"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">"王五"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"男"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n表格行迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> row_index<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> gender <span class="token keyword">in</span> <span class="token function">table_rows</span><span class="token punctuation">(</span>data_table<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  行%d: 姓名=%s, 年龄=%d, 性别=%s"</span><span class="token punctuation">,</span>
        row_index<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> gender<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
行1: 姓名=张三, 年龄=18, 性别=男
行2: 姓名=李四, 年龄=19, 性别=女
行3: 姓名=王五, 年龄=20, 性别=男
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.5 有状态迭代器" dir="auto" class="heading" id="11.5_有状态迭代器_0">11.5 有状态迭代器</h2></div><div class="el-p"><p dir="auto">有状态迭代器使用闭包来保存状态，更灵活但可能效率稍低。</p></div><div class="el-h3"><h3 data-heading="11.5.1 创建有状态迭代器" dir="auto" class="heading" id="11.5.1_创建有状态迭代器_0">11.5.1 创建有状态迭代器</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 有状态迭代器：使用闭包保存状态</span>

<span class="token comment">-- 1. 计数器迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">counter</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
    <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> count <span class="token operator">&lt;=</span> max <span class="token keyword">then</span>
            <span class="token keyword">return</span> count
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"计数器迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  计数: "</span> <span class="token operator">..</span> num<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
  计数: 1
  计数: 2
  计数: 3
  计数: 4
  计数: 5
--]]</span>

<span class="token comment">-- 2. 斐波那契数列迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">fibonacci_iterator</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
    <span class="token keyword">local</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> count <span class="token operator">&gt;=</span> limit <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">local</span> result <span class="token operator">=</span> a
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b
        count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
        
        <span class="token keyword">return</span> result
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n斐波那契数列迭代器（前10项）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token function">fibonacci_iterator</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>num <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 输出</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">13</span> <span class="token number">21</span> <span class="token number">34</span> 

<span class="token comment">-- 3. 随机数迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">random_iterator</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
    math<span class="token punctuation">.</span><span class="token function">randomseed</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> generated <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> generated <span class="token operator">&gt;=</span> count <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
        
        generated <span class="token operator">=</span> generated <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n随机数迭代器（5个1-100的随机数）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token function">random_iterator</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>num <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 输出 68 74 70 95 72（以实际为准）</span>

<span class="token comment">-- 4. 目录遍历迭代器（模拟）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">directory_iterator</span><span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span>
    <span class="token comment">-- 模拟的目录内容</span>
    <span class="token keyword">local</span> mock_files <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"file1.txt"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"file"</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"file2.txt"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"file"</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"subdir1"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"dir"</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"file3.txt"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"file"</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">3072</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> item <span class="token operator">=</span> mock_files<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        
        <span class="token keyword">if</span> item <span class="token keyword">then</span>
            <span class="token keyword">return</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> item<span class="token punctuation">.</span>type<span class="token punctuation">,</span> item<span class="token punctuation">.</span>size
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n目录遍历迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> filename<span class="token punctuation">,</span> filetype<span class="token punctuation">,</span> filesize <span class="token keyword">in</span> <span class="token function">directory_iterator</span><span class="token punctuation">(</span><span class="token string">"/mock/path"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> type_desc <span class="token operator">=</span> filetype <span class="token operator">==</span> <span class="token string">"dir"</span> <span class="token keyword">and</span> <span class="token string">"目录"</span> <span class="token keyword">or</span> <span class="token string">"文件"</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %s (%s, %d 字节)"</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> type_desc<span class="token punctuation">,</span> filesize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
file1.txt (文件, 1024 字节)
file2.txt (文件, 2048 字节)
subdir1 (目录, 0 字节)
file3.txt (文件, 3072 字节)
--]]</span>

<span class="token comment">-- 5. 数据库查询结果迭代器（模拟）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">db_query_iterator</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
    <span class="token comment">-- 模拟查询结果</span>
    <span class="token keyword">local</span> mock_results <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"张三"</span><span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"李四"</span><span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"王五"</span><span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"赵六"</span><span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">35</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> row <span class="token operator">=</span> mock_results<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        
        <span class="token keyword">if</span> row <span class="token keyword">then</span>
            <span class="token keyword">return</span> row<span class="token punctuation">.</span>id<span class="token punctuation">,</span> row<span class="token punctuation">.</span>name<span class="token punctuation">,</span> row<span class="token punctuation">.</span>age
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n数据库查询迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age <span class="token keyword">in</span> <span class="token function">db_query_iterator</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM users"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  ID: %d, 姓名: %s, 年龄: %d"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
ID: 1, 姓名: 张三, 年龄: 25
ID: 2, 姓名: 李四, 年龄: 30
ID: 3, 姓名: 王五, 年龄: 28
ID: 4, 姓名: 赵六, 年龄: 35
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.5.2 复杂的有状态迭代器" dir="auto" class="heading" id="11.5.2_复杂的有状态迭代器_0">11.5.2 复杂的有状态迭代器</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 分页数据迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">paged_data_iterator</span><span class="token punctuation">(</span>page_size<span class="token punctuation">,</span> total_items<span class="token punctuation">)</span>
    <span class="token keyword">local</span> current_page <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> current_item <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- 计算当前页</span>
        <span class="token keyword">if</span> current_item <span class="token operator">%</span> page_size <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
            current_page <span class="token operator">=</span> current_page <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  加载第%d页..."</span><span class="token punctuation">,</span> current_page<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        
        current_item <span class="token operator">=</span> current_item <span class="token operator">+</span> <span class="token number">1</span>
        
        <span class="token keyword">if</span> current_item <span class="token operator">&gt;</span> total_items <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
        
        <span class="token comment">-- 模拟数据项</span>
        <span class="token keyword">return</span> current_item<span class="token punctuation">,</span> <span class="token string">"项目"</span> <span class="token operator">..</span> current_item
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"分页数据迭代器（每页3项，共10项）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> id<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token function">paged_data_iterator</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"    ID: %d, 名称: %s"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
加载第1页...
  ID: 1, 名称: 项目1
  ID: 2, 名称: 项目2
  ID: 3, 名称: 项目3
加载第2页...
  ID: 4, 名称: 项目4
  ID: 5, 名称: 项目5
  ID: 6, 名称: 项目6
加载第3页...
  ID: 7, 名称: 项目7
  ID: 8, 名称: 项目8
  ID: 9, 名称: 项目9
加载第4页...
  ID: 10, 名称: 项目10
--]]</span>

<span class="token comment">-- 2. 过滤器迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">filtered_iterator</span><span class="token punctuation">(</span>original_iterator<span class="token punctuation">,</span> filter_func<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
            <span class="token keyword">local</span> values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function">original_iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            
            <span class="token keyword">if</span> values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span> <span class="token keyword">nil</span>  <span class="token comment">-- 原始迭代器结束</span>
            <span class="token keyword">end</span>
            
            <span class="token keyword">if</span> <span class="token function">filter_func</span><span class="token punctuation">(</span><span class="token function">unpack</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span> <span class="token function">unpack</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
            <span class="token keyword">end</span>
            <span class="token comment">-- 如果不满足条件，继续下一个</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n过滤器迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> numbers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">number_iterator_from_table</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> t<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 只返回偶数</span>
<span class="token keyword">local</span> even_filter <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"偶数过滤器:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token function">filtered_iterator</span><span class="token punctuation">(</span><span class="token function">number_iterator_from_table</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">,</span> even_filter<span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>num <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 输出 2 4 6 8 10</span>

<span class="token comment">-- 3. 转换迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">transformed_iterator</span><span class="token punctuation">(</span>original_iterator<span class="token punctuation">,</span> transform_func<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function">original_iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">return</span> <span class="token function">transform_func</span><span class="token punctuation">(</span><span class="token function">unpack</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n转换迭代器:"</span><span class="token punctuation">)</span>
<span class="token comment">-- 将数字转换为平方</span>
<span class="token keyword">local</span> square_transform <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> num<span class="token punctuation">,</span> num <span class="token operator">*</span> num
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"平方转换:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> num<span class="token punctuation">,</span> square <span class="token keyword">in</span> <span class="token function">transformed_iterator</span><span class="token punctuation">(</span><span class="token function">number_iterator_from_table</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">,</span> square_transform<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %d² = %d"</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> square<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
1² = 1
2² = 4
3² = 9
4² = 16
5² = 25
6² = 36
7² = 49
8² = 64
9² = 81
10² = 100
--]]</span>

<span class="token comment">-- 4. 组合多个迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">zip_iterators</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> iterators <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> current_values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- 收集每个迭代器的下一个值</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> iter <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>iterators<span class="token punctuation">)</span> <span class="token keyword">do</span>
            current_values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            
            <span class="token comment">-- 如果任何一个迭代器结束，就全部结束</span>
            <span class="token keyword">if</span> current_values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span> <span class="token keyword">nil</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        
        <span class="token comment">-- 返回所有值</span>
        <span class="token keyword">local</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> values <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>current_values<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">for</span> j<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token keyword">do</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">return</span> <span class="token function">unpack</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n组合迭代器（zip）:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> names <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token string">"李四"</span><span class="token punctuation">,</span> <span class="token string">"王五"</span><span class="token punctuation">}</span>
<span class="token keyword">local</span> ages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">}</span>
<span class="token keyword">local</span> cities <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"广州"</span><span class="token punctuation">}</span>

<span class="token keyword">local</span> name_iter <span class="token operator">=</span> <span class="token function">number_iterator_from_table</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span>
<span class="token keyword">local</span> age_iter <span class="token operator">=</span> <span class="token function">number_iterator_from_table</span><span class="token punctuation">(</span>ages<span class="token punctuation">)</span>
<span class="token keyword">local</span> city_iter <span class="token operator">=</span> <span class="token function">number_iterator_from_table</span><span class="token punctuation">(</span>cities<span class="token punctuation">)</span>

<span class="token keyword">for</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city <span class="token keyword">in</span> <span class="token function">zip_iterators</span><span class="token punctuation">(</span>name_iter<span class="token punctuation">,</span> age_iter<span class="token punctuation">,</span> city_iter<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  姓名: %s, 年龄: %d, 城市: %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
姓名: 张三, 年龄: 25, 城市: 北京
姓名: 李四, 年龄: 30, 城市: 上海
姓名: 王五, 年龄: 28, 城市: 广州
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.6 高级迭代器模式" dir="auto" class="heading" id="11.6_高级迭代器模式_0">11.6 高级迭代器模式</h2></div><div class="el-h3"><h3 data-heading="11.6.1 树遍历迭代器" dir="auto" class="heading" id="11.6.1_树遍历迭代器_0">11.6.1 树遍历迭代器</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 树结构的迭代器</span>
<span class="token comment">-- 定义树节点</span>
<span class="token keyword">local</span> tree_node <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">local</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> value<span class="token punctuation">,</span>
        children <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        add_child <span class="token operator">=</span> tree_node<span class="token punctuation">.</span>add_child
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> node
<span class="token keyword">end</span>

<span class="token keyword">function</span> tree_node<span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
    <span class="token keyword">return</span> self
<span class="token keyword">end</span>

<span class="token comment">-- 创建一棵树</span>
<span class="token keyword">local</span> root <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> node_a <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> node_b <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> node_a1 <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> node_a2 <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"a2"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> node_b1 <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"b1"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> node_b2 <span class="token operator">=</span> tree_node<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"b2"</span><span class="token punctuation">)</span>

root<span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>node_a<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>node_b<span class="token punctuation">)</span>
node_a<span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>node_a1<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>node_a2<span class="token punctuation">)</span>
node_b<span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>node_b1<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">add_child</span><span class="token punctuation">(</span>node_b2<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">[[ 创建树：
   root
   /  \
  A    B
 / \  / \
a1 a2 b1 b2
--]]</span><span class="token punctuation">)</span>

<span class="token comment">-- 先序遍历迭代器（沿着一个分支走到底，再遍历下一个分支）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">preorder_iterator</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token keyword">local</span> stack <span class="token operator">=</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span>
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> index <span class="token operator">&gt;</span> <span class="token operator">#</span>stack <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>

        <span class="token keyword">local</span> current <span class="token operator">=</span> stack<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token comment">-- 将子节点逆序加入栈（保证左子节点先处理）</span>
        <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token operator">#</span>current<span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">do</span>
            table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> index<span class="token punctuation">,</span> current<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">return</span> current<span class="token punctuation">.</span>value
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"先序遍历:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> value <span class="token keyword">in</span> <span class="token function">preorder_iterator</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>value <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 广度优先遍历迭代器（按层级遍历，先访问同一层的所有节点）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">bfs_iterator</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token keyword">local</span> queue <span class="token operator">=</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span>
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> index <span class="token operator">&gt;</span> <span class="token operator">#</span>queue <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>

        <span class="token keyword">local</span> current <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token comment">-- 将子节点加入队列</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> child <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token keyword">do</span>
            table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
        <span class="token keyword">end</span>

        <span class="token keyword">return</span> current<span class="token punctuation">.</span>value
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"广度优先遍历:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> value <span class="token keyword">in</span> <span class="token function">bfs_iterator</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>value <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
创建树：
   root
   /  \
  A    B
 / \  / \
a1 a2 b1 b2

先序遍历:
root A a1 a2 B b1 b2 
广度优先遍历:
root A B a1 a2 b1 b2 
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.6.2 图形遍历迭代器" dir="auto" class="heading" id="11.6.2_图形遍历迭代器_0">11.6.2 图形遍历迭代器</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 图结构的迭代器</span>
<span class="token comment">-- 定义图</span>
<span class="token keyword">local</span> Graph <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> Graph<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> graph <span class="token operator">=</span> <span class="token punctuation">{</span>
        vertices <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        edges <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        add_vertex <span class="token operator">=</span> Graph<span class="token punctuation">.</span>add_vertex<span class="token punctuation">,</span>
        add_edge <span class="token operator">=</span> Graph<span class="token punctuation">.</span>add_edge
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> graph
<span class="token keyword">end</span>

<span class="token keyword">function</span> Graph<span class="token punctuation">:</span><span class="token function">add_vertex</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> name<span class="token punctuation">,</span> neighbors <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> Graph<span class="token punctuation">:</span><span class="token function">add_edge</span><span class="token punctuation">(</span>v1_name<span class="token punctuation">,</span> v2_name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span>
    weight <span class="token operator">=</span> weight <span class="token keyword">or</span> <span class="token number">1</span>

    <span class="token keyword">local</span> v1 <span class="token operator">=</span> self<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>v1_name<span class="token punctuation">]</span>
    <span class="token keyword">local</span> v2 <span class="token operator">=</span> self<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>v2_name<span class="token punctuation">]</span>

    <span class="token keyword">if</span> v1 <span class="token keyword">and</span> v2 <span class="token keyword">then</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>neighbors<span class="token punctuation">,</span> <span class="token punctuation">{</span> vertex <span class="token operator">=</span> v2<span class="token punctuation">,</span> weight <span class="token operator">=</span> weight <span class="token punctuation">}</span><span class="token punctuation">)</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>v2<span class="token punctuation">.</span>neighbors<span class="token punctuation">,</span> <span class="token punctuation">{</span> vertex <span class="token operator">=</span> v1<span class="token punctuation">,</span> weight <span class="token operator">=</span> weight <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">-- 无向图</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> <span class="token keyword">false</span>
<span class="token keyword">end</span>

<span class="token comment">-- 创建图</span>
<span class="token keyword">local</span> graph <span class="token operator">=</span> Graph<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token string">"E"</span><span class="token punctuation">)</span>

graph<span class="token punctuation">:</span><span class="token function">add_edge</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_edge</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_edge</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_edge</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
graph<span class="token punctuation">:</span><span class="token function">add_edge</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">[[创建图：
A -- B (1)
|    |
C    D (3)
 \  /
  D (1)
  |
  E (2)
]]</span><span class="token punctuation">)</span>

<span class="token comment">-- 深度优先遍历图的迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">graph_dfs_iterator</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> start_vertex_name<span class="token punctuation">)</span>
    <span class="token keyword">local</span> visited <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> stack <span class="token operator">=</span> <span class="token punctuation">{</span> graph<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>start_vertex_name<span class="token punctuation">]</span> <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token operator">#</span>stack <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">do</span>
            <span class="token keyword">local</span> current <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">then</span>
                visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>

                <span class="token comment">-- 将未访问的邻居加入栈</span>
                <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token operator">#</span>current<span class="token punctuation">.</span>neighbors<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">do</span>
                    <span class="token keyword">local</span> neighbor <span class="token operator">=</span> current<span class="token punctuation">.</span>neighbors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>vertex
                    <span class="token keyword">if</span> <span class="token keyword">not</span> visited<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">then</span>
                        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> neighbor<span class="token punctuation">)</span>
                    <span class="token keyword">end</span>
                <span class="token keyword">end</span>

                <span class="token keyword">return</span> current<span class="token punctuation">.</span>name
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"图的深度优先遍历（从A开始）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> vertex_name <span class="token keyword">in</span> <span class="token function">graph_dfs_iterator</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>vertex_name <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 广度优先遍历图的迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">graph_bfs_iterator</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> start_vertex_name<span class="token punctuation">)</span>
    <span class="token keyword">local</span> visited <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> queue <span class="token operator">=</span> <span class="token punctuation">{</span> graph<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>start_vertex_name<span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token keyword">while</span> index <span class="token operator">&lt;=</span> <span class="token operator">#</span>queue <span class="token keyword">do</span>
	        <span class="token keyword">local</span> current <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
	        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
	
	        <span class="token keyword">if</span> <span class="token keyword">not</span> visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">then</span>
	            visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>
	            <span class="token comment">-- 将未访问的邻居加入队列</span>
	            <span class="token keyword">for</span> _<span class="token punctuation">,</span> neighbor_info <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>neighbors<span class="token punctuation">)</span> <span class="token keyword">do</span>
	                <span class="token keyword">local</span> neighbor <span class="token operator">=</span> neighbor_info<span class="token punctuation">.</span>vertex
	                <span class="token keyword">if</span> <span class="token keyword">not</span> visited<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">then</span>
	                    table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> neighbor<span class="token punctuation">)</span>
	                <span class="token keyword">end</span>
	            <span class="token keyword">end</span>
	            <span class="token keyword">return</span> current<span class="token punctuation">.</span>name
	        <span class="token keyword">end</span>
	    <span class="token keyword">end</span>
	    <span class="token keyword">return</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"图的广度优先遍历（从A开始）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> vertex_name <span class="token keyword">in</span> <span class="token function">graph_bfs_iterator</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>vertex_name <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 最短路径迭代器（Dijkstra算法简化版）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">shortest_path_iterator</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> start_vertex_name<span class="token punctuation">,</span> end_vertex_name<span class="token punctuation">)</span>
    <span class="token keyword">local</span> distances <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> previous <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> unvisited <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">-- 初始化</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span> vertex <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>vertices<span class="token punctuation">)</span> <span class="token keyword">do</span>
        distances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>huge <span class="token comment">-- 无穷大</span>
        previous<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>unvisited<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    distances<span class="token punctuation">[</span>start_vertex_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token operator">#</span>unvisited <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">do</span>
            <span class="token comment">-- 找到未访问节点中距离最小的</span>
            <span class="token keyword">local</span> min_distance <span class="token operator">=</span> math<span class="token punctuation">.</span>huge
            <span class="token keyword">local</span> min_vertex <span class="token operator">=</span> <span class="token keyword">nil</span>
            <span class="token keyword">local</span> min_index <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>unvisited<span class="token punctuation">)</span> <span class="token keyword">do</span>
                <span class="token keyword">if</span> distances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">&lt;</span> min_distance <span class="token keyword">then</span>
                    min_distance <span class="token operator">=</span> distances<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
                    min_vertex <span class="token operator">=</span> graph<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
                    min_index <span class="token operator">=</span> i
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> min_vertex <span class="token keyword">or</span> min_distance <span class="token operator">==</span> math<span class="token punctuation">.</span>huge <span class="token keyword">then</span>
                <span class="token keyword">break</span> <span class="token comment">-- 没有可达的节点了</span>
            <span class="token keyword">end</span>

            <span class="token comment">-- 从unvisited中移除</span>
            table<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>unvisited<span class="token punctuation">,</span> min_index<span class="token punctuation">)</span>

            <span class="token comment">-- 如果到达目标节点，构建路径并返回</span>
            <span class="token keyword">if</span> min_vertex<span class="token punctuation">.</span>name <span class="token operator">==</span> end_vertex_name <span class="token keyword">then</span>
                <span class="token keyword">local</span> path <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                <span class="token keyword">local</span> current <span class="token operator">=</span> end_vertex_name

                <span class="token keyword">while</span> current <span class="token keyword">do</span>
                    table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span>
                    current <span class="token operator">=</span> previous<span class="token punctuation">[</span>current<span class="token punctuation">]</span>
                <span class="token keyword">end</span>

                <span class="token keyword">return</span> path<span class="token punctuation">,</span> distances<span class="token punctuation">[</span>end_vertex_name<span class="token punctuation">]</span>
            <span class="token keyword">end</span>

            <span class="token comment">-- 更新邻居的距离</span>
            <span class="token keyword">for</span> _<span class="token punctuation">,</span> neighbor_info <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>min_vertex<span class="token punctuation">.</span>neighbors<span class="token punctuation">)</span> <span class="token keyword">do</span>
                <span class="token keyword">local</span> neighbor <span class="token operator">=</span> neighbor_info<span class="token punctuation">.</span>vertex
                <span class="token keyword">local</span> alt <span class="token operator">=</span> distances<span class="token punctuation">[</span>min_vertex<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">+</span> neighbor_info<span class="token punctuation">.</span>weight

                <span class="token keyword">if</span> alt <span class="token operator">&lt;</span> distances<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">then</span>
                    distances<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> alt
                    previous<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> min_vertex<span class="token punctuation">.</span>name
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token keyword">return</span> <span class="token keyword">nil</span> <span class="token comment">-- 没有路径</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n最短路径查找（从A到E）:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> path<span class="token punctuation">,</span> distance <span class="token keyword">in</span> <span class="token function">shortest_path_iterator</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  路径: "</span> <span class="token operator">..</span> table<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">" -&gt; "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  总距离: "</span> <span class="token operator">..</span> distance<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
创建图：
A -- B (1)
|    |
C    D (3)
 \  /
  D (1)
  |
  E (2)

图的深度优先遍历（从A开始）:
A B D C E 
图的广度优先遍历（从A开始）:
A B C D E 

最短路径查找（从A到E）:
  路径: A -&gt; C -&gt; D -&gt; E
  总距离: 5
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="11.6.3 惰性求值迭代器" dir="auto" class="heading" id="11.6.3_惰性求值迭代器_0">11.6.3 惰性求值迭代器</h3></div><div class="el-p"><p dir="auto">惰性求值：需要时才计算值</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 无限序列迭代器</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">infinite_sequence</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> step<span class="token punctuation">)</span>
    <span class="token keyword">local</span> current <span class="token operator">=</span> start <span class="token operator">-</span> <span class="token punctuation">(</span>step <span class="token keyword">or</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        current <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token punctuation">(</span>step <span class="token keyword">or</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> current
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"自然数序列（惰性）:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> natural_numbers <span class="token operator">=</span> <span class="token function">infinite_sequence</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">natural_numbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 输出 1 2 3 4 5 6 7 8 9 10</span>

<span class="token comment">-- 2. 斐波那契数列（惰性无限）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">fibonacci_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> result <span class="token operator">=</span> a
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b
        <span class="token keyword">return</span> result
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n斐波那契数列（惰性无限，前15项）:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> fib <span class="token operator">=</span> <span class="token function">fibonacci_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 输出 0 1 1 2 3 5 8 13 21 34 55 89 144 233 377 </span>

<span class="token comment">-- 3. 网络数据流迭代器（模拟）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">network_stream_iterator</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> buffer_size<span class="token punctuation">)</span>
    buffer_size <span class="token operator">=</span> buffer_size <span class="token keyword">or</span> <span class="token number">4096</span>
    
    <span class="token keyword">local</span> bytes_sent <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> total_bytes <span class="token operator">=</span> <span class="token number">10240</span>  <span class="token comment">-- 模拟10KB数据</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> bytes_sent <span class="token operator">&gt;=</span> total_bytes <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">local</span> chunk_size <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>buffer_size<span class="token punctuation">,</span> total_bytes <span class="token operator">-</span> bytes_sent<span class="token punctuation">)</span>
        bytes_sent <span class="token operator">=</span> bytes_sent <span class="token operator">+</span> chunk_size
        
        <span class="token comment">-- 模拟数据块</span>
        <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"X"</span><span class="token punctuation">,</span> chunk_size<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"网络数据流迭代器（模拟）:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> network_stream <span class="token operator">=</span> <span class="token function">network_stream_iterator</span><span class="token punctuation">(</span><span class="token string">"http://example.com/data"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> chunk_count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">local</span> total_size <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">for</span> chunk <span class="token keyword">in</span> network_stream <span class="token keyword">do</span>
    chunk_count <span class="token operator">=</span> chunk_count <span class="token operator">+</span> <span class="token number">1</span>
    total_size <span class="token operator">=</span> total_size <span class="token operator">+</span> <span class="token operator">#</span>chunk
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  收到块%d: %d字节"</span><span class="token punctuation">,</span> chunk_count<span class="token punctuation">,</span> <span class="token operator">#</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  总共收到%d块，总大小%d字节"</span><span class="token punctuation">,</span> chunk_count<span class="token punctuation">,</span> total_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
收到块1: 4096字节
收到块2: 4096字节
收到块3: 2048字节
总共收到3块，总大小10240字节
--]]</span>

<span class="token comment">-- 4. 数据库查询流迭代器（惰性获取）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">database_stream_iterator</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> page_size<span class="token punctuation">)</span>
    page_size <span class="token operator">=</span> page_size <span class="token keyword">or</span> <span class="token number">100</span>
    
    <span class="token keyword">local</span> current_page <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> current_index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> current_data <span class="token operator">=</span> <span class="token keyword">nil</span>
    
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- 如果需要新的一页数据</span>
        <span class="token keyword">if</span> current_data <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">or</span> current_index <span class="token operator">&gt;=</span> <span class="token operator">#</span>current_data <span class="token keyword">then</span>
            current_page <span class="token operator">=</span> current_page <span class="token operator">+</span> <span class="token number">1</span>
            current_index <span class="token operator">=</span> <span class="token number">0</span>
            
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  查询第%d页数据..."</span><span class="token punctuation">,</span> current_page<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment">-- 模拟数据库查询（实际中这里会有真正的查询）</span>
            current_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> page_size <span class="token keyword">do</span>
                <span class="token keyword">local</span> item_id <span class="token operator">=</span> <span class="token punctuation">(</span>current_page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> page_size <span class="token operator">+</span> i
                <span class="token keyword">if</span> item_id <span class="token operator">&gt;</span> <span class="token number">250</span> <span class="token keyword">then</span>  <span class="token comment">-- 模拟总共250条数据</span>
                    current_data <span class="token operator">=</span> <span class="token keyword">nil</span>
                    <span class="token keyword">break</span>
                <span class="token keyword">end</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>current_data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    id <span class="token operator">=</span> item_id<span class="token punctuation">,</span>
                    name <span class="token operator">=</span> <span class="token string">"项目"</span> <span class="token operator">..</span> item_id<span class="token punctuation">,</span>
                    value <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>
            
            <span class="token keyword">if</span> current_data <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span> <span class="token keyword">nil</span>  <span class="token comment">-- 没有更多数据</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        
        <span class="token comment">-- 返回当前数据项</span>
        current_index <span class="token operator">=</span> current_index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> item <span class="token operator">=</span> current_data<span class="token punctuation">[</span>current_index<span class="token punctuation">]</span>
        
        <span class="token keyword">return</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> item<span class="token punctuation">.</span>value
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n数据库查询流迭代器:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> item_count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">database_stream_iterator</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM items"</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    item_count <span class="token operator">=</span> item_count <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">if</span> item_count <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token keyword">or</span> item_count <span class="token operator">&gt;=</span> <span class="token number">248</span> <span class="token keyword">then</span>  <span class="token comment">-- 只显示头尾几个</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  ID: %d, 名称: %s, 值: %d"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elseif</span> item_count <span class="token operator">==</span> <span class="token number">4</span> <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  ..."</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  总共查询到 "</span> <span class="token operator">..</span> item_count <span class="token operator">..</span> <span class="token string">" 条记录"</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
查询第1页数据...
ID: 1, 名称: 项目1, 值: 101
ID: 2, 名称: 项目2, 值: 607
ID: 3, 名称: 项目3, 值: 274
...
查询第2页数据...
查询第3页数据...
查询第4页数据...
查询第5页数据...
ID: 248, 名称: 项目248, 值: 729
ID: 249, 名称: 项目249, 值: 626
ID: 250, 名称: 项目250, 值: 416
查询第6页数据...
总共查询到 250 条记录
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.7 练习" dir="auto" class="heading" id="11.7_练习_0">11.7 练习</h2></div><div class="el-h3"><h3 data-heading="练习 1：实现一个数据管道系统" dir="auto" class="heading" id="练习_1：实现一个数据管道系统_0">练习 1：实现一个数据管道系统</h3></div><div class="el-p"><p dir="auto">（答案见<a data-href="第 1 节 - 语法/参考答案#练习 11 1：实现一个数据管道系统" href="第-1-节-语法/参考答案.html#练习 11 1：实现一个数据管道系统" class="internal-link" target="_self" rel="noopener nofollow">第 1 节 - 语法/参考答案 &gt; 练习 11 1：实现一个数据管道系统</a>）</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 实现一个数据管道系统，组合多个迭代器处理数据（先收集操作，最后迭代时统一处理数据）</span>
<span class="token comment">-- 使用示例：</span>
<span class="token comment">-- 构建管道</span>
<span class="token keyword">local</span> pipeline <span class="token operator">=</span> pipeline_sys<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">number_source</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
pipeline<span class="token punctuation">:</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token comment">-- 只保留偶数</span>
pipeline<span class="token punctuation">:</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span> <span class="token keyword">end</span><span class="token punctuation">)</span>         <span class="token comment">-- 乘以2</span>
pipeline<span class="token punctuation">:</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                   <span class="token comment">-- 跳过前3个</span>
pipeline<span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                                   <span class="token comment">-- 取5个</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"管道处理结果:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> value <span class="token keyword">in</span> pipeline<span class="token punctuation">:</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>value <span class="token operator">..</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
管道处理结果:
8 12 16 20 24 
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="11.8 本章总结" dir="auto" class="heading" id="11.8_本章总结_0">11.8 本章总结</h2></div><div class="el-h3"><h3 data-heading="关键知识点回顾" dir="auto" class="heading" id="关键知识点回顾_0">关键知识点回顾</h3></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>迭代器基础</strong>：</p>
<ul>
<li data-line="1" dir="auto">迭代器是生成序列值的函数</li>
<li data-line="2" dir="auto">迭代器三要素：迭代器函数：每次调用返回下一个值，不可变状态：遍历过程中不变的数据，控制变量：当前遍历位置</li>
<li data-line="3" dir="auto">泛型 for 循环：<code>for var1, var2, ... in iter, state, init do ... end</code></li>
<li data-line="4" dir="auto">Lua 内置迭代器：<code>ipairs</code>, <code>pairs</code>, <code>string.gmatch</code></li>
</ul>
</li>
<li data-line="6" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>无状态迭代器</strong>：</p>
<ul>
<li data-line="7" dir="auto">所有状态通过参数传递</li>
<li data-line="8" dir="auto">更高效，不创建闭包</li>
<li data-line="9" dir="auto">示例：<code>ipairs</code> 的实现原理</li>
</ul>
</li>
<li data-line="11" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>有状态迭代器</strong>：</p>
<ul>
<li data-line="12" dir="auto">使用闭包保存状态</li>
<li data-line="13" dir="auto">更灵活，可以实现复杂逻辑</li>
<li data-line="14" dir="auto">示例：计数器、斐波那契数列</li>
</ul>
</li>
<li data-line="16" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>高级迭代器模式</strong>：</p>
<ul>
<li data-line="17" dir="auto">树和图遍历迭代器</li>
<li data-line="18" dir="auto">惰性求值迭代器</li>
<li data-line="19" dir="auto">数据管道和查询构建器</li>
</ul>
</li>
</ol></div><div class="el-h3"><h3 data-heading="迭代器设计模式" dir="auto" class="heading" id="迭代器设计模式_0">迭代器设计模式</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 简单迭代器模式</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">simple_iterator</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> data<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 2. 无状态迭代器模式</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">stateless_iter</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    <span class="token comment">-- 计算下一个值</span>
    <span class="token keyword">local</span> next_index<span class="token punctuation">,</span> next_value <span class="token operator">=</span> <span class="token punctuation">...</span>
    <span class="token keyword">return</span> next_index<span class="token punctuation">,</span> next_value
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iter_factory</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> stateless_iter<span class="token punctuation">,</span> data<span class="token punctuation">,</span> initial_index
<span class="token keyword">end</span>

<span class="token comment">-- 3. 生成器模式</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">generator</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- 每次生成下一个值</span>
        <span class="token keyword">return</span> next_value
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 4. 转换器模式</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">transformer</span><span class="token punctuation">(</span>iterator<span class="token punctuation">,</span> transform_func<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token function">transform_func</span><span class="token punctuation">(</span><span class="token function">unpack</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="性能考虑" dir="auto" class="heading" id="性能考虑_0">性能考虑</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 迭代器的性能特点</span>

<span class="token comment">-- 1. 无状态 vs 有状态</span>
<span class="token comment">-- 无状态迭代器通常更高效，但不适合复杂状态</span>

<span class="token comment">-- 2. 惰性求值的优势</span>
<span class="token comment">-- 只计算需要的值，节省内存和计算资源</span>

<span class="token comment">-- 3. 避免在迭代器中做耗时操作</span>
<span class="token comment">-- 迭代器应该快速返回下一个值</span>

<span class="token comment">-- 4. 大数据集的处理</span>
<span class="token comment">-- 考虑使用流式迭代器，避免一次性加载所有数据</span>

<span class="token comment">-- 性能测试示例</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">array_iterator</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">local</span> value <span class="token operator">=</span> t<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

    <span class="token keyword">if</span> value <span class="token keyword">then</span>
        <span class="token keyword">return</span> index<span class="token punctuation">,</span> value
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iter_array</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">return</span> array_iterator<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">stateful_array_iterator</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> value <span class="token operator">=</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

        <span class="token keyword">if</span> value <span class="token keyword">then</span>
            <span class="token keyword">return</span> i<span class="token punctuation">,</span> value
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span> <span class="token keyword">do</span>
    data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
<span class="token keyword">end</span>

<span class="token comment">-- 测试ipairs</span>
<span class="token keyword">local</span> start <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment">-- 空循环</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"ipairs: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>

<span class="token comment">-- 测试自定义无状态迭代器</span>
start <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">iter_array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment">-- 空循环</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"无状态迭代器: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>

<span class="token comment">-- 测试有状态迭代器</span>
start <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> v <span class="token keyword">in</span> <span class="token function">stateful_array_iterator</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token comment">-- 空循环</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"有状态迭代器: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
ipairs: 0.051秒
无状态迭代器: 0.073秒
有状态迭代器: 0.087秒
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="常见错误" dir="auto" class="heading" id="常见错误_0">常见错误</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 修改迭代中的表</span>
<span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">then</span>
        table<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token punctuation">)</span>  <span class="token comment">-- 这会改变表，可能导致意外行为</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 正确做法：收集要删除的项，然后批量删除</span>
<span class="token keyword">local</span> to_remove <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">then</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>to_remove<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token operator">#</span>to_remove<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">do</span>
    table<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> to_remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 2. 迭代器函数调用错误</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">bad_iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token comment">-- 应该返回函数，而不是值</span>
<span class="token keyword">end</span>

<span class="token comment">-- 错误：for v in bad_iterator() do ... end</span>

<span class="token comment">-- 3. 忘记处理nil值</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">iterator_with_nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment">-- 可能返回nil，但迭代应该继续</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 4. 无限迭代器缺少终止条件</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">infinite_iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> i  <span class="token comment">-- 永远不返回nil！</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 使用时要小心</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">infinite_iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token keyword">then</span> 
    	<span class="token keyword">break</span>	<span class="token comment">-- 必须手动break</span>
    <span class="token keyword">end</span>
    <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="最佳实践" dir="auto" class="heading" id="最佳实践_0">最佳实践</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 保持迭代器简单</span>
<span class="token comment">-- 迭代器应该只负责生成下一个值，不处理复杂业务逻辑</span>

<span class="token comment">-- 2. 提供清晰的接口</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">create_user_iterator</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span>
    <span class="token comment">-- 返回迭代器和其他信息</span>
    <span class="token keyword">return</span> iterator<span class="token punctuation">,</span> total_count<span class="token punctuation">,</span> other_info
<span class="token keyword">end</span>

<span class="token comment">-- 3. 处理边界情况</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">robust_iterator</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> data <span class="token keyword">or</span> <span class="token operator">#</span>data <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token comment">-- 返回一个立即结束的迭代器</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        	<span class="token keyword">return</span> <span class="token keyword">nil</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 正常迭代器</span>
    <span class="token keyword">local</span> index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> data<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 4. 文档化迭代器行为</span>
<span class="token comment">--- 遍历表的键值对</span>
<span class="token comment">-- @param t 要遍历的表</span>
<span class="token comment">-- @return 迭代器函数</span>
<span class="token comment">-- @return 表t（不可变状态）</span>
<span class="token comment">-- @return nil（初始控制变量）</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">my_pairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token comment">-- 实现...</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="检查清单" dir="auto" class="heading" id="检查清单_0">检查清单</h3></div><div class="el-p"><p dir="auto">（点击勾选框勾选）<br>
完成本章后，你应该能够：</p></div><div class="el-ul"><ul class="contains-task-list">
<li data-line="0" data-task="" class="task-list-item" dir="auto"><input data-line="0" type="checkbox" class="task-list-item-checkbox">理解迭代器的基本概念和工作原理</li>
<li data-line="1" data-task="" class="task-list-item" dir="auto"><input data-line="1" type="checkbox" class="task-list-item-checkbox">使用 Lua 内置迭代器（ipairs, pairs, string.gmatch）</li>
<li data-line="2" data-task="" class="task-list-item" dir="auto"><input data-line="2" type="checkbox" class="task-list-item-checkbox">创建无状态迭代器和有状态迭代器</li>
<li data-line="3" data-task="" class="task-list-item" dir="auto"><input data-line="3" type="checkbox" class="task-list-item-checkbox">实现复杂的遍历模式（树、图等）</li>
<li data-line="4" data-task="" class="task-list-item" dir="auto"><input data-line="4" type="checkbox" class="task-list-item-checkbox">使用惰性求值提高性能</li>
<li data-line="5" data-task="" class="task-list-item" dir="auto"><input data-line="5" type="checkbox" class="task-list-item-checkbox">构建数据管道</li>
<li data-line="6" data-task="" class="task-list-item" dir="auto"><input data-line="6" type="checkbox" class="task-list-item-checkbox">选择适合场景的迭代器类型</li>
<li data-line="7" data-task="" class="task-list-item" dir="auto"><input data-line="7" type="checkbox" class="task-list-item-checkbox">避免常见的迭代器错误</li>
</ul></div><div class="el-h3"><h3 data-heading="思考题" dir="auto" class="heading" id="思考题_0">思考题</h3></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">无状态迭代器和有状态迭代器各有什么优缺点？如何选择？</li>
<li data-line="1" dir="auto">如何实现一个迭代器来遍历嵌套的复杂数据结构？</li>
<li data-line="2" dir="auto">惰性求值迭代器在什么场景下特别有用？</li>
<li data-line="3" dir="auto">迭代器模式如何提高代码的可复用性和可维护性？</li>
<li data-line="4" dir="auto">如何处理迭代过程中的错误和异常？</li>
</ol></div><div class="el-hr"><hr></div><div class="el-p"><p dir="auto"><strong>下一章预告</strong>：在第 12 章中，我们将学习协程，让我们能够协作式进行多任务处理。</p></div><div class="el-p"><p dir="auto"><strong>学习建议</strong>：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">多实践创建各种类型的迭代器</li>
<li data-line="1" dir="auto">理解无状态和有状态迭代器的区别</li>
<li data-line="2" dir="auto">尝试用迭代器解决实际问题</li>
<li data-line="3" dir="auto">注意迭代器的性能特点</li>
<li data-line="4" dir="auto">学习现有的迭代器模式，理解其设计思想</li>
</ol></div><div class="footer"><div class="data-bar"></div></div></div></div></div><div id="right-content" class="leaf" style="--sidebar-width: var(--sidebar-width-right);"><div id="right-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme-toggle-input" id=""><input class="theme-toggle-input" type="checkbox" id="theme-toggle-input"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="right-sidebar-content" class="leaf-content"><div id="outline" class=" tree-container"><div class="feature-header"><div class="feature-title">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item mod-collapsible" data-depth="1"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11._迭代器与泛型for_0" data-path="#11._迭代器与泛型for_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11. 迭代器与泛型for">11. 迭代器与泛型for</div></a><div class="tree-item-children"><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.1_为什么需要迭代器？_0" data-path="#11.1_为什么需要迭代器？_0"><div class="tree-item-inner heading-link" heading-name="11.1 为什么需要迭代器？">11.1 为什么需要迭代器？</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.2_迭代器基础概念_0" data-path="#11.2_迭代器基础概念_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.2 迭代器基础概念">11.2 迭代器基础概念</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.2.1_什么是迭代器？_0" data-path="#11.2.1_什么是迭代器？_0"><div class="tree-item-inner heading-link" heading-name="11.2.1 什么是迭代器？">11.2.1 什么是迭代器？</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.2.2_泛型_for_循环_0" data-path="#11.2.2_泛型_for_循环_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.2.2 泛型 for 循环">11.2.2 泛型 for 循环</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#示例_0" data-path="#示例_0"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#工作流程_0" data-path="#工作流程_0"><div class="tree-item-inner heading-link" heading-name="工作流程">工作流程</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#泛型_for_vs_手动_while_0" data-path="#泛型_for_vs_手动_while_0"><div class="tree-item-inner heading-link" heading-name="泛型 for vs 手动 while">泛型 for vs 手动 while</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.3_Lua_内置迭代器_0" data-path="#11.3_Lua_内置迭代器_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.3 Lua 内置迭代器">11.3 Lua 内置迭代器</div></a><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.3.1_ipairs_-_数组迭代器_0" data-path="#11.3.1_ipairs_-_数组迭代器_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.3.1 ipairs - 数组迭代器">11.3.1 ipairs - 数组迭代器</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#示例_1" data-path="#示例_1"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#实现自定义的_ipairs_0" data-path="#实现自定义的_ipairs_0"><div class="tree-item-inner heading-link" heading-name="实现自定义的 ipairs">实现自定义的 ipairs</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.3.2_pairs_-_通用迭代器_0" data-path="#11.3.2_pairs_-_通用迭代器_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.3.2 pairs - 通用迭代器">11.3.2 pairs - 通用迭代器</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#示例_2" data-path="#示例_2"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#实现自定义的pairs（简化版）_0" data-path="#实现自定义的pairs（简化版）_0"><div class="tree-item-inner heading-link" heading-name="实现自定义的pairs（简化版）">实现自定义的pairs（简化版）</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#next_函数的使用_0" data-path="#next_函数的使用_0"><div class="tree-item-inner heading-link" heading-name="next 函数的使用">next 函数的使用</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.3.3_string.gmatch_-_字符串迭代器_0" data-path="#11.3.3_string.gmatch_-_字符串迭代器_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.3.3 string.gmatch - 字符串迭代器">11.3.3 string.gmatch - 字符串迭代器</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#示例_3" data-path="#示例_3"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#实现自定义字符串迭代器_0" data-path="#实现自定义字符串迭代器_0"><div class="tree-item-inner heading-link" heading-name="实现自定义字符串迭代器">实现自定义字符串迭代器</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.4_无状态迭代器_0" data-path="#11.4_无状态迭代器_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.4 无状态迭代器">11.4 无状态迭代器</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.4.1_理解无状态迭代器_0" data-path="#11.4.1_理解无状态迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.4.1 理解无状态迭代器">11.4.1 理解无状态迭代器</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.4.2_创建无状态迭代器_0" data-path="#11.4.2_创建无状态迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.4.2 创建无状态迭代器">11.4.2 创建无状态迭代器</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.5_有状态迭代器_0" data-path="#11.5_有状态迭代器_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.5 有状态迭代器">11.5 有状态迭代器</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.5.1_创建有状态迭代器_0" data-path="#11.5.1_创建有状态迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.5.1 创建有状态迭代器">11.5.1 创建有状态迭代器</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.5.2_复杂的有状态迭代器_0" data-path="#11.5.2_复杂的有状态迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.5.2 复杂的有状态迭代器">11.5.2 复杂的有状态迭代器</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.6_高级迭代器模式_0" data-path="#11.6_高级迭代器模式_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.6 高级迭代器模式">11.6 高级迭代器模式</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.6.1_树遍历迭代器_0" data-path="#11.6.1_树遍历迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.6.1 树遍历迭代器">11.6.1 树遍历迭代器</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.6.2_图形遍历迭代器_0" data-path="#11.6.2_图形遍历迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.6.2 图形遍历迭代器">11.6.2 图形遍历迭代器</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#11.6.3_惰性求值迭代器_0" data-path="#11.6.3_惰性求值迭代器_0"><div class="tree-item-inner heading-link" heading-name="11.6.3 惰性求值迭代器">11.6.3 惰性求值迭代器</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.7_练习_0" data-path="#11.7_练习_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.7 练习">11.7 练习</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#练习_1：实现一个数据管道系统_0" data-path="#练习_1：实现一个数据管道系统_0"><div class="tree-item-inner heading-link" heading-name="练习 1：实现一个数据管道系统">练习 1：实现一个数据管道系统</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/11.-迭代器与泛型for.html#11.8_本章总结_0" data-path="#11.8_本章总结_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="11.8 本章总结">11.8 本章总结</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#关键知识点回顾_0" data-path="#关键知识点回顾_0"><div class="tree-item-inner heading-link" heading-name="关键知识点回顾">关键知识点回顾</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#迭代器设计模式_0" data-path="#迭代器设计模式_0"><div class="tree-item-inner heading-link" heading-name="迭代器设计模式">迭代器设计模式</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#性能考虑_0" data-path="#性能考虑_0"><div class="tree-item-inner heading-link" heading-name="性能考虑">性能考虑</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#常见错误_0" data-path="#常见错误_0"><div class="tree-item-inner heading-link" heading-name="常见错误">常见错误</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#最佳实践_0" data-path="#最佳实践_0"><div class="tree-item-inner heading-link" heading-name="最佳实践">最佳实践</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#检查清单_0" data-path="#检查清单_0"><div class="tree-item-inner heading-link" heading-name="检查清单">检查清单</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/11.-迭代器与泛型for.html#思考题_0" data-path="#思考题_0"><div class="tree-item-inner heading-link" heading-name="思考题">思考题</div></a><div class="tree-item-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector("#right-sidebar"); rs.classList.toggle("is-collapsed", window.innerWidth < 768); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></div></div></body></html>