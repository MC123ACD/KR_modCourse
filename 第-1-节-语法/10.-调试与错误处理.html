<!DOCTYPE html> <html lang="zh-cn"><head>
<title>10. 调试与错误处理</title>
<base href="..">
<meta name="pathname" content="第-1-节-语法/10.-调试与错误处理.html">
<meta name="description" content="王国保卫战修改教程 - 10. 调试与错误处理">
<meta property="og:title" content="10. 调试与错误处理">
<meta property="og:description" content="王国保卫战修改教程 - 10. 调试与错误处理">
<meta property="og:type" content="website">
<meta property="og:url" content="第-1-节-语法/10.-调试与错误处理.html">
<meta property="og:image" content="site-lib/media/pasted-image-20251225185539.png">
<meta charset="UTF-8"><meta property="og:site_name" content="王国保卫战修改教程"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="site-lib/rss.xml"><script async="" id="webpage-script" src="site-lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="site-lib/media/favicon.png"><link rel="preload" href="site-lib/styles/snippets.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/snippets.css"></noscript><link rel="stylesheet" href="site-lib/styles/obsidian.css"><link rel="preload" href="site-lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="site-lib/styles/theme.css"><link rel="preload" href="site-lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="site-lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/supported-plugins.css"></noscript><link rel="preload" href="site-lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/main-styles.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-vertical-spacing:1.3em;--sidebar-margin:12px}:root{background-color:#202124}.sidebar{height:100%;font-size:14px;z-index:10;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));position:relative;overflow:hidden;overflow:clip;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}#left-sidebar{left:0}#right-sidebar{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}.sidebar.floating{position:absolute}.sidebar .leaf-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .leaf-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}#left-sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}#right-sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar #left-sidebar-content,.sidebar #right-sidebar-content{contain:none!important;container-type:normal!important;animation:none!important}.sidebar:has(.leaf-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:calc(2.3em + 2 * var(--sidebar-margin));width:var(--sidebar-width);padding:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}#left-sidebar .sidebar-topbar{left:0;flex-direction:row;border-top-right-radius:var(--radius-l)}#right-sidebar .sidebar-topbar{right:0;flex-direction:row-reverse;border-top-left-radius:var(--radius-l)}#left-sidebar .topbar-content{margin-right:calc(2.3em + var(--sidebar-margin));flex-direction:row}#right-sidebar .topbar-content{margin-left:calc(2.3em + var(--sidebar-margin));flex-direction:row-reverse}.topbar-content{overflow:hidden visible;overflow:clip visible;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:2px!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}#left-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}#right-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.feature-title{margin-left:1px;text-transform:uppercase;letter-spacing:.06em;margin-top:.75em;margin-bottom:.75em}.feature-header{display:flex;align-items:center;padding-top:0;font-size:1em;padding-left:0}body.floating-sidebars .sidebar{position:absolute}body{transition:background-color var(--color-fade-speed) ease-in-out}#navbar:not(:empty){display:flex;align-items:center;justify-content:space-between;padding:.5em 1em;width:100%}#main{display:flex;flex-direction:column;height:100%;width:100%;align-items:stretch;justify-content:center}#main-horizontal{display:flex;flex-direction:row;flex-grow:1;width:100%;align-items:stretch;justify-content:center}#center-content{flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0!important;transition:opacity .2s ease-in-out;pointer-events:none}#center-content>.obsidian-document{padding-left:2em;padding-right:1em;margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}body #center-content>.obsidian-document>.markdown-preview-sizer{padding-bottom:80vh;width:100%;max-width:var(--line-width);flex-basis:var(--line-width);transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document>div{width:100%!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document:not([data-type=markdown]).embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}#center-content>.obsidian-document:not([data-type=markdown]).embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6,li):has(> :is(.math,table)){overflow-x:auto!important}#center-content>.obsidian-document:not([data-type=markdown]){overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.obsidian-document[data-type=attachment]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%}.obsidian-document[data-type=attachment]>*{outline:0;border:none;box-shadow:none}.obsidian-document[data-type=attachment] :is(img){max-width:90%;max-height:90%;object-fit:contain}.obsidian-document[data-type=attachment]>:is(audio){width:100%;max-width:min(90%,var(--line-width))}.obsidian-document[data-type=attachment]>:is(embed,iframe,video){width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain}.canvas-wrapper>:is(.header,.footer){z-index:100;position:absolute;display:flex;justify-content:center;flex-direction:column;width:100%;align-items:center}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){let e=document.querySelectorAll("link[itemprop='include']");for(const t of e){let e=t.getAttribute("href");try{let o="";if(e.startsWith("https:")||e.startsWith("http:")||"file:"!=window.location.protocol){const n=await fetch(e);if(!n.ok){console.log("Could not include file: "+e),t?.remove();continue}o=await n.text()}else{const t=document.getElementById(btoa(encodeURI(e)));if(t){const e=JSON.parse(decodeURI(atob(t.getAttribute("value")??"")));o=e?.data??""}}let n=document.createRange().createContextualFragment(o);t.before(n),t.remove(),console.log("Included text: "+o),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script")));!function e(n){let l=o[n],c=n+1;l?(l&&"true"!=l.getAttribute("loaded")||n<o.length&&e(c),n<o.length&&l.addEventListener("load",(()=>e(c)))):n<o.length?e(c):t()}(0)}</script></head><body class="publish css-settings-manager mod-windows is-frameless is-hidden-frameless styled-scrollbars show-inline-title show-ribbon background-settings-workplace-theme-dark-in-the-sky background-image-settings-markdown-page-custom notebook-liked-markdown-page-grid-notebook-1 panel-page-bg-theme-light-custom panel-page-bg-theme-dark-plant hide-left-ribbon-retention-drawer toggle-divider-lines toggle-header-bottom-line bt-bubble-layout bt-bubble-layout-hide-borders remove-heading-indicator h1-toggle-underline toggle-left-aligned-content fancy-hr-no-icon custom-unordered-list custom-ordered-list list-no-border folder-icons bt-toggle-colorful-folder folder-style-change-options-colorful-default folder-colorful-one table-width-auto table-style-two link-underline-internal enable-alternative-checkboxes default-loading-page loading-text-typing-style rainbow-tag translucent-setting-panel underline-tab-style canvas-card-text-middle admonition-bg-color-same toggle-calendar-shadow style-options-for-buttons-plugin dataview-list-style-pacman memos-banner-gradient thino-frosted-style thino-background-default quiet-outline-optimize code-theme-sublime is-focused"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="parsed-feature-container" style="display: contents;"><link itemprop="include" href="site-lib/html/custom-head-content-content.html"></div><div id="main"><div id="navbar"></div><div id="main-horizontal"><div id="left-content" class="leaf" style="--sidebar-width: var(--sidebar-width-left);"><div id="left-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><div id="search-container"><div id="search-wrapper"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div aria-label="Clear search" id="search-clear-button"></div></div></div></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="left-sidebar-content" class="leaf-content"><link itemprop="include" href="site-lib/html/file-tree-content.html"></div></div><script defer="">let ls = document.querySelector("#left-sidebar"); ls.classList.toggle("is-collapsed", window.innerWidth < 768); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div></div><div id="center-content" class="leaf"><div class="obsidian-document markdown-preview-view markdown-rendered node-insert-event allow-fold-headings show-indentation-guide show-properties is-readable-line-width" data-type="markdown"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer"><div class="header"><h1 class="page-title heading inline-title" id="10._调试与错误处理_0">10. 调试与错误处理</h1><div class="data-bar"></div></div><div class="markdown-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="el-h3"><h3 data-heading="10.1 为什么要使用断点调试？" dir="auto" class="heading" id="10.1_为什么要使用断点调试？_0">10.1 为什么要使用断点调试？</h3></div><div class="el-p"><p dir="auto">在程序开发过程中，调试是必不可少的一环。之前都是使用 <code>print</code> 语句进行调试，但随着程序复杂度增加，<code>print</code> 调试的局限性逐渐显现。</p></div><div class="el-p"><p dir="auto"><strong>print 调试的缺点</strong>：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><strong>效率低下</strong>：每次调试都需要手动添加 print 语句，调试完成后还需逐一清理</li>
<li data-line="1" dir="auto"><strong>信息有限</strong>：只能显示特定变量的值，无法查看完整的调用链和执行上下文</li>
<li data-line="2" dir="auto"><strong>表结构查看困难</strong>：需要手动拼接输出，复杂嵌套表需要递归处理</li>
<li data-line="3" dir="auto"><strong>缺乏控制</strong>：无法暂停程序、单步执行，只能看到固定的输出结果</li>
</ol></div><div class="el-p"><p dir="auto"><strong>断点调试的优点</strong>：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><strong>高效便捷</strong>：设置一次断点，多次运行生效</li>
<li data-line="1" dir="auto"><strong>信息全面</strong>：查看作用域内所有变量、调用堆栈、内存地址</li>
<li data-line="2" dir="auto"><strong>可视化表结构</strong>：自动展开显示复杂嵌套表</li>
<li data-line="3" dir="auto"><strong>完全控制</strong>：单步执行、条件断点、批量管理等高级功能</li>
</ol></div><div class="el-h2"><h2 data-heading="10.2 断点基础使用" dir="auto" class="heading" id="10.2_断点基础使用_0">10.2 断点基础使用</h2></div><div class="el-p"><p dir="auto">在代码行左侧增加断点<br>
<span alt="Pasted image 20251225185539.png" src="site-lib/media/pasted-image-20251225185539.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 227px; max-width: 100%;"><img alt="Pasted image 20251225185539.png" src="site-lib/media/pasted-image-20251225185539.png" target="_self" style="width: 227px; max-width: 100%;"></span></p></div><div class="el-p"><p dir="auto">使用 DEBUG 模式运行<br>
<span alt="Pasted image 20251225185723.png" src="site-lib/media/pasted-image-20251225185723.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 375px; max-width: 100%;"><img alt="Pasted image 20251225185723.png" src="site-lib/media/pasted-image-20251225185723.png" target="_self" style="width: 375px; max-width: 100%;"></span></p></div><div class="el-p"><p dir="auto">可以看到程序在第一行中断了（DEBUG 模式默认在第一行打了断点）<br>
<span alt="Pasted image 20251225185853.png" src="site-lib/media/pasted-image-20251225185853.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 294px; max-width: 100%;"><img alt="Pasted image 20251225185853.png" src="site-lib/media/pasted-image-20251225185853.png" target="_self" style="width: 294px; max-width: 100%;"></span><br>
可以在控制栏继续运行<br>
<span alt="Pasted image 20251225190026.png" src="site-lib/media/pasted-image-20251225190026.png" class="internal-embed media-embed image-embed is-loaded" target="_self"><img alt="Pasted image 20251225190026.png" src="site-lib/media/pasted-image-20251225190026.png" target="_self"></span></p></div><div class="el-p"><p dir="auto">继续后在运行与调试选项中可以查看变量值，或者鼠标光标悬停在变量上<br>
<span alt="Pasted image 20251225190451.png" src="site-lib/media/pasted-image-20251225190451.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 475px; max-width: 100%;"><img alt="Pasted image 20251225190451.png" src="site-lib/media/pasted-image-20251225190451.png" target="_self" style="width: 475px; max-width: 100%;"></span></p></div><div class="el-p"><p dir="auto">运行下一行代码，可以看到 a 变为了 2<br>
<span alt="Pasted image 20251225191640.png" src="site-lib/media/pasted-image-20251225191640.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 500px; max-width: 100%;"><img alt="Pasted image 20251225191640.png" src="site-lib/media/pasted-image-20251225191640.png" target="_self" style="width: 500px; max-width: 100%;"></span></p></div><div class="el-h3"><h3 data-heading="10.1.2 控制栏说明" dir="auto" class="heading" id="10.1.2_控制栏说明_0">10.1.2 控制栏说明</h3></div><div class="el-p"><p dir="auto"><strong>继续</strong>（快捷键 <code>F5</code>）：运行程序直到触发下一个断点<br>
<strong>逐过程</strong>（快捷键 <code>F10</code>）：运行下一行代码，遇到函数直接执行整个函数<br>
<strong>单步调试</strong>（快捷键 <code>F11</code>）：运行下一行代码，遇到函数进入函数内单步运行<br>
<strong>单步跳出</strong>（快捷键 <code>shift + F11</code>）：跳出当前代码块</p></div><div class="el-h3"><h3 data-heading="10.1.3 调用堆栈" dir="auto" class="heading" id="10.1.3_调用堆栈_0">10.1.3 调用堆栈</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> current_num <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">third</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    current_num <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"执行 third 函数"</span><span class="token punctuation">)</span>		<span class="token comment">-- 断点打这里</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    current_num <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"执行 second 函数"</span><span class="token punctuation">)</span>

    <span class="token function">third</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    current_num <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"执行 first 函数"</span><span class="token punctuation">)</span>

    <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">可以在调用堆栈查看调用堆栈，点击 second 可以跳转到调用 third 的代码行查看其作用域内的变量<br>
<span alt="Pasted image 20251225195034.png" src="site-lib/media/pasted-image-20251225195034.png" class="internal-embed media-embed image-embed is-loaded" target="_self"><img alt="Pasted image 20251225195034.png" src="site-lib/media/pasted-image-20251225195034.png" target="_self"></span><br>
<strong>调用堆栈解读</strong>：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>最顶部</strong>：当前暂停位置 (<code>third</code>)</li>
<li data-line="1" dir="auto"><strong>从上到下</strong>：函数调用顺序</li>
<li data-line="2" dir="auto"><strong>每个层级</strong>：显示函数名、参数值、所在文件</li>
<li data-line="3" dir="auto"><strong>点击任意层级</strong>：跳转到对应的代码位置，查看当时的变量状态</li>
</ul></div><div class="el-h2"><h2 data-heading="10.3 调试控制台" dir="auto" class="heading" id="10.3_调试控制台_0">10.3 调试控制台</h2></div><div class="el-p"><p dir="auto">调试控制台可以直接执行 Lua 代码：</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 使用调试控制台进行交互</span>
<span class="token keyword">local</span> inventory <span class="token operator">=</span> <span class="token punctuation">{</span>
    items <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"药水"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"武器"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"防具"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">3</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    gold <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">find_item_by_name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> item<span class="token punctuation">.</span>name <span class="token operator">==</span> name <span class="token keyword">then</span>
            <span class="token keyword">return</span> item
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"断点打这里"</span><span class="token punctuation">)</span>
<span class="token comment">-- 断点后在调试控制台中可以：</span>
<span class="token comment">-- 1. 查看变量: &gt; inventory</span>
<span class="token comment">-- 2. 调用函数: &gt; find_item_by_name("药水")</span>
<span class="token comment">-- 3. 修改值: &gt; inventory.gold = 1500</span>
<span class="token comment">-- 4. 执行表达式: &gt; #inventory.items</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20251225203906.png" src="site-lib/media/pasted-image-20251225203906.png" class="internal-embed media-embed image-embed is-loaded" target="_self"><img alt="Pasted image 20251225203906.png" src="site-lib/media/pasted-image-20251225203906.png" target="_self"></span></p></div><div class="el-h2"><h2 data-heading="10.4 监视变量" dir="auto" class="heading" id="10.4_监视变量_0">10.4 监视变量</h2></div><div class="el-p"><p dir="auto">监视变量用于在大量变量与复杂镶套中快速查看指定变量值</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 调试复杂表达式</span>
<span class="token keyword">local</span> complex_data <span class="token operator">=</span> <span class="token punctuation">{</span>
    users <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>name <span class="token operator">=</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span> scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    config <span class="token operator">=</span> <span class="token punctuation">{</span>
        weights <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        threshold <span class="token operator">=</span> <span class="token number">80</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">calculate_weighted_scores</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> user <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>complex_data<span class="token punctuation">.</span>users<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token comment">-- 在调试时添加监视表达式：</span>
        <span class="token comment">-- 1. user.name</span>
        <span class="token comment">-- 2. #user.scores</span>
        <span class="token comment">-- 3. complex_data.config.weights[1]</span>
        
        <span class="token keyword">local</span> weighted_sum <span class="token operator">=</span> <span class="token number">0</span>		<span class="token comment">-- 断点打这里</span>
        <span class="token keyword">for</span> j<span class="token punctuation">,</span> score <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>scores<span class="token punctuation">)</span> <span class="token keyword">do</span>
            weighted_sum <span class="token operator">=</span> weighted_sum <span class="token operator">+</span> score <span class="token operator">*</span> complex_data<span class="token punctuation">.</span>config<span class="token punctuation">.</span>weights<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
        <span class="token keyword">end</span>
        
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            score <span class="token operator">=</span> weighted_sum<span class="token punctuation">,</span>
            passed <span class="token operator">=</span> weighted_sum <span class="token operator">&gt;=</span> complex_data<span class="token punctuation">.</span>config<span class="token punctuation">.</span>threshold
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> results
<span class="token keyword">end</span>

<span class="token keyword">local</span> results <span class="token operator">=</span> <span class="token function">calculate_weighted_scores</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20251225201739.png" src="site-lib/media/pasted-image-20251225201739.png" class="internal-embed media-embed image-embed is-loaded" target="_self"><img alt="Pasted image 20251225201739.png" src="site-lib/media/pasted-image-20251225201739.png" target="_self"></span></p></div><div class="el-h2"><h2 data-heading="10.5 特殊断点" dir="auto" class="heading" id="10.5_特殊断点_0">10.5 特殊断点</h2></div><div class="el-p"><p dir="auto">右键断点可以编辑断点设置其他类型的断点。<br>
<span alt="Pasted image 20251225202221.png" src="site-lib/media/pasted-image-20251225202221.png" class="internal-embed media-embed image-embed is-loaded" target="_self" style="width: 725px; max-width: 100%;"><img alt="Pasted image 20251225202221.png" src="site-lib/media/pasted-image-20251225202221.png" target="_self" style="width: 725px; max-width: 100%;"></span></p></div><div class="el-h3"><h3 data-heading="10.5.1 条件断点（表达式）" dir="auto" class="heading" id="10.5.1_条件断点（表达式）_0">10.5.1 条件断点（表达式）</h3></div><div class="el-p"><p dir="auto">条件断点允许输入条件来在指定条件下触发断点，适合过滤无关触发。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 条件断点示例</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">find_special_num</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> num <span class="token keyword">do</span>
    	<span class="token keyword">local</span> current_num <span class="token operator">=</span> i
    
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">100</span> <span class="token keyword">then</span>        <span class="token comment">-- 可以设置条件断点：i == 99 提前一步暂停</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"找到特殊数字！"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">find_special_num</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.5.2 命中断点（命中次数）" dir="auto" class="heading" id="10.5.2_命中断点（命中次数）_0">10.5.2 命中断点（命中次数）</h3></div><div class="el-p"><p dir="auto">命中断点允许在断点被触发特定次数后才暂停程序执行，适合调试循环或重复调用的情况。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 调试循环中的特定迭代</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">process_items</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
    <span class="token keyword">local</span> processed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> total_value <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> value <span class="token operator">=</span> item<span class="token punctuation">.</span>price <span class="token operator">*</span> item<span class="token punctuation">.</span>quantity	<span class="token comment">-- 设置命中次数断点：== 3 在第3次迭代时暂停</span>
        total_value <span class="token operator">=</span> total_value <span class="token operator">+</span> value
        
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>processed<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            id <span class="token operator">=</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            name <span class="token operator">=</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            value <span class="token operator">=</span> value<span class="token punctuation">,</span>
            cumulative <span class="token operator">=</span> total_value
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"处理第%d项: %s = %d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> processed<span class="token punctuation">,</span> total_value
<span class="token keyword">end</span>

<span class="token keyword">local</span> inventory <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> quantity <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"香蕉"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> quantity <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"橙子"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> quantity <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 我们想检查这一项</span>
    <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"葡萄"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> quantity <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"西瓜"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> quantity <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> results<span class="token punctuation">,</span> total <span class="token operator">=</span> <span class="token function">process_items</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"总计价值:"</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.5.3 日志断点（记录点）" dir="auto" class="heading" id="10.5.3_日志断点（记录点）_0">10.5.3 日志断点（记录点）</h3></div><div class="el-p"><p dir="auto">日志断点不会暂停程序，而是在触发时输出信息到控制台，适合在不中断流程的情况下跟踪程序状态。<br>
日志断点类似于 <code>print</code>，花括号 <code>{}</code> 内可以输入变量。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token keyword">do</span>
    a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span>	<span class="token comment">-- 增加日志断点：触发断点 i = {i}</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
触发断点 i = 1.0
触发断点 i = 2.0
触发断点 i = 3.0
触发断点 i = 4.0
触发断点 i = 5.0
触发断点 i = 6.0
触发断点 i = 7.0
触发断点 i = 8.0
触发断点 i = 9.0
触发断点 i = 10.0
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.3.4 等待断点（触发的断点）" dir="auto" class="heading" id="10.3.4_等待断点（触发的断点）_0">10.3.4 等待断点（触发的断点）</h3></div><div class="el-p"><p dir="auto">等待断点指定的另一个断点触发后，等待断点才会触发，适合在不重复设定复杂条件断点的情况下应用其条件。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>	<span class="token comment">-- 增加条件断点：i == 50</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">-</span>a<span class="token punctuation">)</span>	<span class="token comment">-- 增加等待断点：指定上面的断点</span>
    a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token comment">-- 将会在 i = 50 时先后触发两个断点</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.6 常见调试场景" dir="auto" class="heading" id="10.6_常见调试场景_0">10.6 常见调试场景</h2></div><div class="el-h3"><h3 data-heading="1. 循环调试" dir="auto" class="heading" id="1._循环调试_0">1. 循环调试</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">debug_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> matrix <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token comment">-- 初始化矩阵</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">do</span>
        matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">do</span>
            matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> j  <span class="token comment">-- 在此行添加断点，观察循环变量</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 处理矩阵</span>
    <span class="token keyword">local</span> sum <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>matrix <span class="token keyword">do</span>
        <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">do</span>
            sum <span class="token operator">=</span> sum <span class="token operator">+</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> matrix<span class="token punctuation">,</span> sum
<span class="token keyword">end</span>

<span class="token function">debug_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="2. 递归函数调试" dir="auto" class="heading" id="2._递归函数调试_0">2. 递归函数调试</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">if</span> n <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> v <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> v	<span class="token comment">-- 打断点观察阶乘值</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">if</span> n <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> n
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> v <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> v	<span class="token comment">-- 打断点观察数列值</span>
<span class="token keyword">end</span>

<span class="token comment">-- 测试递归函数</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"5的阶乘:"</span><span class="token punctuation">,</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"斐波那契第6项:"</span><span class="token punctuation">,</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="3. 辅助阅读代码" dir="auto" class="heading" id="3._辅助阅读代码_0">3. 辅助阅读代码</h3></div><div class="el-p"><p dir="auto">查看调用堆栈可方便查看调用链，在特定位置断点查看变量值可辅助理解代码含义，使用单步可让程序自动跳转到执行位置。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 简单的购物车系统 - 通过断点理解代码逻辑</span>

<span class="token comment">-- 1. 商品数据</span>
<span class="token comment">-- 断点: 查看商品初始化</span>
<span class="token keyword">local</span> products <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">5.5</span><span class="token punctuation">,</span> stock <span class="token operator">=</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"香蕉"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">3.2</span><span class="token punctuation">,</span> stock <span class="token operator">=</span> <span class="token number">80</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"橙子"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">4.8</span><span class="token punctuation">,</span> stock <span class="token operator">=</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> id <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"葡萄"</span><span class="token punctuation">,</span> price <span class="token operator">=</span> <span class="token number">8.9</span><span class="token punctuation">,</span> stock <span class="token operator">=</span> <span class="token number">40</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 2. 购物车数据</span>
<span class="token comment">-- 断点: 观察购物车初始化</span>
<span class="token keyword">local</span> shopping_cart <span class="token operator">=</span> <span class="token punctuation">{</span>
    items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">-- 购买的商品</span>
    total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>     <span class="token comment">-- 总金额</span>
    item_count <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">-- 商品数量</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 3. 查找商品函数</span>
<span class="token comment">-- 断点: 了解如何查找商品</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">find_product</span><span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> product <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> product<span class="token punctuation">.</span>id <span class="token operator">==</span> product_id <span class="token keyword">then</span>
            <span class="token keyword">return</span> product
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

<span class="token comment">-- 4. 添加商品到购物车</span>
<span class="token comment">-- 断点: 查看核心逻辑</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">add_to_cart</span><span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> quantity<span class="token punctuation">)</span>
    quantity <span class="token operator">=</span> quantity <span class="token keyword">or</span> <span class="token number">1</span> <span class="token comment">-- 默认数量为1</span>

    <span class="token comment">-- 查找商品</span>
    <span class="token keyword">local</span> product <span class="token operator">=</span> <span class="token function">find_product</span><span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> product <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"商品不存在"</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 检查库存</span>
    <span class="token keyword">if</span> product<span class="token punctuation">.</span>stock <span class="token operator">&lt;</span> quantity <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"库存不足"</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 更新购物车</span>
    <span class="token keyword">local</span> existing_item <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">[</span>product_id<span class="token punctuation">]</span>
    <span class="token keyword">if</span> existing_item <span class="token keyword">then</span>
        <span class="token comment">-- 已存在，增加数量</span>
        existing_item<span class="token punctuation">.</span>quantity <span class="token operator">=</span> existing_item<span class="token punctuation">.</span>quantity <span class="token operator">+</span> quantity
        existing_item<span class="token punctuation">.</span>subtotal <span class="token operator">=</span> existing_item<span class="token punctuation">.</span>quantity <span class="token operator">*</span> product<span class="token punctuation">.</span>price
    <span class="token keyword">else</span>
        <span class="token comment">-- 新商品</span>
        shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">[</span>product_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            product_id <span class="token operator">=</span> product_id<span class="token punctuation">,</span>
            name <span class="token operator">=</span> product<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            price <span class="token operator">=</span> product<span class="token punctuation">.</span>price<span class="token punctuation">,</span>
            quantity <span class="token operator">=</span> quantity<span class="token punctuation">,</span>
            subtotal <span class="token operator">=</span> product<span class="token punctuation">.</span>price <span class="token operator">*</span> quantity
        <span class="token punctuation">}</span>
        shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 更新库存</span>
    product<span class="token punctuation">.</span>stock <span class="token operator">=</span> product<span class="token punctuation">.</span>stock <span class="token operator">-</span> quantity

    <span class="token comment">-- 更新总金额</span>
    shopping_cart<span class="token punctuation">.</span>total <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>total <span class="token operator">+</span> <span class="token punctuation">(</span>product<span class="token punctuation">.</span>price <span class="token operator">*</span> quantity<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token string">"添加成功"</span>
<span class="token keyword">end</span>

<span class="token comment">-- 5. 从购物车移除商品</span>
<span class="token comment">-- 断点: 理解移除逻辑</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">remove_from_cart</span><span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> quantity<span class="token punctuation">)</span>
    <span class="token keyword">local</span> item <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">[</span>product_id<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> item <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"商品不在购物车中"</span>
    <span class="token keyword">end</span>

    quantity <span class="token operator">=</span> quantity <span class="token keyword">or</span> item<span class="token punctuation">.</span>quantity <span class="token comment">-- 默认移除全部</span>

    <span class="token keyword">if</span> quantity <span class="token operator">&gt;</span> item<span class="token punctuation">.</span>quantity <span class="token keyword">then</span>
        quantity <span class="token operator">=</span> item<span class="token punctuation">.</span>quantity
    <span class="token keyword">end</span>

    <span class="token comment">-- 更新购物车</span>
    <span class="token keyword">if</span> quantity <span class="token operator">==</span> item<span class="token punctuation">.</span>quantity <span class="token keyword">then</span>
        <span class="token comment">-- 移除整个商品</span>
        shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">[</span>product_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
        shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">else</span>
        <span class="token comment">-- 减少数量</span>
        item<span class="token punctuation">.</span>quantity <span class="token operator">=</span> item<span class="token punctuation">.</span>quantity <span class="token operator">-</span> quantity
        item<span class="token punctuation">.</span>subtotal <span class="token operator">=</span> item<span class="token punctuation">.</span>quantity <span class="token operator">*</span> item<span class="token punctuation">.</span>price
    <span class="token keyword">end</span>

    <span class="token comment">-- 恢复库存</span>
    <span class="token keyword">local</span> product <span class="token operator">=</span> <span class="token function">find_product</span><span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> product <span class="token keyword">then</span>
        product<span class="token punctuation">.</span>stock <span class="token operator">=</span> product<span class="token punctuation">.</span>stock <span class="token operator">+</span> quantity
    <span class="token keyword">end</span>

    <span class="token comment">-- 更新总金额</span>
    shopping_cart<span class="token punctuation">.</span>total <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>total <span class="token operator">-</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>price <span class="token operator">*</span> quantity<span class="token punctuation">)</span>

    <span class="token comment">-- 如果总金额为负，设为0</span>
    <span class="token keyword">if</span> shopping_cart<span class="token punctuation">.</span>total <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
        shopping_cart<span class="token punctuation">.</span>total <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token string">"移除成功"</span>
<span class="token keyword">end</span>

<span class="token comment">-- 6. 显示购物车</span>
<span class="token comment">-- 断点: 查看显示逻辑</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">show_cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"购物车为空"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n=== 购物车内容 ==="</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%-5s %-10s %-8s %-8s %-8s"</span><span class="token punctuation">,</span>
        <span class="token string">"ID"</span><span class="token punctuation">,</span> <span class="token string">"商品名"</span><span class="token punctuation">,</span> <span class="token string">"单价"</span><span class="token punctuation">,</span> <span class="token string">"数量"</span><span class="token punctuation">,</span> <span class="token string">"小计"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token keyword">do</span>
        count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%-5d %-10s %-8.2f %-8d %-8.2f"</span><span class="token punctuation">,</span>
            item<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> item<span class="token punctuation">.</span>price<span class="token punctuation">,</span>
            item<span class="token punctuation">.</span>quantity<span class="token punctuation">,</span> item<span class="token punctuation">.</span>subtotal<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"总计: %.2f 元"</span><span class="token punctuation">,</span> shopping_cart<span class="token punctuation">.</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"商品总数: %d 件"</span><span class="token punctuation">,</span> shopping_cart<span class="token punctuation">.</span>item_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 7. 显示商品列表</span>
<span class="token comment">-- 断点: 查看商品展示</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">show_products</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n=== 商品列表 ==="</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%-5s %-10s %-8s %-8s"</span><span class="token punctuation">,</span>
        <span class="token string">"ID"</span><span class="token punctuation">,</span> <span class="token string">"商品名"</span><span class="token punctuation">,</span> <span class="token string">"价格"</span><span class="token punctuation">,</span> <span class="token string">"库存"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> _<span class="token punctuation">,</span> product <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%-5d %-10s %-8.2f %-8d"</span><span class="token punctuation">,</span>
            product<span class="token punctuation">.</span>id<span class="token punctuation">,</span> product<span class="token punctuation">.</span>name<span class="token punctuation">,</span> product<span class="token punctuation">.</span>price<span class="token punctuation">,</span> product<span class="token punctuation">.</span>stock<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 8. 结算函数</span>
<span class="token comment">-- 断点: 了解结算过程</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"购物车为空"</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n=== 结算 ==="</span><span class="token punctuation">)</span>
    <span class="token function">show_cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">-- 应用折扣（满100减10）</span>
    <span class="token keyword">local</span> discount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> shopping_cart<span class="token punctuation">.</span>total <span class="token operator">&gt;=</span> <span class="token number">100</span> <span class="token keyword">then</span>
        discount <span class="token operator">=</span> <span class="token number">10</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"\n折扣: -%.2f 元"</span><span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> final_total <span class="token operator">=</span> shopping_cart<span class="token punctuation">.</span>total <span class="token operator">-</span> discount
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"实付金额: %.2f 元"</span><span class="token punctuation">,</span> final_total<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">-- 清空购物车</span>
    <span class="token keyword">for</span> product_id<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token keyword">do</span>
        shopping_cart<span class="token punctuation">.</span>items<span class="token punctuation">[</span>product_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>

    shopping_cart<span class="token punctuation">.</span>total <span class="token operator">=</span> <span class="token number">0</span>
    shopping_cart<span class="token punctuation">.</span>item_count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token string">"结算成功"</span>
<span class="token keyword">end</span>

<span class="token comment">-- 9. 主程序流程</span>
<span class="token comment">-- 断点: 开始跟踪整个流程</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"欢迎使用购物车系统!"</span><span class="token punctuation">)</span>

    <span class="token comment">-- 初始状态</span>
    <span class="token function">show_products</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">-- 测试购物车操作</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n[测试1] 添加商品到购物车"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 断点: 跟踪添加过程</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token function">add_to_cart</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">-- 3个苹果</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"添加苹果:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

    success<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token function">add_to_cart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 2个香蕉</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"添加香蕉:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

    success<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token function">add_to_cart</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">-- 5个橙子</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"添加橙子:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

    <span class="token comment">-- 查看购物车</span>
    <span class="token function">show_cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n[测试2] 再次添加相同商品"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 断点: 观察重复添加</span>
    success<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token function">add_to_cart</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 再添加2个苹果</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"再添加苹果:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

    <span class="token function">show_cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">show_products</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 查看库存变化</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n[测试3] 移除部分商品"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 断点: 跟踪移除过程</span>
    success<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token function">remove_from_cart</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 移除2个橙子</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"移除橙子:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

    <span class="token function">show_cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">show_products</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 查看库存恢复</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n[测试4] 尝试结算"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 断点: 观察结算流程</span>
    success<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"结算结果:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n[测试5] 结算后查看状态"</span><span class="token punctuation">)</span>
    <span class="token function">show_cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n谢谢使用!"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 10. 运行程序</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.7 为什么需要错误处理？" dir="auto" class="heading" id="10.7_为什么需要错误处理？_0">10.7 为什么需要错误处理？</h2></div><div class="el-p"><p dir="auto">在现实的程序中，错误是不可避免的。没有错误处理的程序就像没有刹车的汽车一样危险。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 没有错误处理的危险程序</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">get_table_value</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k1<span class="token punctuation">,</span> k2<span class="token punctuation">)</span>
	<span class="token keyword">return</span> t<span class="token punctuation">[</span>k1<span class="token punctuation">]</span><span class="token punctuation">[</span>k2<span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">get_table_value</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span><span class="token punctuation">)</span>	<span class="token comment">-- t.key1 为 nil，t.key1.key2 会报错：尝试索引 nil 值</span>
<span class="token comment">-- 程序会在这里抛出错误，程序终止</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"这行代码不会执行"</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.8 Lua 的错误类型" dir="auto" class="heading" id="10.8_Lua_的错误类型_0">10.8 Lua 的错误类型</h2></div><div class="el-h4"><h4 data-heading="1. 语法错误" dir="auto" class="heading" id="1._语法错误_0">1. 语法错误</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 忘记写值</span>
<span class="token keyword">local</span> x <span class="token operator">=</span>
<span class="token comment">-- 错误: unexpected symbol near '&lt;eof&gt;'</span>

<span class="token comment">-- 2. 代码块没有闭合</span>
<span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">3</span>
<span class="token comment">-- 错误: '}' expected (to close '{' at line 1)</span>
<span class="token keyword">if</span> a <span class="token keyword">then</span>
<span class="token comment">-- 错误: 'end' expected (to close 'if' at line 1) near '&lt;eof&gt;'</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="2. 运行时错误" dir="auto" class="heading" id="2._运行时错误_0">2. 运行时错误</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 索引 nil 值</span>
<span class="token function">print</span><span class="token punctuation">(</span>undefined_table<span class="token punctuation">.</span>v<span class="token punctuation">)</span>
<span class="token comment">-- 错误: attempt to index global 'undefined_table' (a nil value) 尝试索引 nil 值</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="3. 逻辑错误" dir="auto" class="heading" id="3._逻辑错误_0">3. 逻辑错误</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 程序能运行，结果不对</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">calculate_average</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>
    <span class="token keyword">local</span> sum <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>numbers <span class="token keyword">do</span>
        sum <span class="token operator">=</span> sum <span class="token operator">+</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> sum <span class="token operator">/</span> <span class="token operator">#</span>numbers  <span class="token comment">-- 如果numbers为空表，会除以0，返回 1.#INF</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="4. 资源错误" dir="auto" class="heading" id="4._资源错误_0">4. 资源错误</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 1. 文件不存在</span>
<span class="token keyword">local</span> file<span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"nonexistent.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> file <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>  <span class="token comment">-- 输出: nonexistent.txt: No such file or directory</span>
<span class="token keyword">end</span>

<span class="token comment">-- 2. 内存不足</span>
<span class="token keyword">local</span> huge_table <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>huge <span class="token keyword">do</span>
	huge_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">-- 报错: not enough memory</span>

<span class="token comment">-- 3. 栈溢出</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">err_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">err_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token function">err_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 报错: stack overflow</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.9 错误信息" dir="auto" class="heading" id="10.9_错误信息_0">10.9 错误信息</h2></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">test_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    a<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">123</span>
<span class="token keyword">end</span>

<span class="token function">test_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
lua: test.lua:2: attempt to index global 'a' (a nil value)
stack traceback:
	test.lua:2: in function 'test_fn'
	test.lua:5: in main chunk
	[C]: ?
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>test.lua:2</code> 为错误的路径模块与行数<br>
<code>attempt to index global 'a' (a nil value)</code> 为错误信息：尝试索引 nil 值<br>
<code>stack traceback</code> 调用堆栈（从下往上看）<br>
<code>test.lua:5: in main chunk</code> 在主代码块先执行了第 5 行代码<br>
<code>test.lua:2: in function 'test_fn'</code> 最后执行了 <code>test_fn</code> 函数中的第 2 行</p></div><div class="el-h2"><h2 data-heading="10.10 错误处理" dir="auto" class="heading" id="10.10_错误处理_0">10.10 错误处理</h2></div><div class="el-h3"><h3 data-heading="10.10.1 pcall - 保护调用" dir="auto" class="heading" id="10.10.1_pcall_-_保护调用_0">10.10.1 pcall - 保护调用</h3></div><div class="el-p"><p dir="auto">pcall (protected call) 是Lua最基本的错误处理机制，以保护模式调用函数。函数中的任何错误不会抛出；取而代之的是 <code>pcall</code>&nbsp;会将错误捕获。</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token function">pcall</span><span class="token punctuation">(</span>保护函数<span class="token punctuation">:</span> func<span class="token punctuation">,</span> 函数参数<span class="token punctuation">:</span> any<span class="token punctuation">...</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> 是否有错误<span class="token punctuation">:</span> bool<span class="token punctuation">,</span> 返回值<span class="token operator">|</span>错误信息<span class="token punctuation">:</span> any<span class="token operator">|</span>str<span class="token punctuation">...</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_0">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- pcall处理多个返回值</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">multiple_returns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">failing_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"出错了！"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n多返回值处理:"</span><span class="token punctuation">)</span>
success<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>multiple_returns<span class="token punctuation">)</span>
<span class="token keyword">if</span> success <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  成功返回: "</span> <span class="token operator">..</span> a <span class="token operator">..</span> <span class="token string">", "</span> <span class="token operator">..</span> b <span class="token operator">..</span> <span class="token string">", "</span> <span class="token operator">..</span> c <span class="token operator">..</span> <span class="token string">", "</span> <span class="token operator">..</span> d <span class="token operator">..</span> <span class="token string">", "</span> <span class="token operator">..</span> e<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  错误: "</span> <span class="token operator">..</span> a<span class="token punctuation">)</span>  <span class="token comment">-- 注意：错误信息在第一个返回值</span>
<span class="token keyword">end</span>

success<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>failing_function<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  捕获错误: "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
成功返回: 1, 2, 3, 4, 5
捕获错误: 出错了！
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.10.2 xpcall - 带错误处理的保护调用" dir="auto" class="heading" id="10.10.2_xpcall_-_带错误处理的保护调用_0">10.10.2 xpcall - 带错误处理的保护调用</h3></div><div class="el-p"><p dir="auto">xpcall 比 pcall 更强大，可以指定错误信息处理函数</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token function">xpcall</span><span class="token punctuation">(</span>保护函数<span class="token punctuation">:</span> func<span class="token punctuation">,</span> 信息处理函数<span class="token punctuation">:</span> func<span class="token punctuation">,</span> 函数参数<span class="token punctuation">:</span> any<span class="token punctuation">...</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> 是否有错误<span class="token punctuation">:</span> bool<span class="token punctuation">,</span> 返回值<span class="token operator">|</span>处理后的信息<span class="token punctuation">:</span> any<span class="token operator">|</span>str<span class="token punctuation">...</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_1">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 错误处理函数</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">error_handler</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token comment">-- err参数是错误信息</span>
    <span class="token keyword">local</span> debug_info <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">traceback</span><span class="token punctuation">(</span><span class="token string">"错误追踪:"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"发生错误: %s\n%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> debug_info<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">risky_operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> t<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span>  <span class="token comment">-- t[10]是nil，nil * 2会出错</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"xpcall示例1:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">xpcall</span><span class="token punctuation">(</span>risky_operation<span class="token punctuation">,</span> error_handler<span class="token punctuation">)</span>
<span class="token keyword">if</span> success <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  结果: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  错误处理:\n"</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
发生错误: test.lua:10: attempt to perform arithmetic on field '?' (a nil value)
错误追踪:
stack traceback:
	test.lua:10: in function &lt;test.lua:8&gt;
	[C]: in function 'xpcall'
	test.lua:14: in main chunk
	[C]: ?
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.10.3 error - 抛出错误" dir="auto" class="heading" id="10.10.3_error_-_抛出错误_0">10.10.3 error - 抛出错误</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token function">error</span><span class="token punctuation">(</span>信息<span class="token punctuation">:</span> str<span class="token punctuation">,</span> 错误级别?<span class="token punctuation">:</span> int<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">错误级别默认为 1</li>
</ul></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_2">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 示例1：基本错误抛出</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">validate_age</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"number"</span> <span class="token keyword">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"年龄必须是数字"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">-- level=2表示错误在调用者的位置</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">if</span> age <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"年龄不能为负数"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">if</span> age <span class="token operator">&gt;</span> <span class="token number">150</span> <span class="token keyword">or</span> age <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"年龄不合理"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"年龄验证测试:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> test_ages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"二十"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> age <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>test_ages<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>validate_age<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">if</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  年龄 "</span> <span class="token operator">..</span> age <span class="token operator">..</span> <span class="token string">": 有效"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  年龄 "</span> <span class="token operator">..</span> age <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
年龄 25: 有效
年龄 -5: 年龄不能为负数
年龄 二十: 年龄必须是数字
年龄 200: 年龄不合理
年龄 0: 有效
--]]</span>

<span class="token comment">-- 示例2：错误级别的作用</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">level_demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n错误级别演示:"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">inner_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"错误发生在inner_function"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">-- level 0: 不添加位置信息</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">middle_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"错误发生在middle_function"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">-- level 1: 调用error的位置</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">outer_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"错误发生在outer_function"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">-- level 2: 调用者的位置</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 测试不同level</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">test_error</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> level_desc<span class="token punctuation">)</span>
        <span class="token keyword">local</span> success<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> level_desc <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token function">test_error</span><span class="token punctuation">(</span>inner_function<span class="token punctuation">,</span> <span class="token string">"level 0"</span><span class="token punctuation">)</span>
    <span class="token function">test_error</span><span class="token punctuation">(</span>middle_function<span class="token punctuation">,</span> <span class="token string">"level 1"</span><span class="token punctuation">)</span>
    <span class="token function">test_error</span><span class="token punctuation">(</span>outer_function<span class="token punctuation">,</span> <span class="token string">"level 2"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token function">level_demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.10.4 assert - 断言" dir="auto" class="heading" id="10.10.4_assert_-_断言_0">10.10.4 assert - 断言</h3></div><div class="el-p"><p dir="auto">assert 用于检查条件，如果条件为假则抛出错误</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token function">assert</span><span class="token punctuation">(</span>条件<span class="token punctuation">:</span> bool<span class="token punctuation">,</span> 错误信息?<span class="token punctuation">:</span> str<span class="token punctuation">,</span> 参数?<span class="token punctuation">:</span> any<span class="token punctuation">...</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> 参数<span class="token punctuation">:</span> any<span class="token punctuation">...</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">错误信息默认为 <code>"assertion failed!"</code></li>
</ul></div><div class="el-h4"><h4 data-heading="示例" dir="auto" class="heading" id="示例_3">示例</h4></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 示例1：基本断言</span>
<span class="token keyword">function</span> <span class="token function">calculate_bmi</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token comment">-- 参数验证</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"体重必须是数字"</span><span class="token punctuation">)</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"身高必须是数字"</span><span class="token punctuation">)</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>weight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"体重必须大于0"</span><span class="token punctuation">)</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>height <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"身高必须大于0"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> weight <span class="token operator">/</span> <span class="token punctuation">(</span>height <span class="token operator">*</span> height<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"BMI计算测试:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> test_cases <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">1.75</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token comment">-- 有效</span>
    <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">1.75</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">-- 无效体重</span>
    <span class="token punctuation">{</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.75</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">-- 无效身高</span>
    <span class="token punctuation">{</span><span class="token string">"70"</span><span class="token punctuation">,</span> <span class="token number">1.75</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">-- 字符串体重</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> case <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>test_cases<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>calculate_bmi<span class="token punctuation">,</span> case<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> case<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  体重%.1fkg, 身高%.2fm -&gt; BMI: %.1f"</span><span class="token punctuation">,</span> 
              case<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> case<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  错误: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 示例2：assert与error的区别</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\nassert vs error:"</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">using_assert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>value <span class="token operator">~=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"值不能为nil"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> value <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> <span class="token function">using_error</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"值不能为nil"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> value <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">end</span>

<span class="token comment">-- 两个函数的功能相同，但assert更简洁</span>
<span class="token keyword">local</span> test_values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">}</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>test_values<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n测试值: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">local</span> success1<span class="token punctuation">,</span> result1 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>using_assert<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> success1 <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  assert版本: "</span> <span class="token operator">..</span> result1<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  assert版本错误: "</span> <span class="token operator">..</span> result1<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> success2<span class="token punctuation">,</span> result2 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>using_error<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> success2 <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  error版本: "</span> <span class="token operator">..</span> result2<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  error版本错误: "</span> <span class="token operator">..</span> result2<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 示例3：在生产环境中禁用断言</span>
<span class="token comment">-- 在开发时使用断言检查，发布时可以关闭</span>
<span class="token keyword">local</span> DEBUG_MODE <span class="token operator">=</span> <span class="token keyword">true</span>

<span class="token keyword">function</span> <span class="token function">release_assert</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">if</span> DEBUG_MODE <span class="token keyword">then</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">elseif</span> <span class="token keyword">not</span> condition <span class="token keyword">then</span>
        <span class="token comment">-- 在生产环境中，记录错误但不抛出</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"[生产环境错误] "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>message <span class="token keyword">or</span> <span class="token string">"断言失败"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n生产环境断言:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">test_function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token function">release_assert</span><span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"x必须大于0"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">end</span>

<span class="token comment">-- 测试模式</span>
DEBUG_MODE <span class="token operator">=</span> <span class="token keyword">true</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"调试模式:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>test_function<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  错误: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 生产模式</span>
DEBUG_MODE <span class="token operator">=</span> <span class="token keyword">false</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n生产模式:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> result <span class="token operator">=</span> <span class="token function">test_function</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> result <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  结果: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  函数返回nil（不抛出错误）"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.11 错误处理策略" dir="auto" class="heading" id="10.11_错误处理策略_0">10.11 错误处理策略</h2></div><div class="el-h3"><h3 data-heading="10.11.1 防御性编程" dir="auto" class="heading" id="10.11.1_防御性编程_0">10.11.1 防御性编程</h3></div><div class="el-p"><p dir="auto">假设一切可能出错，并提前处理</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 示例1：安全的表访问</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">safe_table_access</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> key<span class="token punctuation">,</span> default<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"table"</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> default
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> value <span class="token operator">=</span> t<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> default
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> value
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"安全表访问:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>theme <span class="token operator">=</span> <span class="token string">"dark"</span><span class="token punctuation">,</span> language <span class="token operator">=</span> <span class="token string">"zh-CN"</span><span class="token punctuation">}</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  主题: "</span> <span class="token operator">..</span> <span class="token function">safe_table_access</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">"theme"</span><span class="token punctuation">,</span> <span class="token string">"light"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  音量: "</span> <span class="token operator">..</span> <span class="token function">safe_table_access</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">"volume"</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- 使用默认值</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  非表: "</span> <span class="token operator">..</span> <span class="token function">safe_table_access</span><span class="token punctuation">(</span><span class="token string">"不是表"</span><span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"默认"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
主题: dark
音量: 70
非表: 默认
--]]</span>

<span class="token comment">-- 示例2：安全的函数调用</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">safe_call</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"function"</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"不是函数"</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> result
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> result
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n安全函数调用:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token keyword">end</span>
<span class="token keyword">local</span> result<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">safe_call</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> result <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  5 + 3 = "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  错误: "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
<span class="token keyword">end</span>

result<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">safe_call</span><span class="token punctuation">(</span><span class="token string">"不是函数"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> result <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  结果: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  错误: "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
5 + 3 = 8
 错误: 不是函数
--]]</span>

<span class="token comment">-- 示例3：验证输入数据</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">validate_user_input</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token comment">-- 多层验证</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> input <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"输入不能为空"</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"table"</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"输入必须是表"</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 验证必填字段</span>
    <span class="token keyword">local</span> required <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> field <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>required<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> input<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token operator">#</span><span class="token function">tostring</span><span class="token punctuation">(</span>input<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"字段 '"</span> <span class="token operator">..</span> field <span class="token operator">..</span> <span class="token string">"' 不能为空"</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 验证邮箱格式</span>
    <span class="token keyword">local</span> email <span class="token operator">=</span> input<span class="token punctuation">.</span>email
    <span class="token keyword">if</span> <span class="token keyword">not</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> <span class="token string">"^[%w%.%-]+@[%w%.%-]+%.[%a]+$"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"邮箱格式无效"</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 验证密码强度</span>
    <span class="token keyword">local</span> password <span class="token operator">=</span> input<span class="token punctuation">.</span>password
    <span class="token keyword">if</span> <span class="token operator">#</span>password <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"密码至少需要8个字符"</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n输入验证:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> inputs <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"user1"</span><span class="token punctuation">,</span> email <span class="token operator">=</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span> password <span class="token operator">=</span> <span class="token string">"secure123"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> email <span class="token operator">=</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span> password <span class="token operator">=</span> <span class="token string">"short"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 用户名为空</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"user2"</span><span class="token punctuation">,</span> email <span class="token operator">=</span> <span class="token string">"invalid-email"</span><span class="token punctuation">,</span> password <span class="token operator">=</span> <span class="token string">"password123"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 邮箱无效</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"user3"</span><span class="token punctuation">,</span> email <span class="token operator">=</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span> password <span class="token operator">=</span> <span class="token string">"123"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 密码太短</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> input <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> valid<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">validate_user_input</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token keyword">if</span> valid <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  输入 "</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": 有效"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  输入 "</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">": 无效 - "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
  输入 1: 有效
  输入 2: 无效 - 字段 'username' 不能为空
  输入 3: 无效 - 邮箱格式无效
  输入 4: 无效 - 密码至少需要8个字符
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="10.11.2 错误恢复策略" dir="auto" class="heading" id="10.11.2_错误恢复策略_0">10.11.2 错误恢复策略</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 错误恢复：从错误中恢复并继续执行</span>
<span class="token comment">-- 策略1：重试机制</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">retry_operation</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> max_attempts<span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
    max_attempts <span class="token operator">=</span> max_attempts <span class="token keyword">or</span> <span class="token number">3</span>
    delay <span class="token operator">=</span> delay <span class="token keyword">or</span> <span class="token number">1</span>  <span class="token comment">-- 默认延迟1秒</span>
    
    <span class="token keyword">for</span> attempt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> max_attempts <span class="token keyword">do</span>
        <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> success <span class="token keyword">then</span>
            <span class="token keyword">return</span> result
        <span class="token keyword">end</span>
        
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  尝试 %d/%d 失败: %s"</span><span class="token punctuation">,</span> 
              attempt<span class="token punctuation">,</span> max_attempts<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> attempt <span class="token operator">&lt;</span> max_attempts <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  等待 %.1f 秒后重试..."</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">-- 在实际应用中，这里应该使用 os.execute 或类似方法等待</span>
            <span class="token comment">-- 为了示例简化，我们只是打印</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"所有重试尝试都失败"</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"重试机制:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">unreliable_operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    math<span class="token punctuation">.</span><span class="token function">randomseed</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.7</span> <span class="token keyword">then</span>  <span class="token comment">-- 70%失败率</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"操作失败: 随机错误"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> <span class="token string">"操作成功"</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> result<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">retry_operation</span><span class="token punctuation">(</span>unreliable_operation<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> result <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  最终结果: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  最终错误: "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 策略2：降级服务</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n降级服务:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">fetch_data</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> fallback_source<span class="token punctuation">)</span>
    <span class="token comment">-- 尝试主数据源</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>fetch<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  使用主数据源"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data
    <span class="token keyword">end</span>
    
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  主数据源失败: "</span> <span class="token operator">..</span> data<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  尝试备用数据源..."</span><span class="token punctuation">)</span>
    
    <span class="token comment">-- 尝试备用数据源</span>
    success<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>fallback_source<span class="token punctuation">.</span>fetch<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  使用备用数据源"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data
    <span class="token keyword">end</span>
    
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  备用数据源也失败: "</span> <span class="token operator">..</span> data<span class="token punctuation">)</span>
    
    <span class="token comment">-- 返回缓存或默认数据</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  返回缓存数据"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>cached <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">"默认数据"</span><span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token comment">-- 模拟数据源</span>
<span class="token keyword">local</span> primary_source <span class="token operator">=</span> <span class="token punctuation">{</span>
    fetch <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token keyword">then</span>
            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"主数据源不可用"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>source <span class="token operator">=</span> <span class="token string">"primary"</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">"新鲜数据"</span><span class="token punctuation">}</span>
    <span class="token keyword">end</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> fallback_source <span class="token operator">=</span> <span class="token punctuation">{</span>
    fetch <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.3</span> <span class="token keyword">then</span>
            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"备用数据源不可用"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>source <span class="token operator">=</span> <span class="token string">"fallback"</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">"稍旧的数据"</span><span class="token punctuation">}</span>
    <span class="token keyword">end</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n尝试 "</span> <span class="token operator">..</span> i <span class="token operator">..</span> <span class="token string">":"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> data <span class="token operator">=</span> <span class="token function">fetch_data</span><span class="token punctuation">(</span>primary_source<span class="token punctuation">,</span> fallback_source<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  获取的数据: "</span> <span class="token operator">..</span> data<span class="token punctuation">.</span>data <span class="token operator">..</span> <span class="token string">" (来源: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>source <span class="token keyword">or</span> <span class="token string">"缓存"</span><span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">")"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 策略3：优雅降级</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n优雅降级:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">render_ui</span><span class="token punctuation">(</span>use_advanced_features<span class="token punctuation">)</span>
    <span class="token keyword">local</span> features <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token comment">-- 基础功能总是可用的</span>
    features<span class="token punctuation">.</span>basic <span class="token operator">=</span> <span class="token keyword">true</span>
    
    <span class="token comment">-- 高级功能可能不可用</span>
    <span class="token keyword">if</span> use_advanced_features <span class="token keyword">then</span>
        <span class="token keyword">local</span> success <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">-- 模拟需要特定库或环境的功能</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> package<span class="token punctuation">.</span>loaded<span class="token punctuation">[</span><span class="token string">"advanced_graphics"</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
                <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"高级图形库未安装"</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>
            features<span class="token punctuation">.</span>advanced_graphics <span class="token operator">=</span> <span class="token keyword">true</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  警告: 高级图形功能不可用，使用基础渲染"</span><span class="token punctuation">)</span>
            features<span class="token punctuation">.</span>advanced_graphics <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
    <span class="token keyword">else</span>
        features<span class="token punctuation">.</span>advanced_graphics <span class="token operator">=</span> <span class="token keyword">false</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 根据可用功能渲染UI</span>
    <span class="token keyword">if</span> features<span class="token punctuation">.</span>advanced_graphics <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  使用高级UI渲染"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  使用基础UI渲染"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> features
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"渲染测试:"</span><span class="token punctuation">)</span>
<span class="token function">render_ui</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span>
<span class="token function">render_ui</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>

<span class="token comment">-- 策略4：隔离故障</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n故障隔离:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">isolated_operation</span><span class="token punctuation">(</span>operation_name<span class="token punctuation">,</span> operation_func<span class="token punctuation">)</span>
    <span class="token comment">-- 在独立的协程中执行操作，防止一个操作失败影响其他操作</span>
    <span class="token keyword">local</span> co <span class="token operator">=</span> coroutine<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>operation_func<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  操作 '"</span> <span class="token operator">..</span> operation_name <span class="token operator">..</span> <span class="token string">"' 失败: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> result
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> result
    <span class="token keyword">end</span><span class="token punctuation">)</span>
    
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> coroutine<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span>
    <span class="token keyword">if</span> success <span class="token keyword">and</span> coroutine<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"dead"</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> result
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"操作未完成"</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"隔离执行:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

results<span class="token punctuation">.</span>op1 <span class="token operator">=</span> <span class="token function">isolated_operation</span><span class="token punctuation">(</span><span class="token string">"操作1"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"操作1故意失败"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

results<span class="token punctuation">.</span>op2 <span class="token operator">=</span> <span class="token function">isolated_operation</span><span class="token punctuation">(</span><span class="token string">"操作2"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"操作2成功"</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

results<span class="token punctuation">.</span>op3 <span class="token operator">=</span> <span class="token function">isolated_operation</span><span class="token punctuation">(</span><span class="token string">"操作3"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"操作3也失败"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n所有操作结果:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> name<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> result <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> name <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  "</span> <span class="token operator">..</span> name <span class="token operator">..</span> <span class="token string">": 失败"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.12 自定义错误类型" dir="auto" class="heading" id="10.12_自定义错误类型_0">10.12 自定义错误类型</h2></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 创建结构化的错误类型，便于处理</span>
<span class="token comment">-- 错误类型定义</span>
<span class="token keyword">local</span> ErrorTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
    VALIDATION <span class="token operator">=</span> <span class="token punctuation">{</span>
        code <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token string">"VALIDATION_ERROR"</span><span class="token punctuation">,</span>
        description <span class="token operator">=</span> <span class="token string">"输入验证失败"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    DATABASE <span class="token operator">=</span> <span class="token punctuation">{</span>
        code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token string">"DATABASE_ERROR"</span><span class="token punctuation">,</span>
        description <span class="token operator">=</span> <span class="token string">"数据库操作失败"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    NETWORK <span class="token operator">=</span> <span class="token punctuation">{</span>
        code <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token string">"NETWORK_ERROR"</span><span class="token punctuation">,</span>
        description <span class="token operator">=</span> <span class="token string">"网络通信失败"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    PERMISSION <span class="token operator">=</span> <span class="token punctuation">{</span>
        code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token string">"PERMISSION_ERROR"</span><span class="token punctuation">,</span>
        description <span class="token operator">=</span> <span class="token string">"权限不足"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    INTERNAL <span class="token operator">=</span> <span class="token punctuation">{</span>
        code <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token string">"INTERNAL_ERROR"</span><span class="token punctuation">,</span>
        description <span class="token operator">=</span> <span class="token string">"内部服务器错误"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 错误创建函数</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">create_error</span><span class="token punctuation">(</span>error_type<span class="token punctuation">,</span> message<span class="token punctuation">,</span> details<span class="token punctuation">)</span>
    <span class="token keyword">local</span> error_info <span class="token operator">=</span> ErrorTypes<span class="token punctuation">[</span>error_type<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> error_info <span class="token keyword">then</span>
        error_info <span class="token operator">=</span> ErrorTypes<span class="token punctuation">.</span>INTERNAL
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        type <span class="token operator">=</span> error_type<span class="token punctuation">,</span>
        code <span class="token operator">=</span> error_info<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        name <span class="token operator">=</span> error_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        message <span class="token operator">=</span> message <span class="token keyword">or</span> error_info<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
        details <span class="token operator">=</span> details<span class="token punctuation">,</span>
        timestamp <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        stack_trace <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">traceback</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token comment">-- 错误抛出函数</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">throw_error</span><span class="token punctuation">(</span>error_type<span class="token punctuation">,</span> message<span class="token punctuation">,</span> details<span class="token punctuation">)</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token function">create_error</span><span class="token punctuation">(</span>error_type<span class="token punctuation">,</span> message<span class="token punctuation">,</span> details<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 错误处理函数</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">handle_error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token comment">-- 如果是我们的自定义错误</span>
    <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"table"</span> <span class="token keyword">and</span> err<span class="token punctuation">.</span>code <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[错误处理] 类型: %s (%d)"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>name<span class="token punctuation">,</span> err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"          消息: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> err<span class="token punctuation">.</span>details <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"          详情: %s"</span><span class="token punctuation">,</span> <span class="token function">tostring</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">if</span> context <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"          上下文: %s"</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"          调用栈:"</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack_trace<span class="token punctuation">)</span>
        
        <span class="token comment">-- 根据错误类型采取不同措施</span>
        <span class="token keyword">if</span> err<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"VALIDATION"</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"输入错误，请检查后重试"</span>
        <span class="token keyword">elseif</span> err<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"PERMISSION"</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"权限不足，请联系管理员"</span>
        <span class="token keyword">elseif</span> err<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"NETWORK"</span> <span class="token keyword">then</span>
            <span class="token comment">-- 可以尝试重试</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"网络错误，请稍后重试"</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"系统错误，请联系技术支持"</span>
        <span class="token keyword">end</span>
    <span class="token keyword">else</span>
        <span class="token comment">-- 其他类型的错误</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"未知错误: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 使用自定义错误</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"自定义错误演示:"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">register_user</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span>
    <span class="token comment">-- 验证输入</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user_data <span class="token keyword">or</span> <span class="token keyword">not</span> user_data<span class="token punctuation">.</span>username <span class="token keyword">then</span>
        <span class="token function">throw_error</span><span class="token punctuation">(</span><span class="token string">"VALIDATION"</span><span class="token punctuation">,</span> <span class="token string">"用户名不能为空"</span><span class="token punctuation">,</span> user_data<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">if</span> <span class="token operator">#</span>user_data<span class="token punctuation">.</span>username <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">then</span>
        <span class="token function">throw_error</span><span class="token punctuation">(</span><span class="token string">"VALIDATION"</span><span class="token punctuation">,</span> <span class="token string">"用户名至少需要3个字符"</span><span class="token punctuation">,</span> 
                   <span class="token punctuation">{</span>username <span class="token operator">=</span> user_data<span class="token punctuation">.</span>username<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token operator">#</span>user_data<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 模拟数据库操作</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> db_result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- 模拟数据库错误</span>
        <span class="token keyword">if</span> user_data<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token keyword">then</span>
            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"用户名已存在"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>id <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">,</span> username <span class="token operator">=</span> user_data<span class="token punctuation">.</span>username<span class="token punctuation">}</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token function">throw_error</span><span class="token punctuation">(</span><span class="token string">"DATABASE"</span><span class="token punctuation">,</span> <span class="token string">"创建用户失败"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>error <span class="token operator">=</span> db_result<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">-- 模拟权限检查</span>
    <span class="token keyword">if</span> user_data<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"root"</span> <span class="token keyword">then</span>
        <span class="token function">throw_error</span><span class="token punctuation">(</span><span class="token string">"PERMISSION"</span><span class="token punctuation">,</span> <span class="token string">"不允许注册root用户"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> db_result
<span class="token keyword">end</span>

<span class="token comment">-- 测试不同的错误情况</span>
<span class="token keyword">local</span> test_cases <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span>           <span class="token comment">-- 验证错误</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"ab"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token comment">-- 用户名太短</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">-- 数据库错误</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">-- 权限错误</span>
    <span class="token punctuation">{</span>username <span class="token operator">=</span> <span class="token string">"正常用户"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">-- 成功</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> test_case <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>test_cases<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"\n测试用例 %d: 用户名='%s'"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> test_case<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>register_user<span class="token punctuation">,</span> test_case<span class="token punctuation">)</span>
    <span class="token keyword">if</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  成功: 用户ID = "</span> <span class="token operator">..</span> result<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token keyword">local</span> _<span class="token punctuation">,</span> user_message <span class="token operator">=</span> <span class="token function">handle_error</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"用户注册"</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  失败: "</span> <span class="token operator">..</span> user_message<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment">--[[ 输出
测试用例 1: 用户名=''
[错误处理] 类型: VALIDATION_ERROR (100)
          消息: 用户名至少需要3个字符
          详情: table: 00C22798
          上下文: 用户注册
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	test.lua:99: in function &lt;test.lua:92&gt;
	[C]: in function 'pcall'
	test.lua:136: in main chunk
	[C]: ?
  失败: 输入错误，请检查后重试

测试用例 2: 用户名='ab'
[错误处理] 类型: VALIDATION_ERROR (100)
          消息: 用户名至少需要3个字符
          详情: table: 00C22B30
          上下文: 用户注册
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	test.lua:99: in function &lt;test.lua:92&gt;
	[C]: in function 'pcall'
	test.lua:136: in main chunk
	[C]: ?
  失败: 输入错误，请检查后重试

测试用例 3: 用户名='admin'
[错误处理] 类型: DATABASE_ERROR (200)
          消息: 创建用户失败
          详情: table: 00C22C20
          上下文: 用户注册
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	est.lua:113: in function &lt;test.lua:92&gt;
	[C]: in function 'pcall'
	test.lua:136: in main chunk
	[C]: ?
  失败: 系统错误，请联系技术支持

测试用例 4: 用户名='root'
[错误处理] 类型: PERMISSION_ERROR (400)
          消息: 不允许注册root用户
          上下文: 用户注册
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	test.lua:118: in function &lt;test.lua:92&gt;
	[C]: in function 'pcall'
	test.lua:136: in main chunk
	[C]: ?
  失败: 权限不足，请联系管理员

测试用例 5: 用户名='正常用户'
  成功: 用户ID = 123
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.13 练习" dir="auto" class="heading" id="10.13_练习_0">10.13 练习</h2></div><div class="el-h3"><h3 data-heading="练习 1：使用断点阅读代码" dir="auto" class="heading" id="练习_1：使用断点阅读代码_0">练习 1：使用断点阅读代码</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token keyword">local</span> GradeSystem <span class="token operator">=</span> <span class="token punctuation">{</span>
    students <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    courses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    statistics <span class="token operator">=</span> <span class="token punctuation">{</span>
        total_students <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        total_courses <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        average_scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">generate_id</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> existing_ids<span class="token punctuation">)</span>
    <span class="token keyword">local</span> max_id <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> id<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>existing_ids<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> num <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">"%d+$"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> num <span class="token keyword">and</span> num <span class="token operator">&gt;</span> max_id <span class="token keyword">then</span>
            max_id <span class="token operator">=</span> num
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s%04d"</span><span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> max_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">calculate_weighted_average</span><span class="token punctuation">(</span>scores<span class="token punctuation">,</span> credits<span class="token punctuation">)</span>
    <span class="token keyword">local</span> total_score <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> total_credit <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> course_id<span class="token punctuation">,</span> score <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>scores<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> credit <span class="token operator">=</span> credits<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">1</span>
        total_score <span class="token operator">=</span> total_score <span class="token operator">+</span> score <span class="token operator">*</span> credit
        total_credit <span class="token operator">=</span> total_credit <span class="token operator">+</span> credit
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> total_credit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> total_score <span class="token operator">/</span> total_credit <span class="token keyword">or</span> <span class="token number">0</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> major<span class="token punctuation">,</span> class<span class="token punctuation">)</span>
    <span class="token keyword">local</span> student_id <span class="token operator">=</span> <span class="token function">generate_id</span><span class="token punctuation">(</span><span class="token string">"STU"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>students<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>students<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> student_id<span class="token punctuation">,</span>
        name <span class="token operator">=</span> name<span class="token punctuation">,</span>
        major <span class="token operator">=</span> major <span class="token keyword">or</span> <span class="token string">"未分配"</span><span class="token punctuation">,</span>
        class <span class="token operator">=</span> class <span class="token keyword">or</span> <span class="token string">"未知班级"</span><span class="token punctuation">,</span>
        enrolled_courses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        enroll_date <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    self<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_students <span class="token operator">=</span> self<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_students <span class="token operator">+</span> <span class="token number">1</span>

    <span class="token keyword">return</span> student_id
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">add_course</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> credit<span class="token punctuation">,</span> teacher<span class="token punctuation">)</span>
    <span class="token keyword">local</span> course_id <span class="token operator">=</span> <span class="token function">generate_id</span><span class="token punctuation">(</span><span class="token string">"COU"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>courses<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> course_id<span class="token punctuation">,</span>
        name <span class="token operator">=</span> name<span class="token punctuation">,</span>
        credit <span class="token operator">=</span> credit <span class="token keyword">or</span> <span class="token number">1</span><span class="token punctuation">,</span>
        teacher <span class="token operator">=</span> teacher <span class="token keyword">or</span> <span class="token string">"待分配"</span><span class="token punctuation">,</span>
        enrolled_students <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    self<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_courses <span class="token operator">=</span> self<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_courses <span class="token operator">+</span> <span class="token number">1</span>

    <span class="token keyword">return</span> course_id
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>student_id<span class="token punctuation">,</span> course_id<span class="token punctuation">)</span>
    <span class="token keyword">local</span> student <span class="token operator">=</span> self<span class="token punctuation">.</span>students<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span>
    <span class="token keyword">local</span> course <span class="token operator">=</span> self<span class="token punctuation">.</span>courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> student <span class="token keyword">or</span> <span class="token keyword">not</span> course <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"学生或课程不存在"</span>
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> student<span class="token punctuation">.</span>enrolled_courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"该课程已选"</span>
    <span class="token keyword">end</span>

    student<span class="token punctuation">.</span>enrolled_courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>
    student<span class="token punctuation">.</span>enrolled_courses<span class="token punctuation">[</span>course<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> course_id

    course<span class="token punctuation">.</span>enrolled_students<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>

    self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span><span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>

    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token string">"选课成功"</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">record_grade</span><span class="token punctuation">(</span>student_id<span class="token punctuation">,</span> course_id<span class="token punctuation">,</span> score<span class="token punctuation">)</span>
    <span class="token keyword">local</span> student <span class="token operator">=</span> self<span class="token punctuation">.</span>students<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span><span class="token punctuation">[</span>course_id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token keyword">not</span> student <span class="token keyword">or</span> <span class="token keyword">not</span> student<span class="token punctuation">.</span>enrolled_courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"学生未选此课程"</span>
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> score <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> score <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"分数必须在0-100之间"</span>
    <span class="token keyword">end</span>

    self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span><span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> score

    self<span class="token punctuation">:</span><span class="token function">update_statistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token string">"成绩录入成功"</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">update_statistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> course_scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> course_counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> student_id<span class="token punctuation">,</span> courses <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>grades<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">for</span> course_id<span class="token punctuation">,</span> score <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>courses<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">if</span> score <span class="token keyword">then</span>
                course_scores<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>course_scores<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> score
                course_counts<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>course_counts<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token keyword">for</span> course_id<span class="token punctuation">,</span> total_score <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>course_scores<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> count <span class="token operator">=</span> course_counts<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>average_scores<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> total_score <span class="token operator">/</span> count
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">get_student_report</span><span class="token punctuation">(</span>student_id<span class="token punctuation">)</span>
    <span class="token keyword">local</span> student <span class="token operator">=</span> self<span class="token punctuation">.</span>students<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> student <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"学生不存在"</span>
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> report <span class="token operator">=</span> <span class="token punctuation">{</span>
        student_id <span class="token operator">=</span> student_id<span class="token punctuation">,</span>
        name <span class="token operator">=</span> student<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        major <span class="token operator">=</span> student<span class="token punctuation">.</span>major<span class="token punctuation">,</span>
        class <span class="token operator">=</span> student<span class="token punctuation">.</span>class<span class="token punctuation">,</span>
        courses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        total_average <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        weighted_average <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">local</span> total_score <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> total_courses <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">local</span> scores_with_credits <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> credits <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> course_id<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>enrolled_courses<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token function">type</span><span class="token punctuation">(</span>course_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"string"</span> <span class="token keyword">and</span> course_id<span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">"^COU"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
            <span class="token keyword">local</span> course <span class="token operator">=</span> self<span class="token punctuation">.</span>courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span>
            <span class="token keyword">local</span> score <span class="token operator">=</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span><span class="token punctuation">[</span>course_id<span class="token punctuation">]</span>

            <span class="token keyword">if</span> course <span class="token keyword">then</span>
                <span class="token keyword">local</span> course_info <span class="token operator">=</span> <span class="token punctuation">{</span>
                    id <span class="token operator">=</span> course_id<span class="token punctuation">,</span>
                    name <span class="token operator">=</span> course<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                    credit <span class="token operator">=</span> course<span class="token punctuation">.</span>credit<span class="token punctuation">,</span>
                    teacher <span class="token operator">=</span> course<span class="token punctuation">.</span>teacher<span class="token punctuation">,</span>
                    score <span class="token operator">=</span> score <span class="token keyword">or</span> <span class="token string">"未录入"</span>
                <span class="token punctuation">}</span>

                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span>courses<span class="token punctuation">,</span> course_info<span class="token punctuation">)</span>

                <span class="token keyword">if</span> score <span class="token keyword">then</span>
                    total_score <span class="token operator">=</span> total_score <span class="token operator">+</span> score
                    total_courses <span class="token operator">=</span> total_courses <span class="token operator">+</span> <span class="token number">1</span>
                    scores_with_credits<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> score
                    credits<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span> <span class="token operator">=</span> course<span class="token punctuation">.</span>credit
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> total_courses <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
        report<span class="token punctuation">.</span>total_average <span class="token operator">=</span> total_score <span class="token operator">/</span> total_courses

        report<span class="token punctuation">.</span>weighted_average <span class="token operator">=</span> <span class="token function">calculate_weighted_average</span><span class="token punctuation">(</span>scores_with_credits<span class="token punctuation">,</span> credits<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    table<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span>courses<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token keyword">local</span> score_a <span class="token operator">=</span> a<span class="token punctuation">.</span>score <span class="token keyword">or</span> <span class="token number">0</span>
        <span class="token keyword">local</span> score_b <span class="token operator">=</span> b<span class="token punctuation">.</span>score <span class="token keyword">or</span> <span class="token number">0</span>
        <span class="token keyword">return</span> score_a <span class="token operator">&gt;</span> score_b
    <span class="token keyword">end</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> report
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">get_course_report</span><span class="token punctuation">(</span>course_id<span class="token punctuation">)</span>
    <span class="token keyword">local</span> course <span class="token operator">=</span> self<span class="token punctuation">.</span>courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> course <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"课程不存在"</span>
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> report <span class="token operator">=</span> <span class="token punctuation">{</span>
        course_id <span class="token operator">=</span> course_id<span class="token punctuation">,</span>
        name <span class="token operator">=</span> course<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        credit <span class="token operator">=</span> course<span class="token punctuation">.</span>credit<span class="token punctuation">,</span>
        teacher <span class="token operator">=</span> course<span class="token punctuation">.</span>teacher<span class="token punctuation">,</span>
        enrolled_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        graded_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        average_score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        score_distribution <span class="token operator">=</span> <span class="token punctuation">{</span>
            excellent <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"优秀"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            good <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"良好"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            medium <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"中等"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            pass <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"及格"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            fail <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"不及格"</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        student_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">local</span> total_score <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> student_id<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>course<span class="token punctuation">.</span>enrolled_students<span class="token punctuation">)</span> <span class="token keyword">do</span>
        report<span class="token punctuation">.</span>enrolled_count <span class="token operator">=</span> report<span class="token punctuation">.</span>enrolled_count <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token keyword">local</span> score <span class="token operator">=</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>grades<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span><span class="token punctuation">[</span>course_id<span class="token punctuation">]</span>
        <span class="token keyword">if</span> score <span class="token keyword">then</span>
            report<span class="token punctuation">.</span>graded_count <span class="token operator">=</span> report<span class="token punctuation">.</span>graded_count <span class="token operator">+</span> <span class="token number">1</span>
            total_score <span class="token operator">=</span> total_score <span class="token operator">+</span> score
            score_dis <span class="token operator">=</span> report<span class="token punctuation">.</span>score_distribution

            <span class="token keyword">if</span> score <span class="token operator">&gt;=</span> <span class="token number">90</span> <span class="token keyword">then</span>
                score_dis<span class="token punctuation">.</span>excellent<span class="token punctuation">.</span>count <span class="token operator">=</span> score_dis<span class="token punctuation">.</span>excellent<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> score <span class="token operator">&gt;=</span> <span class="token number">80</span> <span class="token keyword">then</span>
                score_dis<span class="token punctuation">.</span>good<span class="token punctuation">.</span>count <span class="token operator">=</span> score_dis<span class="token punctuation">.</span>good<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> score <span class="token operator">&gt;=</span> <span class="token number">70</span> <span class="token keyword">then</span>
                score_dis<span class="token punctuation">.</span>medium<span class="token punctuation">.</span>count <span class="token operator">=</span> score_dis<span class="token punctuation">.</span>medium<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> score <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">then</span>
                score_dis<span class="token punctuation">.</span>pass<span class="token punctuation">.</span>count <span class="token operator">=</span> score_dis<span class="token punctuation">.</span>pass<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">else</span>
                score_dis<span class="token punctuation">.</span>fail<span class="token punctuation">.</span>count <span class="token operator">=</span> score_dis<span class="token punctuation">.</span>fail<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">end</span>

            <span class="token keyword">local</span> student <span class="token operator">=</span> self<span class="token punctuation">.</span>students<span class="token punctuation">[</span>student_id<span class="token punctuation">]</span>
            <span class="token keyword">if</span> student <span class="token keyword">then</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span>student_list<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    student_id <span class="token operator">=</span> student_id<span class="token punctuation">,</span>
                    name <span class="token operator">=</span> student<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                    score <span class="token operator">=</span> score<span class="token punctuation">,</span>
                    grade <span class="token operator">=</span> score <span class="token operator">&gt;=</span> <span class="token number">90</span> <span class="token keyword">and</span> <span class="token string">"优秀"</span> <span class="token keyword">or</span>
                        score <span class="token operator">&gt;=</span> <span class="token number">80</span> <span class="token keyword">and</span> <span class="token string">"良好"</span> <span class="token keyword">or</span>
                        score <span class="token operator">&gt;=</span> <span class="token number">70</span> <span class="token keyword">and</span> <span class="token string">"中等"</span> <span class="token keyword">or</span>
                        score <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">and</span> <span class="token string">"及格"</span> <span class="token keyword">or</span> <span class="token string">"不及格"</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> report<span class="token punctuation">.</span>graded_count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
        report<span class="token punctuation">.</span>average_score <span class="token operator">=</span> total_score <span class="token operator">/</span> report<span class="token punctuation">.</span>graded_count
    <span class="token keyword">end</span>

    table<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span>student_list<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token keyword">return</span> a<span class="token punctuation">.</span>score <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>score
    <span class="token keyword">end</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> report
<span class="token keyword">end</span>

<span class="token keyword">function</span> GradeSystem<span class="token punctuation">:</span><span class="token function">find_top_students</span><span class="token punctuation">(</span>min_average<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>
    <span class="token keyword">local</span> qualified_students <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> student_id<span class="token punctuation">,</span> student <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>students<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> report <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token function">get_student_report</span><span class="token punctuation">(</span>student_id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> report <span class="token keyword">and</span> report<span class="token punctuation">.</span>weighted_average <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>min_average <span class="token keyword">or</span> <span class="token number">85</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
            table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>qualified_students<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                student_id <span class="token operator">=</span> student_id<span class="token punctuation">,</span>
                name <span class="token operator">=</span> student<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                major <span class="token operator">=</span> student<span class="token punctuation">.</span>major<span class="token punctuation">,</span>
                class <span class="token operator">=</span> student<span class="token punctuation">.</span>class<span class="token punctuation">,</span>
                weighted_average <span class="token operator">=</span> report<span class="token punctuation">.</span>weighted_average<span class="token punctuation">,</span>
                course_count <span class="token operator">=</span> <span class="token operator">#</span>report<span class="token punctuation">.</span>courses
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    table<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>qualified_students<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token keyword">return</span> a<span class="token punctuation">.</span>weighted_average <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>weighted_average
    <span class="token keyword">end</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> limit <span class="token keyword">and</span> limit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
        qualified_students <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function">unpack</span><span class="token punctuation">(</span>qualified_students<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> limit<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> qualified_students
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">initialize_test_data</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    <span class="token keyword">local</span> math_id <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_course</span><span class="token punctuation">(</span><span class="token string">"高等数学"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"张教授"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> english_id <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_course</span><span class="token punctuation">(</span><span class="token string">"大学英语"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"王老师"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> programming_id <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_course</span><span class="token punctuation">(</span><span class="token string">"程序设计"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"李教授"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> physics_id <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_course</span><span class="token punctuation">(</span><span class="token string">"大学物理"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"赵教授"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> history_id <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_course</span><span class="token punctuation">(</span><span class="token string">"中国近代史"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"刘老师"</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> stu1 <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token string">"计算机科学"</span><span class="token punctuation">,</span> <span class="token string">"计科2001"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> stu2 <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">,</span> <span class="token string">"软件工程"</span><span class="token punctuation">,</span> <span class="token string">"软工2001"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> stu3 <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">,</span> <span class="token string">"信息安全"</span><span class="token punctuation">,</span> <span class="token string">"信安2001"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> stu4 <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span><span class="token string">"赵六"</span><span class="token punctuation">,</span> <span class="token string">"计算机科学"</span><span class="token punctuation">,</span> <span class="token string">"计科2001"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> stu5 <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span><span class="token string">"钱七"</span><span class="token punctuation">,</span> <span class="token string">"软件工程"</span><span class="token punctuation">,</span> <span class="token string">"软工2001"</span><span class="token punctuation">)</span>

    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu1<span class="token punctuation">,</span> math_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu1<span class="token punctuation">,</span> english_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu1<span class="token punctuation">,</span> programming_id<span class="token punctuation">)</span>

    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu2<span class="token punctuation">,</span> math_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu2<span class="token punctuation">,</span> english_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu2<span class="token punctuation">,</span> physics_id<span class="token punctuation">)</span>

    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu3<span class="token punctuation">,</span> programming_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu3<span class="token punctuation">,</span> physics_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu3<span class="token punctuation">,</span> history_id<span class="token punctuation">)</span>

    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu4<span class="token punctuation">,</span> math_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu4<span class="token punctuation">,</span> programming_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu4<span class="token punctuation">,</span> physics_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu4<span class="token punctuation">,</span> history_id<span class="token punctuation">)</span>

    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu5<span class="token punctuation">,</span> english_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu5<span class="token punctuation">,</span> programming_id<span class="token punctuation">)</span>
    system<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>stu5<span class="token punctuation">,</span> history_id<span class="token punctuation">)</span>

    <span class="token keyword">local</span> scores <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>stu1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>math_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>english_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>programming_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">95</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>stu2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>math_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>english_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>physics_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">82</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>stu3<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>programming_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>physics_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">88</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>stu4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>math_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>programming_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>physics_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">92</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>stu5<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>english_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>programming_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">83</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">85</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> student_id<span class="token punctuation">,</span> course_scores <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>scores<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">for</span> course_id<span class="token punctuation">,</span> score <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>course_scores<span class="token punctuation">)</span> <span class="token keyword">do</span>
            system<span class="token punctuation">:</span><span class="token function">record_grade</span><span class="token punctuation">(</span>student_id<span class="token punctuation">,</span> course_id<span class="token punctuation">,</span> score<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"已添加 %d 名学生，%d 门课程"</span><span class="token punctuation">,</span>
        system<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_students<span class="token punctuation">,</span>
        system<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_courses<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">demonstrate_system_workflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">initialize_test_data</span><span class="token punctuation">(</span>GradeSystem<span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n查询学生成绩单"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> report<span class="token punctuation">,</span> err <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">get_student_report</span><span class="token punctuation">(</span><span class="token string">"STU0004"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> report <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"学生: %s (%s - %s)"</span><span class="token punctuation">,</span>
            report<span class="token punctuation">.</span>name<span class="token punctuation">,</span> report<span class="token punctuation">.</span>major<span class="token punctuation">,</span> report<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"加权平均分: %.2f, 简单平均分: %.2f"</span><span class="token punctuation">,</span>
            report<span class="token punctuation">.</span>weighted_average<span class="token punctuation">,</span> report<span class="token punctuation">.</span>total_average<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"各科成绩:"</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> course <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span>courses<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %s (%s): %s (学分: %d)"</span><span class="token punctuation">,</span>
                course<span class="token punctuation">.</span>name<span class="token punctuation">,</span> course<span class="token punctuation">.</span>teacher<span class="token punctuation">,</span>
                course<span class="token punctuation">.</span>score<span class="token punctuation">,</span> course<span class="token punctuation">.</span>credit<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"错误:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n查询课程统计"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> course_report<span class="token punctuation">,</span> course_err <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">get_course_report</span><span class="token punctuation">(</span><span class="token string">"COU0003"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> course_report <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"课程: %s (%s)"</span><span class="token punctuation">,</span>
            course_report<span class="token punctuation">.</span>name<span class="token punctuation">,</span> course_report<span class="token punctuation">.</span>teacher<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"选课人数: %d, 已录入成绩: %d"</span><span class="token punctuation">,</span>
            course_report<span class="token punctuation">.</span>enrolled_count<span class="token punctuation">,</span> course_report<span class="token punctuation">.</span>graded_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"平均分: %.2f"</span><span class="token punctuation">,</span> course_report<span class="token punctuation">.</span>average_score<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"成绩分布:"</span><span class="token punctuation">)</span>

        <span class="token keyword">local</span> distribution <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">for</span> _<span class="token punctuation">,</span> dis <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>course_report<span class="token punctuation">.</span>score_distribution<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">if</span> dis<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
                <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %s: %d人"</span><span class="token punctuation">,</span> dis<span class="token punctuation">.</span>name<span class="token punctuation">,</span> dis<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"成绩前3名:"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">#</span>course_report<span class="token punctuation">.</span>student_list<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">local</span> student <span class="token operator">=</span> course_report<span class="token punctuation">.</span>student_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %d. %s: %.1f (%s)"</span><span class="token punctuation">,</span>
                i<span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student<span class="token punctuation">.</span>score<span class="token punctuation">,</span> student<span class="token punctuation">.</span>grade<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">else</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"错误:"</span><span class="token punctuation">,</span> course_err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n查找成绩优异学生(平均分≥85)"</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> top_students <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">find_top_students</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"找到 %d 名符合条件的学生:"</span><span class="token punctuation">,</span> <span class="token operator">#</span>top_students<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> student <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>top_students<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %d. %s (%s) - 平均分: %.2f, 已修课程: %d门"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">,</span> student<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student<span class="token punctuation">.</span>major<span class="token punctuation">,</span>
            student<span class="token punctuation">.</span>weighted_average<span class="token punctuation">,</span> student<span class="token punctuation">.</span>course_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n模拟新操作流程"</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> new_student_id <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">add_student</span><span class="token punctuation">(</span><span class="token string">"孙八"</span><span class="token punctuation">,</span> <span class="token string">"人工智能"</span><span class="token punctuation">,</span> <span class="token string">"智能2001"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"添加新学生: %s"</span><span class="token punctuation">,</span> new_student_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> success<span class="token punctuation">,</span> msg <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">enroll_course</span><span class="token punctuation">(</span>new_student_id<span class="token punctuation">,</span> <span class="token string">"COU0001"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"选课结果: %s - %s"</span><span class="token punctuation">,</span> success <span class="token keyword">and</span> <span class="token string">"成功"</span> <span class="token keyword">or</span> <span class="token string">"失败"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

    success<span class="token punctuation">,</span> msg <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">record_grade</span><span class="token punctuation">(</span>new_student_id<span class="token punctuation">,</span> <span class="token string">"COU0001"</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"成绩录入: %s - %s"</span><span class="token punctuation">,</span> success <span class="token keyword">and</span> <span class="token string">"成功"</span> <span class="token keyword">or</span> <span class="token string">"失败"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> new_report<span class="token punctuation">,</span> new_err <span class="token operator">=</span> GradeSystem<span class="token punctuation">:</span><span class="token function">get_student_report</span><span class="token punctuation">(</span>new_student_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> new_report <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"新学生成绩单: 平均分 %.2f, 已修 %d 门课"</span><span class="token punctuation">,</span>
            new_report<span class="token punctuation">.</span>weighted_average<span class="token punctuation">,</span> <span class="token operator">#</span>new_report<span class="token punctuation">.</span>courses<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n系统统计信息"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"系统概况: %d 名学生, %d 门课程"</span><span class="token punctuation">,</span>
        GradeSystem<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_students<span class="token punctuation">,</span>
        GradeSystem<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>total_courses<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"各课程平均分:"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> course_id<span class="token punctuation">,</span> avg_score <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>GradeSystem<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>average_scores<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> course <span class="token operator">=</span> GradeSystem<span class="token punctuation">.</span>courses<span class="token punctuation">[</span>course_id<span class="token punctuation">]</span>
        <span class="token keyword">if</span> course <span class="token keyword">then</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"  %s: %.2f"</span><span class="token punctuation">,</span> course<span class="token punctuation">.</span>name<span class="token punctuation">,</span> avg_score<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> start_time <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">demonstrate_system_workflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> end_time <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"\n程序执行时间: %.3f 秒"</span><span class="token punctuation">,</span> end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 运行主程序</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="练习 2：模拟数据库操作错误处理" dir="auto" class="heading" id="练习_2：模拟数据库操作错误处理_0">练习 2：模拟数据库操作错误处理</h3></div><div class="el-p"><p dir="auto">（答案见<a data-href="第 1 节 - 语法/参考答案#练习 10.2：模拟数据库操作错误处理" href="第-1-节-语法/参考答案.html#练习 10.2：模拟数据库操作错误处理" class="internal-link" target="_self" rel="noopener nofollow">第 1 节 - 语法/参考答案 &gt; 练习 10.2：模拟数据库操作错误处理</a>）</p></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 模拟数据库操作的错误处理</span>
<span class="token comment">-- 使用示例：</span>
<span class="token comment">-- 使用数据库</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"数据库操作测试:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> db <span class="token operator">=</span> data_base<span class="token punctuation">.</span><span class="token function">new</span> <span class="token punctuation">{</span>
    host <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
    database <span class="token operator">=</span> <span class="token string">"mydb"</span><span class="token punctuation">,</span>
    username <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
    password <span class="token operator">=</span> <span class="token string">"secret"</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 包装数据库操作为安全操作</span>
<span class="token keyword">function</span> <span class="token function">safe_database_operation</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> operation_name<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n操作: "</span> <span class="token operator">..</span> operation_name<span class="token punctuation">)</span>

    <span class="token keyword">local</span> result<span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">:</span><span class="token function">safe_execute</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> result <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  成功"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token keyword">else</span>
        <span class="token keyword">local</span> _<span class="token punctuation">,</span> user_msg <span class="token operator">=</span> <span class="token function">handle_error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> operation_name<span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  失败: "</span> <span class="token operator">..</span> user_msg<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> err
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 测试各种操作</span>
<span class="token comment">-- 连接数据库</span>
<span class="token function">safe_database_operation</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"连接数据库"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>connect<span class="token punctuation">)</span>

<span class="token comment">-- 查询数据</span>
<span class="token keyword">local</span> users<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">safe_database_operation</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"查询用户"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE status = 'active'"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> users <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  查询到 "</span> <span class="token operator">..</span> <span class="token operator">#</span>users <span class="token operator">..</span> <span class="token string">" 个用户"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 测试插入重复数据</span>
<span class="token keyword">local</span> insert_result<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">safe_database_operation</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"插入用户"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO users (name, email) VALUES (?, ?)"</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token string">"测试用户"</span><span class="token punctuation">,</span> <span class="token string">"duplicate@example.com"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token comment">-- 测试事务</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n测试事务操作:"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> transaction_success<span class="token punctuation">,</span> transaction_err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    db<span class="token punctuation">:</span><span class="token function">begin_transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">-- 多个操作</span>
    db<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"UPDATE accounts SET balance = balance - 100 WHERE id = 1"</span><span class="token punctuation">)</span>
    db<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"UPDATE accounts SET balance = balance + 100 WHERE id = 2"</span><span class="token punctuation">)</span>

    db<span class="token punctuation">:</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  事务执行成功"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> transaction_success <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  事务失败: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>transaction_err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> db<span class="token punctuation">.</span>transaction_active <span class="token keyword">then</span>
        db<span class="token punctuation">:</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 断开连接</span>
<span class="token function">safe_database_operation</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"断开连接"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>disconnect<span class="token punctuation">)</span>
<span class="token comment">--[[ 输出
操作: 连接数据库
  连接数据库 localhost:3306...
[错误处理] 类型: NETWORK_ERROR (300)
          消息: 数据库连接失败
          详情: table: 00E5CEA0
          上下文: 连接数据库
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	test.lua:114: in function &lt;test.lua:104&gt;
	[C]: in function 'pcall'
	test.lua:213: in function 'safe_execute'
	test.lua:253: in function 'safe_database_operation'
	test.lua:267: in main chunk
	[C]: ?
  失败: 网络错误，请稍后重试

操作: 查询用户
  检测到连接问题，尝试重连...
  连接数据库 localhost:3306...
[错误处理] 类型: DATABASE_ERROR (200)
          消息: 数据库未连接
          上下文: 查询用户
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	test.lua:126: in function &lt;test.lua:124&gt;
	(tail call): ?
	[C]: in function 'pcall'
	test.lua:213: in function 'safe_execute'
	test.lua:253: in function 'safe_database_operation'
	test.lua:270: in main chunk
	[C]: ?
  失败: 系统错误，请联系技术支持

操作: 插入用户
  检测到连接问题，尝试重连...
  连接数据库 localhost:3306...
[错误处理] 类型: DATABASE_ERROR (200)
          消息: 数据库未连接
          上下文: 插入用户
          调用栈:

stack traceback:
	test.lua:51: in function 'throw_error'
	test.lua:126: in function &lt;test.lua:124&gt;
	(tail call): ?
	[C]: in function 'pcall'
	test.lua:213: in function 'safe_execute'
	test.lua:253: in function 'safe_database_operation'
	test.lua:279: in main chunk
	[C]: ?
  失败: 系统错误，请联系技术支持

测试事务操作:
  开始事务
  事务失败: table: 00E5CF68
  回滚事务

操作: 断开连接
  断开数据库连接
  成功
--]]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h2"><h2 data-heading="10.14 本章总结" dir="auto" class="heading" id="10.14_本章总结_0">10.14 本章总结</h2></div><div class="el-h3"><h3 data-heading="关键知识点回顾" dir="auto" class="heading" id="关键知识点回顾_0">关键知识点回顾</h3></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>断点的使用</strong>：</p>
<ul>
<li data-line="1" dir="auto">代码行左侧打断点</li>
<li data-line="2" dir="auto">使用控制栏控制程序运行</li>
<li data-line="3" dir="auto">使用调用堆栈查看函数调用链</li>
<li data-line="4" dir="auto">在调试控制台执行 Lua 代码</li>
<li data-line="5" dir="auto">使用监视变量快速查找指定变量</li>
</ul>
</li>
<li data-line="7" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>控制栏的使用</strong>：</p>
<ul>
<li data-line="8" dir="auto"><strong>继续</strong>：继续运行程序</li>
<li data-line="9" dir="auto"><strong>逐过程</strong>：运行下一行代码</li>
<li data-line="10" dir="auto"><strong>单步</strong>：运行下一行代码，包括函数内</li>
<li data-line="11" dir="auto"><strong>单步跳出</strong>：跳出当前代码块</li>
</ul>
</li>
<li data-line="13" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>特殊断点</strong>：</p>
<ul>
<li data-line="14" dir="auto"><strong>条件断点</strong>：判断通过触发，过滤无关触发</li>
<li data-line="15" dir="auto"><strong>命中断点</strong>：命中指定次数触发，适合递归与循环</li>
<li data-line="16" dir="auto"><strong>日志断点</strong>：不中断程序，打印临时日志</li>
<li data-line="17" dir="auto"><strong>等待断点</strong>：指定断点触发后触发</li>
</ul>
</li>
<li data-line="19" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>错误类型</strong>：</p>
<ul>
<li data-line="20" dir="auto"><strong>语法错误</strong>：代码块未闭合</li>
<li data-line="21" dir="auto"><strong>运行错误</strong>：索引 nil</li>
<li data-line="22" dir="auto"><strong>逻辑错误</strong>：结果错误</li>
<li data-line="23" dir="auto"><strong>资源错误</strong>：未找到文件、内存不足、栈溢出</li>
</ul>
</li>
<li data-line="25" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>错误处理</strong>：</p>
<ul>
<li data-line="26" dir="auto"><code>pcall</code>：保护调用，捕获错误</li>
<li data-line="27" dir="auto"><code>xpcall</code>：带错误处理函数的保护调用</li>
<li data-line="28" dir="auto"><code>error</code>：主动抛出错误</li>
<li data-line="29" dir="auto"><code>assert</code>：条件断言，失败时抛出错误</li>
</ul>
</li>
<li data-line="31" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>错误处理策略</strong>：</p>
<ul>
<li data-line="32" dir="auto">防御性编程</li>
<li data-line="33" dir="auto">错误恢复（重试、降级、隔离）</li>
<li data-line="34" dir="auto">错误日志和监控</li>
<li data-line="35" dir="auto">自定义错误类型</li>
</ul>
</li>
<li data-line="37" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>最佳实践</strong>：</p>
<ul>
<li data-line="38" dir="auto">输入验证</li>
<li data-line="39" dir="auto">资源清理</li>
<li data-line="40" dir="auto">错误传播</li>
<li data-line="41" dir="auto">用户友好错误消息</li>
</ul>
</li>
</ol></div><div class="el-h3"><h3 data-heading="错误处理模式" dir="auto" class="heading" id="错误处理模式_0">错误处理模式</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 模式 1：立即返回错误</span>
<span class="token keyword">function</span> <span class="token function">process_data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> data <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"数据不能为空"</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 处理数据...</span>
    <span class="token keyword">return</span> result
<span class="token keyword">end</span>

<span class="token comment">-- 模式 2：抛出异常</span>
<span class="token keyword">function</span> <span class="token function">validate_input</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> input <span class="token keyword">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"输入不能为空"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 验证通过...</span>
<span class="token keyword">end</span>

<span class="token comment">-- 模式 3：使用断言</span>
<span class="token keyword">function</span> <span class="token function">critical_operation</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>param <span class="token operator">~=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"参数不能为 nil"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 关键操作...</span>
<span class="token keyword">end</span>

<span class="token comment">-- 模式 4：错误转换</span>
<span class="token keyword">function</span> <span class="token function">api_wrapper</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
            <span class="token comment">-- 转换为 API 错误格式</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> error <span class="token operator">=</span> result<span class="token punctuation">}</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>success <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> data <span class="token operator">=</span> result<span class="token punctuation">}</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="常见错误处理陷阱" dir="auto" class="heading" id="常见错误处理陷阱_0">常见错误处理陷阱</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 陷阱 1：忽略错误</span>
<span class="token keyword">local</span> file <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"missing.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> content <span class="token operator">=</span> file<span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"*all"</span><span class="token punctuation">)</span>  <span class="token comment">-- 如果文件不存在，file 是 nil，这里会崩溃</span>
file<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 正确做法</span>
<span class="token keyword">local</span> file<span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"missing.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> file <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"错误: "</span> <span class="token operator">..</span> err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token keyword">end</span>

<span class="token comment">-- 陷阱 2：错误信息不明确</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">bad_error_handling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>some_operation<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"错误"</span><span class="token punctuation">)</span>  <span class="token comment">-- 不明确</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 正确做法</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">good_error_handling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>some_operation<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"操作失败: "</span> <span class="token operator">..</span> result<span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"调用栈: "</span> <span class="token operator">..</span> debug<span class="token punctuation">.</span><span class="token function">traceback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 陷阱 3：过度使用 pcall</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">overuse_pcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- 每个操作都用 pcall 包装，性能差且代码冗长</span>
    <span class="token keyword">local</span> s1<span class="token punctuation">,</span> r1 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>operation1<span class="token punctuation">)</span>
    <span class="token keyword">local</span> s2<span class="token punctuation">,</span> r2 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>operation2<span class="token punctuation">)</span>
    <span class="token keyword">local</span> s3<span class="token punctuation">,</span> r3 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>operation3<span class="token punctuation">)</span>
    <span class="token comment">-- ...</span>
<span class="token keyword">end</span>

<span class="token comment">-- 正确做法：在合适的层级处理错误</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">proper_error_handling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">operation1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">operation2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">operation3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token comment">-- 统一处理错误</span>
        <span class="token function">handle_error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 陷阱 4：资源泄漏</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">resource_leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> file <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span>
    file<span class="token punctuation">:</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"数据"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 忘记关闭文件！</span>
    <span class="token comment">-- 如果后面发生错误，文件永远不会关闭</span>
<span class="token keyword">end</span>

<span class="token comment">-- 正确做法：确保资源释放</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">proper_resource_handling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> file<span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> file <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> err
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        file<span class="token punctuation">:</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"数据"</span><span class="token punctuation">)</span>
        <span class="token comment">-- 其他可能失败的操作...</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
    
    <span class="token comment">-- 无论如何都关闭文件</span>
    file<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> result
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="性能考虑" dir="auto" class="heading" id="性能考虑_0">性能考虑</h3></div><div class="el-pre"><pre class="language-lua"><code data-line="0" class="language-lua is-loaded"><span class="token comment">-- 错误处理对性能的影响</span>

<span class="token comment">-- 1. pcall 有一定开销，避免在紧循环中使用</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">benchmark_pcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> start <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">-- 直接调用</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100000</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> _ <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">local</span> time1 <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
    
    start <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- 使用 pcall</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100000</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> success<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">local</span> time2 <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
    
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"直接调用: "</span> <span class="token operator">..</span> time1 <span class="token operator">..</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"pcall 调用: "</span> <span class="token operator">..</span> time2 <span class="token operator">..</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"开销: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>time2 <span class="token operator">-</span> time1<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 2. 在适当层级处理错误，避免不必要的包装</span>
<span class="token comment">-- 不好：每个函数都用 pcall</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">process_data_unsafe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> s1<span class="token punctuation">,</span> r1 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>validate<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> s2<span class="token punctuation">,</span> r2 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>transform<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> s3<span class="token punctuation">,</span> r3 <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>save<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token comment">-- 检查每个结果...</span>
<span class="token keyword">end</span>

<span class="token comment">-- 好：在高层统一处理</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">process_data_safe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token function">transform</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token function">save</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> success<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> err
    <span class="token keyword">end</span>
    
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3"><h3 data-heading="检查清单" dir="auto" class="heading" id="检查清单_0">检查清单</h3></div><div class="el-p"><p dir="auto">（点击勾选框勾选）<br>
完成本章后，你应该能够：</p></div><div class="el-ul"><ul class="contains-task-list">
<li data-line="0" data-task="" class="task-list-item" dir="auto"><input data-line="0" type="checkbox" class="task-list-item-checkbox">会使用各种调试功能</li>
<li data-line="1" data-task="" class="task-list-item" dir="auto"><input data-line="1" type="checkbox" class="task-list-item-checkbox">理解 Lua 的错误处理机制</li>
<li data-line="2" data-task="" class="task-list-item" dir="auto"><input data-line="2" type="checkbox" class="task-list-item-checkbox">使用 pcall 和 xpcall 保护代码执行</li>
<li data-line="3" data-task="" class="task-list-item" dir="auto"><input data-line="3" type="checkbox" class="task-list-item-checkbox">使用 error 和 assert 主动抛出错误</li>
<li data-line="4" data-task="" class="task-list-item" dir="auto"><input data-line="4" type="checkbox" class="task-list-item-checkbox">实现防御性编程策略</li>
<li data-line="5" data-task="" class="task-list-item" dir="auto"><input data-line="5" type="checkbox" class="task-list-item-checkbox">设计错误恢复机制</li>
<li data-line="6" data-task="" class="task-list-item" dir="auto"><input data-line="6" type="checkbox" class="task-list-item-checkbox">创建和使用自定义错误类型</li>
<li data-line="7" data-task="" class="task-list-item" dir="auto"><input data-line="7" type="checkbox" class="task-list-item-checkbox">记录和监控错误信息</li>
<li data-line="8" data-task="" class="task-list-item" dir="auto"><input data-line="8" type="checkbox" class="task-list-item-checkbox">避免常见的错误处理陷阱</li>
</ul></div><div class="el-h3"><h3 data-heading="思考题" dir="auto" class="heading" id="思考题_0">思考题</h3></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">为什么需要这么多调试功能？</li>
<li data-line="1" dir="auto">什么时候应该返回错误码，什么时候应该抛出异常？</li>
<li data-line="2" dir="auto">如何处理不可恢复的错误（如内存不足）？</li>
<li data-line="3" dir="auto">如何在分布式系统中传播和处理错误？</li>
<li data-line="4" dir="auto">错误处理策略如何影响代码的可读性和可维护性？</li>
<li data-line="5" dir="auto">如何平衡错误处理的完整性和性能开销？</li>
</ol></div><div class="el-h3"><h3 data-heading="拓展练习" dir="auto" class="heading" id="拓展练习_0">拓展练习</h3></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">实现一个完整的错误处理框架，支持错误分类，包括完整日志模块</li>
<li data-line="1" dir="auto">实现一个智能重试机制，根据错误类型动态调整重试策略</li>
</ol></div><div class="el-hr"><hr></div><div class="el-p"><p dir="auto"><strong>下一章预告</strong>：在第 11 章中，我们将学习迭代器和泛型 for。这是 Lua 中非常强大的特性，让我们能够以统一的方式遍历各种数据结构，包括自定义的数据结构。我们将学习如何创建和使用迭代器，理解泛型 for 的工作原理，以及如何实现各种复杂的遍历模式。</p></div><div class="el-p"><p dir="auto"><strong>学习建议</strong>：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">多使用断点，了解错误都会在什么情况下触发</li>
<li data-line="1" dir="auto">在实际编码中养成错误处理的习惯</li>
<li data-line="2" dir="auto">从简单错误处理开始，逐步实现更复杂的策略</li>
<li data-line="3" dir="auto">注意区分可恢复错误和不可恢复错误</li>
<li data-line="4" dir="auto">记录错误信息，便于调试和维护</li>
<li data-line="5" dir="auto">定期审查错误处理代码，确保其正确性和完整性</li>
</ol></div><div class="footer"><div class="data-bar"></div></div></div></div></div><div id="right-content" class="leaf" style="--sidebar-width: var(--sidebar-width-right);"><div id="right-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme-toggle-input" id=""><input class="theme-toggle-input" type="checkbox" id="theme-toggle-input"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="right-sidebar-content" class="leaf-content"><div id="outline" class=" tree-container"><div class="feature-header"><div class="feature-title">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item mod-collapsible" data-depth="1"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10._调试与错误处理_0" data-path="#10._调试与错误处理_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10. 调试与错误处理">10. 调试与错误处理</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.1_为什么要使用断点调试？_0" data-path="#10.1_为什么要使用断点调试？_0"><div class="tree-item-inner heading-link" heading-name="10.1 为什么要使用断点调试？">10.1 为什么要使用断点调试？</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.2_断点基础使用_0" data-path="#10.2_断点基础使用_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.2 断点基础使用">10.2 断点基础使用</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.1.2_控制栏说明_0" data-path="#10.1.2_控制栏说明_0"><div class="tree-item-inner heading-link" heading-name="10.1.2 控制栏说明">10.1.2 控制栏说明</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.1.3_调用堆栈_0" data-path="#10.1.3_调用堆栈_0"><div class="tree-item-inner heading-link" heading-name="10.1.3 调用堆栈">10.1.3 调用堆栈</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.3_调试控制台_0" data-path="#10.3_调试控制台_0"><div class="tree-item-inner heading-link" heading-name="10.3 调试控制台">10.3 调试控制台</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.4_监视变量_0" data-path="#10.4_监视变量_0"><div class="tree-item-inner heading-link" heading-name="10.4 监视变量">10.4 监视变量</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.5_特殊断点_0" data-path="#10.5_特殊断点_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.5 特殊断点">10.5 特殊断点</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.5.1_条件断点（表达式）_0" data-path="#10.5.1_条件断点（表达式）_0"><div class="tree-item-inner heading-link" heading-name="10.5.1 条件断点（表达式）">10.5.1 条件断点（表达式）</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.5.2_命中断点（命中次数）_0" data-path="#10.5.2_命中断点（命中次数）_0"><div class="tree-item-inner heading-link" heading-name="10.5.2 命中断点（命中次数）">10.5.2 命中断点（命中次数）</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.5.3_日志断点（记录点）_0" data-path="#10.5.3_日志断点（记录点）_0"><div class="tree-item-inner heading-link" heading-name="10.5.3 日志断点（记录点）">10.5.3 日志断点（记录点）</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.3.4_等待断点（触发的断点）_0" data-path="#10.3.4_等待断点（触发的断点）_0"><div class="tree-item-inner heading-link" heading-name="10.3.4 等待断点（触发的断点）">10.3.4 等待断点（触发的断点）</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.6_常见调试场景_0" data-path="#10.6_常见调试场景_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.6 常见调试场景">10.6 常见调试场景</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#1._循环调试_0" data-path="#1._循环调试_0"><div class="tree-item-inner heading-link" heading-name="1. 循环调试">1. 循环调试</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#2._递归函数调试_0" data-path="#2._递归函数调试_0"><div class="tree-item-inner heading-link" heading-name="2. 递归函数调试">2. 递归函数调试</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#3._辅助阅读代码_0" data-path="#3._辅助阅读代码_0"><div class="tree-item-inner heading-link" heading-name="3. 辅助阅读代码">3. 辅助阅读代码</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.7_为什么需要错误处理？_0" data-path="#10.7_为什么需要错误处理？_0"><div class="tree-item-inner heading-link" heading-name="10.7 为什么需要错误处理？">10.7 为什么需要错误处理？</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.8_Lua_的错误类型_0" data-path="#10.8_Lua_的错误类型_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.8 Lua 的错误类型">10.8 Lua 的错误类型</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#1._语法错误_0" data-path="#1._语法错误_0"><div class="tree-item-inner heading-link" heading-name="1. 语法错误">1. 语法错误</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#2._运行时错误_0" data-path="#2._运行时错误_0"><div class="tree-item-inner heading-link" heading-name="2. 运行时错误">2. 运行时错误</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#3._逻辑错误_0" data-path="#3._逻辑错误_0"><div class="tree-item-inner heading-link" heading-name="3. 逻辑错误">3. 逻辑错误</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#4._资源错误_0" data-path="#4._资源错误_0"><div class="tree-item-inner heading-link" heading-name="4. 资源错误">4. 资源错误</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.9_错误信息_0" data-path="#10.9_错误信息_0"><div class="tree-item-inner heading-link" heading-name="10.9 错误信息">10.9 错误信息</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.10_错误处理_0" data-path="#10.10_错误处理_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.10 错误处理">10.10 错误处理</div></a><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.10.1_pcall_-_保护调用_0" data-path="#10.10.1_pcall_-_保护调用_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.10.1 pcall - 保护调用">10.10.1 pcall - 保护调用</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#示例_0" data-path="#示例_0"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.10.2_xpcall_-_带错误处理的保护调用_0" data-path="#10.10.2_xpcall_-_带错误处理的保护调用_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.10.2 xpcall - 带错误处理的保护调用">10.10.2 xpcall - 带错误处理的保护调用</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#示例_1" data-path="#示例_1"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.10.3_error_-_抛出错误_0" data-path="#10.10.3_error_-_抛出错误_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.10.3 error - 抛出错误">10.10.3 error - 抛出错误</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#示例_2" data-path="#示例_2"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.10.4_assert_-_断言_0" data-path="#10.10.4_assert_-_断言_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.10.4 assert - 断言">10.10.4 assert - 断言</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#示例_3" data-path="#示例_3"><div class="tree-item-inner heading-link" heading-name="示例">示例</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.11_错误处理策略_0" data-path="#10.11_错误处理策略_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.11 错误处理策略">10.11 错误处理策略</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.11.1_防御性编程_0" data-path="#10.11.1_防御性编程_0"><div class="tree-item-inner heading-link" heading-name="10.11.1 防御性编程">10.11.1 防御性编程</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.11.2_错误恢复策略_0" data-path="#10.11.2_错误恢复策略_0"><div class="tree-item-inner heading-link" heading-name="10.11.2 错误恢复策略">10.11.2 错误恢复策略</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#10.12_自定义错误类型_0" data-path="#10.12_自定义错误类型_0"><div class="tree-item-inner heading-link" heading-name="10.12 自定义错误类型">10.12 自定义错误类型</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.13_练习_0" data-path="#10.13_练习_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.13 练习">10.13 练习</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#练习_1：使用断点阅读代码_0" data-path="#练习_1：使用断点阅读代码_0"><div class="tree-item-inner heading-link" heading-name="练习 1：使用断点阅读代码">练习 1：使用断点阅读代码</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#练习_2：模拟数据库操作错误处理_0" data-path="#练习_2：模拟数据库操作错误处理_0"><div class="tree-item-inner heading-link" heading-name="练习 2：模拟数据库操作错误处理">练习 2：模拟数据库操作错误处理</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable mod-collapsible" href="第-1-节-语法/10.-调试与错误处理.html#10.14_本章总结_0" data-path="#10.14_本章总结_0"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="10.14 本章总结">10.14 本章总结</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#关键知识点回顾_0" data-path="#关键知识点回顾_0"><div class="tree-item-inner heading-link" heading-name="关键知识点回顾">关键知识点回顾</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#错误处理模式_0" data-path="#错误处理模式_0"><div class="tree-item-inner heading-link" heading-name="错误处理模式">错误处理模式</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#常见错误处理陷阱_0" data-path="#常见错误处理陷阱_0"><div class="tree-item-inner heading-link" heading-name="常见错误处理陷阱">常见错误处理陷阱</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#性能考虑_0" data-path="#性能考虑_0"><div class="tree-item-inner heading-link" heading-name="性能考虑">性能考虑</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#检查清单_0" data-path="#检查清单_0"><div class="tree-item-inner heading-link" heading-name="检查清单">检查清单</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#思考题_0" data-path="#思考题_0"><div class="tree-item-inner heading-link" heading-name="思考题">思考题</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="第-1-节-语法/10.-调试与错误处理.html#拓展练习_0" data-path="#拓展练习_0"><div class="tree-item-inner heading-link" heading-name="拓展练习">拓展练习</div></a><div class="tree-item-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector("#right-sidebar"); rs.classList.toggle("is-collapsed", window.innerWidth < 768); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></div></div></body></html>